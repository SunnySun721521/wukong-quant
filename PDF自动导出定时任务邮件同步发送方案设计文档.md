# PDF自动导出定时任务邮件同步发送方案设计文档

## 1. 功能概述

在现有PDF自动导出定时任务执行时，同步触发邮件发送机制，将生成的PDF文件作为附件通过邮件发送给指定接收人。

**核心目标**：
- 自动化通知：PDF导出完成后自动发送邮件
- 批量分发：支持向多个接收人同时发送
- 状态跟踪：记录邮件发送状态和执行日志
- 灵活配置：提供友好的配置界面
- 安全可靠：确保邮件发送的安全性和可靠性

---

## 2. 功能实现逻辑流程

```
PDF定时任务触发 → 执行PDF导出 → 检查邮件配置 → 验证配置有效性
    ↓
准备邮件内容（主题、正文、PDF附件） → 建立SMTP连接 → 登录发送邮箱
    ↓
发送邮件给所有接收人 → 记录发送日志（成功/失败） → 任务完成
```

**邮件发送详细流程**：
```
加载邮件配置 → 创建邮件对象 → 添加PDF附件 → 建立SMTP连接
    ↓
登录SMTP服务器 → 发送邮件 → 记录发送结果
    ↓
成功：记录成功日志 | 失败：重试（最多3次）→ 记录失败日志
```

---

## 3. 新增配置项说明

### 3.1 配置文件结构

在现有的 `pdf_scheduler_config.json` 基础上，新增邮件发送相关配置项：

```json
{
  "scheduled_times": [
    {"hour": 12, "minute": 0}
  ],
  "email_config": {
    "enabled": false,
    "sender_email": "",
    "sender_auth_code": "",
    "recipients": [],
    "smtp_server": "smtp.qq.com",
    "smtp_port": 465,
    "use_ssl": true,
    "email_body_template": "simple",
    "retry_times": 3,
    "retry_interval": 5,
    "timeout": 30
  }
}
```

### 3.2 配置项说明

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | Boolean | `false` | 邮件发送功能总开关 |
| `sender_email` | String | `""` | 发送邮箱地址（QQ邮箱） |
| `sender_auth_code` | String | `""` | 邮箱授权码（非登录密码） |
| `recipients` | Array | `[]` | 接收邮箱地址列表 |
| `smtp_server` | String | `"smtp.qq.com"` | SMTP服务器地址 |
| `smtp_port` | Integer | `465` | SMTP服务器端口 |
| `use_ssl` | Boolean | `true` | 是否使用SSL加密 |
| `email_body_template` | String | `"simple"` | 邮件正文模板标识 |
| `retry_times` | Integer | `3` | 发送失败时的重试次数 |
| `retry_interval` | Integer | `5` | 重试间隔（秒） |
| `timeout` | Integer | `30` | SMTP连接和发送超时时间（秒） |

### 3.3 配置界面设计

在现有"PDF自动导出定时任务"管理页面中，新增"邮件发送配置"区域：

```
┌─────────────────────────────────────────────────────────────────┐
│  邮件发送配置                                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 邮件发送功能开关                                            │  │
│  │ [启用] [禁用]                                               │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │ 发送邮箱配置                                                │  │
│  │ 邮箱地址: [____________________] @qq.com                   │  │
│  │ 授权码:   [____________________] [显示/隐藏]               │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │ 接收邮箱配置                                                │  │
│  │ [接收人1: ______________@____.com] [删除]                   │  │
│  │ [接收人2: ______________@____.com] [删除]                   │  │
│  │ [添加接收人]                                                │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │ 邮件内容配置                                                │  │
│  │ 邮件模板: [简洁版 ▼] [预览]                                 │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │ 测试邮件发送                                                │  │
│  │ [发送测试邮件]                                              │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  邮件发送记录                                                    │
│  [发送日志列表]                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 邮件发送模块技术实现

### 4.1 技术选型

- **邮件发送库**：Python标准库 `smtplib` 和 `email`
- **邮件模板引擎**：Python字符串格式化

### 4.2 模块架构

```
EmailConfigManager - 邮件配置管理（加载、保存、验证）
    ↓
EmailTemplateEngine - 邮件模板管理（加载、渲染）
    ↓
EmailSender - 邮件发送（SMTP连接、发送、重试）
    ↓
EmailLogger - 发送日志记录（记录、查询、统计）
```

### 4.3 核心类设计

#### EmailConfigManager
- `load_config()`: 从配置文件加载邮件配置
- `save_config()`: 保存邮件配置到文件
- `validate_config()`: 验证配置的完整性和有效性
- `get_config()`: 获取当前邮件配置
- `update_config()`: 更新邮件配置

#### EmailTemplateEngine
- `render_subject()`: 渲染邮件主题
- `render_body()`: 渲染邮件正文
- `get_available_templates()`: 获取可用模板列表

#### EmailSender
- `send_email()`: 发送邮件（主方法）
- `connect_smtp()`: 建立SMTP连接
- `retry_send()`: 重试发送机制

#### EmailLogger
- `log_send_success()`: 记录发送成功日志
- `log_send_failure()`: 记录发送失败日志
- `get_send_logs()`: 获取发送日志

### 4.4 邮件模板

**简洁版模板**：
```
主题：每日操作计划 - {date}

正文：
尊敬的用户：

您好！

系统已为您生成今日操作计划，请查收附件中的PDF报告。

报告生成时间：{datetime}

如有任何问题，请联系系统管理员。

此致
敬礼！

股票交易管理系统
{datetime}
```

**详细版模板**：
```
主题：每日操作计划 - {date}

正文：
尊敬的用户：

您好！

系统已为您生成今日操作计划，请查收附件中的PDF报告。

【报告摘要】
生成时间：{datetime}
市场状态：{market_status}
当前仓位：{current_position}
总资产：{total_assets}

【报告内容】
1. 市场状态判断
2. 持仓分析
3. 调仓策略
4. 买入策略

【系统信息】
系统名称：股票交易管理系统
版本号：V1.0

如有任何问题，请联系系统管理员。

此致
敬礼！

股票交易管理系统
{datetime}
```

---

## 5. 与现有定时任务系统集成

### 5.1 集成方式

在PDF导出完成后，通过回调机制触发邮件发送。

**实现思路**：
1. 在 `PDFScheduler` 类中添加邮件发送回调函数
2. 在 `execute_pdf_export()` 方法中，PDF导出完成后调用邮件发送回调
3. 邮件发送失败不影响PDF导出任务的完成状态

### 5.2 配置集成

将邮件配置集成到现有的 `pdf_scheduler_config.json`，在现有配置文件中添加 `email_config` 节点。

### 5.3 日志集成

邮件发送日志独立存储在 `email_send_log.json`，在定时任务执行日志中添加邮件发送状态引用。

---

## 6. 异常处理机制

### 6.1 异常分类

| 异常类型 | 描述 | 处理方式 |
|----------|------|----------|
| 配置异常 | 配置文件不存在、格式错误、不完整、无效 | 使用默认配置或禁用邮件发送，记录日志 |
| 网络异常 | 连接超时、连接失败、网络中断、DNS解析失败 | 重试，超过重试次数后记录错误日志 |
| 认证异常 | 认证失败、授权码错误、账户异常 | 记录错误日志，提示检查授权码 |
| 发送异常 | 发送失败、附件过大、接收人无效、邮箱已满 | 重试或跳过该接收人，记录错误日志 |
| 文件异常 | 文件不存在、文件损坏、读取失败、权限不足 | 记录错误日志，不发送邮件 |

### 6.2 重试机制

**策略**：指数退避重试策略

**实现思路**：
1. 首次失败后，等待5秒重试
2. 第二次失败后，等待10秒重试
3. 第三次失败后，等待20秒重试
4. 超过最大重试次数后，记录错误日志

**可重试的异常**：网络连接超时、网络连接失败、SMTP服务器临时不可用、发送临时失败

**不可重试的异常**：配置错误、认证失败、文件不存在、接收人邮箱地址无效

### 6.3 错误日志设计

```json
{
  "log_id": "unique_log_id",
  "timestamp": "2026-02-09 12:00:00",
  "task_id": "task_id",
  "pdf_file": "/path/to/pdf/file.pdf",
  "status": "success|failure",
  "error_type": "error_type",
  "error_message": "error_message",
  "recipients": [
    {
      "email": "recipient1@example.com",
      "status": "success|failure",
      "error_message": "error_message"
    }
  ],
  "retry_count": 0,
  "retry_details": [
    {
      "retry_time": "2026-02-09 12:00:05",
      "error_type": "error_type",
      "error_message": "error_message"
    }
  ]
}
```

---

## 7. 安全性设计

### 7.1 数据安全

- **授权码加密存储**：使用加密算法存储授权码
- **敏感信息脱敏**：在日志中脱敏邮箱地址和授权码

### 7.2 传输安全

- **SSL/TLS加密**：默认启用SSL加密（端口465）
- **证书验证**：验证SMTP服务器证书

---

## 8. 实施计划

### 8.1 实施阶段

**第一阶段：基础功能开发**
- 邮件发送模块开发
- 配置管理功能开发
- 与定时任务系统集成
- 基础异常处理

**第二阶段：界面开发**
- 邮件配置界面开发
- 邮件发送记录界面开发
- 测试邮件发送功能

**第三阶段：测试和优化**
- 功能测试
- 问题修复和优化

### 8.2 风险评估

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| SMTP连接不稳定 | 高 | 中 | 实现重试机制 |
| 授权码泄露 | 高 | 低 | 加密存储，定期更换授权码 |
| 邮件发送失败影响用户体验 | 高 | 低 | 记录失败日志 |
| 邮件被误判为垃圾邮件 | 中 | 中 | 优化邮件内容 |

---

## 9. 总结

### 9.1 方案优势

1. **功能完整**：涵盖了邮件发送的所有核心功能
2. **架构清晰**：模块化设计，职责明确
3. **易于集成**：与现有系统无缝集成
4. **安全可靠**：多重安全机制，确保数据安全
5. **易于维护**：代码结构清晰，文档完善

### 9.2 关键技术点

1. **SMTP协议**：使用标准SMTP协议发送邮件
2. **SSL/TLS加密**：确保邮件传输安全
3. **重试机制**：提高发送成功率
4. **模板引擎**：灵活的邮件内容定制
5. **回调机制**：与现有系统集成
6. **异常处理**：完善的异常处理机制

---

## 附录

### 附录A：QQ邮箱授权码获取方法

1. 登录QQ邮箱网页版
2. 点击"设置" -> "账户"
3. 找到"POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务"
4. 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
5. 按照提示发送短信验证
6. 获取授权码（16位字符）

### 附录B：SMTP服务器配置参考

| 邮箱服务商 | SMTP服务器 | 端口 | 加密方式 |
|------------|------------|------|----------|
| 腾讯QQ邮箱 | smtp.qq.com | 465 | SSL |
| 网易163邮箱 | smtp.163.com | 465 | SSL |

### 附录C：常见问题解答

**Q1：为什么使用授权码而不是密码？**

A：授权码是专门用于第三方客户端的登录凭证，比直接使用密码更安全，且可以在邮箱设置中随时更换或撤销。

**Q2：邮件发送失败怎么办？**

A：首先检查网络连接和SMTP服务器配置，然后查看错误日志，根据错误信息进行相应的处理。如果是认证失败，请检查授权码是否正确。

**Q3：如何避免邮件被误判为垃圾邮件？**

A：优化邮件内容，避免使用敏感词汇，提供真实的发件人信息，建议接收人将发件人地址添加到白名单。

**Q4：支持发送给多少个接收人？**

A：理论上支持发送给任意数量的接收人，但建议单次发送不超过100个接收人，以免被邮箱服务商限制。

---

**文档结束**
