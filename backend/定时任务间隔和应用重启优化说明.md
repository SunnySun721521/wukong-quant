# 定时任务间隔和应用重启优化

## 修改内容

### 1. 定时任务配置优化

修改了 `pdf_scheduler_config.json`，确保定时任务间隔至少5分钟：

**修改前**：
- 17:30, 17:35, 17:40, 17:55 (间隔5分钟)
- 18:00, 18:15, 18:20, 18:25 (间隔5-15分钟)

**修改后**：
- 12:00
- 15:30
- 16:00
- 17:00
- 18:00
- 19:00 (间隔1小时)

### 2. PDF调度器优化

修改了 `pdf_scheduler.py`，添加了以下功能：

1. **任务执行状态跟踪**：
   - 添加 `self.task_executing` 标志，跟踪任务是否正在执行
   - 防止前一个任务未完成就开始新任务

2. **任务执行间隔检查**：
   - 添加 `last_task_execution_time` 记录上次任务执行时间
   - 确保任务间隔至少5分钟（300秒）
   - 如果间隔不足，跳过本次执行并输出日志

3. **任务完成状态重置**：
   - 在 `execute_pdf_export` 方法中添加 `finally` 块
   - 无论成功还是失败，都重置任务执行状态
   - 输出任务完成时间日志

### 3. 应用重启机制

创建了多个工具确保应用重启间隔至少30秒：

1. **restart_flask.py**：
   - 检查并停止所有现有Flask应用实例
   - 等待30秒确保进程完全停止
   - 使用单实例机制启动新应用

2. **restart_flask.bat**：
   - 批处理脚本，方便一键重启
   - 自动调用 `restart_flask.py`

3. **single_instance_flask.py**：
   - 使用锁文件机制确保只有一个实例
   - 跨平台兼容（Windows/Linux）
   - 自动清理锁文件

## 使用方法

### 重启Flask应用
```
cd d:\trae\备份悟空52220\backend
restart_flask.bat
```

或者直接运行：
```
cd d:\trae\备份悟空52220\backend
python restart_flask.py
```

### 启动单个Flask应用实例
```
cd d:\trae\备份悟空52220\backend
python single_instance_flask.py
```

## 优化效果

1. **防止任务重叠**：
   - 确保前一个PDF导出和邮件发送完全完成后才开始新任务
   - 避免资源竞争和邮件发送混乱

2. **合理的任务间隔**：
   - 定时任务间隔至少1小时，确保有足够时间完成
   - 避免短时间内多次触发相同任务

3. **应用重启保护**：
   - 确保应用重启间隔至少30秒
   - 防止快速重启导致的多实例问题

4. **单实例保证**：
   - 使用锁文件机制确保只有一个Flask应用实例
   - 自动清理旧实例和锁文件

## 注意事项

1. **定时任务执行时间**：
   - 新的定时任务时间：12:00, 15:30, 16:00, 17:00, 18:00, 19:00
   - 每个任务间隔1小时，确保充分完成时间

2. **应用重启**：
   - 使用提供的重启脚本，确保30秒间隔
   - 避免手动直接运行 `python app.py`

3. **日志监控**：
   - 调度器会输出详细的执行日志
   - 包括任务跳过原因（如间隔不足）

通过以上优化，系统现在能够确保：
- 只有一个Flask应用实例在运行
- 定时任务间隔至少5分钟
- 应用重启间隔至少30秒
- 前一个任务完全完成后再开始新任务