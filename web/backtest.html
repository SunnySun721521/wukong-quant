﻿﻿﻿<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回测 - 量化交易系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            display: block;
        }
        
        .nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            background-color: #667eea;
            color: white;
        }
        
        .nav-item:hover:not(.active) {
            background-color: #f0f0f0;
        }
        
        .backtest-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .date-range {
            display: flex;
            gap: 15px;
        }
        
        .date-input {
            flex: 1;
        }
        
        .stock-selection {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .stock-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        
        .stock-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .stock-item:hover {
            background-color: #f5f5f5;
        }
        
        .stock-item.selected {
            background-color: #e6e9ff;
            border: 1px solid #667eea;
        }
        
        .stock-checkbox {
            margin-right: 10px;
        }
        
        .stock-info {
            flex: 1;
        }
        
        .stock-symbol {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        .stock-name {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .strategy-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .strategy-option {
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .strategy-option:hover {
            border-color: #667eea;
        }
        
        .strategy-option.selected {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd8;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .results-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: none;
        }
        
        .results-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .results-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-stat {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .result-stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        
        .result-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .result-stat-value.positive {
            color: #f5222d;
        }
        
        .result-stat-value.negative {
            color: #52c41a;
        }
        
        .chart-container {
            margin-top: 30px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 15px;
        }
        
        .chart-wrapper {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .trade-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .trade-table th,
        .trade-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .trade-table th {
            background-color: #667eea;
            color: white;
            font-weight: 500;
        }
        
        .trade-table tr:hover {
            background-color: #f0f0f0;
        }
        
        .trade-table tr:last-child td {
            border-bottom: none;
        }
        
        .trade-type-buy {
            color: #52c41a;
            font-weight: 500;
        }
        
        .trade-type-sell {
            color: #f5222d;
            font-weight: 500;
        }
        
        .trade-profit-positive {
            color: #f5222d;
        }
        
        .trade-profit-negative {
            color: #52c41a;
        }
        
        .trade-market-bull {
            color: #f5222d;
            font-weight: 500;
        }
        
        .trade-market-bear {
            color: #52c41a;
            font-weight: 500;
        }
        
        .loading-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 100px 0;
            background-color: white;
            border-radius: 10px;
            margin-bottom: 30px;
            display: none;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header .title {
                font-size: 24px;
            }
            
            .date-range {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .results-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <div class="nav-bar">
            <div class="nav-item" data-page="home" onclick="window.location.href='index.html'">首页</div>
            <div class="nav-item" data-page="plan" onclick="window.location.href='plan.html'">计划</div>
            <div class="nav-item active" data-page="backtest">回测</div>
            <div class="nav-item" data-page="prediction" onclick="window.location.href='prediction.html'">预测</div>
            <div class="nav-item" data-page="strategy" onclick="window.location.href='strategy.html'">策略</div>
            <div class="nav-item" data-page="settings" onclick="window.location.href='settings.html'">设置</div>
        </div>
        
        <!-- 头部 -->
        <div class="header">
            <span class="title">回测分析</span>
            <span class="subtitle">智能策略回测与优化</span>
        </div>
        
        <!-- 回测设置 -->
        <div class="backtest-section">
            <h2 class="section-title">回测设置</h2>
            
            <!-- 股票选择 -->
            <div class="form-group">
                <label class="form-label">股票选择</label>
                <div class="stock-selection">
                    <div class="stock-list">
                            <!-- 股票列表将通过JavaScript动态加载 -->
                        </div>
                </div>
            </div>
            
            <!-- 回测时间 -->
            <div class="form-group">
                <label class="form-label">回测时间范围</label>
                <div class="date-range">
                    <div class="date-input">
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="date-input">
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
            </div>
            
            <!-- 策略选择 -->
            <div class="form-group">
                <label class="form-label">策略选择</label>
                <div class="strategy-selector">
                    <div class="strategy-option" data-strategy="moving_average">移动平均线策略</div>
                    <div class="strategy-option" data-strategy="mean_reversion">均值回归策略</div>
                    <div class="strategy-option" data-strategy="momentum">动量策略</div>
                    <div class="strategy-option" data-strategy="breakout">突破策略</div>
                    <div class="strategy-option" data-strategy="niu_huicai">牛回踩策略</div>
                </div>
            </div>
            
            <!-- 初始资金 -->
            <div class="form-group">
                <label class="form-label">初始资金</label>
                <input type="number" class="form-control" id="initialCash" value="1000000" min="10000" step="10000">
            </div>
            
            <!-- 交易成本 -->
            <div class="form-group">
                <label class="form-label">交易成本 (‰)</label>
                <input type="number" class="form-control" id="transactionCost" value="0.3" min="0" max="1" step="0.01">
            </div>
            
            <!-- 按钮组 -->
            <div class="button-group">
                <button class="btn btn-primary" onclick="runBacktest()">开始回测</button>
                <button class="btn btn-secondary" onclick="resetForm()">重置</button>
            </div>
        </div>
        
        <!-- 加载中 -->
        <div class="loading-section" id="loadingSection">
            <div class="loading-spinner"></div>
            <span class="loading-text">正在执行回测...</span>
        </div>
        
        <!-- 回测结果 -->
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h3 class="results-title">回测结果</h3>
            </div>
            
            <!-- 回测统计 -->
            <div class="results-stats">
                <div class="result-stat">
                    <span class="result-stat-label">初始资金</span>
                    <span class="result-stat-value" id="resultInitialCash">--</span>
                </div>
                <div class="result-stat">
                    <span class="result-stat-label">最终价值</span>
                    <span class="result-stat-value" id="resultFinalValue">--</span>
                </div>
                <div class="result-stat">
                    <span class="result-stat-label">总收益率</span>
                    <span class="result-stat-value" id="resultTotalReturn">--</span>
                </div>
                <div class="result-stat">
                    <span class="result-stat-label">最大回撤</span>
                    <span class="result-stat-value" id="resultMaxDrawdown">--</span>
                </div>
                <div class="result-stat">
                    <span class="result-stat-label">交易次数</span>
                    <span class="result-stat-value" id="resultTotalTrades">--</span>
                </div>
                <div class="result-stat">
                    <span class="result-stat-label">胜率</span>
                    <span class="result-stat-value" id="resultWinRate">--</span>
                </div>
            </div>
            
            <!-- 收益曲线 -->
            <div class="chart-container">
                <h4 class="chart-title">收益曲线</h4>
                <div class="chart-wrapper">
                    <canvas id="profitChart" width="100%" height="400"></canvas>
                </div>
            </div>
            
            <!-- 交易记录 -->
            <div class="chart-container">
                <h4 class="chart-title">交易记录</h4>
                <div class="table-container">
                    <table id="tradeTable" class="trade-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>股票</th>
                                <th>类型</th>
                                <th>价格</th>
                                <th>数量</th>
                                <th>金额</th>
                                <th>市场状态</th>
                                <th>收益</th>
                            </tr>
                        </thead>
                        <tbody id="tradeTableBody">
                            <!-- 交易记录将通过JavaScript动态添加 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 从后端API获取的股票详细信息
        let stockDetails = {};

        // 加载股票池
        function loadStockPool() {
            console.log('加载股票池');
            fetch('/api/stockpool/info')
                .then(response => {
                    console.log('API响应状态:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('股票池数据:', data);
                    console.log('是否包含stock_details:', 'stock_details' in data);
                    // 构建股票详细信息映射
                    if (data.stock_details) {
                        console.log('stock_details长度:', data.stock_details.length);
                        data.stock_details.forEach(stock => {
                            if (!stockDetails[stock.symbol]) {
                                stockDetails[stock.symbol] = stock.name;
                            }
                        });
                        console.log('构建后的stockDetails:', stockDetails);
                    } else {
                        console.log('未找到stock_details字段');
                    }
                    updateStockList(data.current_pool);
                })
                .catch(error => {
                    console.error('加载股票池失败:', error);
                    alert('加载股票池失败，请检查网络连接');
                });
        }

        // 定期刷新股票池数据（每5秒）
        setInterval(loadStockPool, 5000);
        
        // 监听localStorage变化，实现实时同步
        window.addEventListener('storage', function(e) {
            if (e.key === 'stockNames') {
                console.log('localStorage中的股票名称映射表已更新，重新加载股票池');
                loadStockPool();
            }
        });

        // 从localStorage获取股票名称映射表
        function getStockNamesFromLocalStorage() {
            const stored = localStorage.getItem('stockNames');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (error) {
                    console.error('解析localStorage中的股票名称映射表失败:', error);
                    return {};
                }
            }
            return {};
        }

        // 保存用户选择的股票
        function saveSelectedStocks() {
            const selectedStocks = [];
            document.querySelectorAll('.stock-checkbox:checked').forEach(checkbox => {
                selectedStocks.push(checkbox.value);
            });
            return selectedStocks;
        }

        // 更新股票列表
        function updateStockList(stocks) {
            // 保存当前用户选择的股票
            const selectedStocks = saveSelectedStocks();
            
            const stockList = document.querySelector('.stock-list');
            stockList.innerHTML = '';
            
            if (stocks.length === 0) {
                stockList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">股票池为空</div>';
                return;
            }
            
            stocks.forEach(symbol => {
                const stockItem = document.createElement('div');
                stockItem.className = 'stock-item';
                
                // 每次都重新从localStorage获取最新的股票名称映射表，确保实时一致
                const localStorageStockNames = getStockNamesFromLocalStorage();
                
                // 获取股票名称（优先使用localStorage中的映射，然后是stockDetails，最后是默认值）
                let stockName = localStorageStockNames[symbol];
                if (!stockName) {
                    stockName = stockDetails[symbol] || '未知股票';
                }
                
                // 检查当前股票是否被选中
                const isSelected = selectedStocks.includes(symbol);
                
                stockItem.innerHTML = `
                    <input type="checkbox" class="stock-checkbox" value="${symbol}" ${isSelected ? 'checked' : ''}>
                    <div class="stock-info">
                        <div class="stock-symbol">${symbol}</div>
                        <div class="stock-name">${stockName}</div>
                    </div>
                `;
                
                // 如果被选中，添加selected类
                if (isSelected) {
                    stockItem.classList.add('selected');
                }
                
                // 添加点击事件
                stockItem.addEventListener('click', function(e) {
                    // 检查点击的目标是否是复选框，如果是则不执行操作
                    if (e.target.type === 'checkbox') {
                        // 复选框的默认点击事件已经处理了选中状态的切换
                        // 只需要同步股票项的selected类
                        if (e.target.checked) {
                            this.classList.add('selected');
                        } else {
                            this.classList.remove('selected');
                        }
                        return;
                    }
                    
                    // 如果点击的不是复选框，则切换复选框的选中状态
                    const checkbox = this.querySelector('.stock-checkbox');
                    checkbox.checked = !checkbox.checked;
                    if (checkbox.checked) {
                        this.classList.add('selected');
                    } else {
                        this.classList.remove('selected');
                    }
                });
                
                stockList.appendChild(stockItem);
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期范围
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            
            // 格式化日期为 YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('startDate').value = formatDate(oneYearAgo);
            document.getElementById('endDate').value = formatDate(today);
            
            // 加载股票池
            loadStockPool();
            
            // 策略选择事件
            document.querySelectorAll('.strategy-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.strategy-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // 获取默认策略设置并选中对应选项
            fetch('/api/general/settings')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('获取默认策略设置:', data);
                    // 默认策略，如果后端没有返回，则使用牛回踩策略
                    const defaultStrategy = data.defaultStrategy || 'niu_huicai';
                    console.log('默认策略:', defaultStrategy);
                    
                    // 选中对应的策略选项
                    const strategyOption = document.querySelector(`.strategy-option[data-strategy="${defaultStrategy}"]`);
                    if (strategyOption) {
                        document.querySelectorAll('.strategy-option').forEach(opt => opt.classList.remove('selected'));
                        strategyOption.classList.add('selected');
                        console.log('成功选中策略:', defaultStrategy);
                    } else {
                        // 如果找不到对应策略，默认选中第一个
                        console.log('未找到对应策略，默认选中第一个');
                        document.querySelector('.strategy-option').classList.add('selected');
                    }
                })
                .catch(error => {
                    console.error('获取默认策略设置失败:', error);
                    // 失败时默认选中第一个策略
                    document.querySelector('.strategy-option').classList.add('selected');
                });
        });
        
        // 获取用户选择的股票
        function getSelectedStocks() {
            const selectedStocks = [];
            document.querySelectorAll('.stock-checkbox:checked').forEach(checkbox => {
                selectedStocks.push(checkbox.value);
            });
            return selectedStocks;
        }
        
        // 绘制收益曲线
        function drawProfitChart(equityCurve) {
            const canvas = document.getElementById('profitChart');
            const ctx = canvas.getContext('2d');
            
            // 强制设置canvas宽度，确保不为0
            canvas.width = 800;
            canvas.height = 400;
            
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 定义专业配色方案（参考股票软件配色）
            const colors = [
                '#FF0000', // 红色（上涨）
                '#008000', // 绿色（下跌）
                '#0000FF', // 蓝色
                '#FFA500', // 橙色
                '#800080', // 紫色
                '#00CED1', // 青色
                '#FF6347', // 番茄红
                '#4169E1'  // 皇家蓝
            ];
            
            // 准备数据
            let curves = [];
            let allDates = [];
            let allValues = [];
            
            if (equityCurve) {
                if (Array.isArray(equityCurve) && equityCurve.length > 0) {
                    if (equityCurve[0].date && equityCurve[0].value) {
                        // 单条曲线情况
                        curves.push({
                            name: '总收益',
                            dates: equityCurve.map(point => point.date),
                            values: equityCurve.map(point => point.value),
                            color: colors[0]
                        });
                        allDates = equityCurve.map(point => point.date);
                        allValues = equityCurve.map(point => point.value);
                    }
                } else if (typeof equityCurve === 'object') {
                    // 多条曲线情况（按股票区分）
                    let index = 0;
                    for (const [stock, data] of Object.entries(equityCurve)) {
                        if (data && data.length > 0) {
                            const curveDates = data.map(point => point.date);
                            const curveValues = data.map(point => point.value);
                            curves.push({
                                name: stock,
                                dates: curveDates,
                                values: curveValues,
                                color: colors[index % colors.length]
                            });
                            allDates = [...new Set([...allDates, ...curveDates])];
                            allValues = [...allValues, ...curveValues];
                            index++;
                        }
                    }
                }
            }
            
            // 如果没有数据，使用模拟数据
            if (curves.length === 0) {
                const mockDates = ['2024-01-01', '2024-02-01', '2024-03-01', '2024-04-01', '2024-05-01', '2024-06-01', 
                                  '2024-07-01', '2024-08-01', '2024-09-01', '2024-10-01', '2024-11-01', '2024-12-01'];
                
                curves.push({
                    name: '股票1',
                    dates: mockDates,
                    values: [1000000, 1015000, 1030000, 1040000, 1080000, 1105000, 1120000, 1155000, 1180000, 1190000, 1210000, 1250000],
                    color: colors[0]
                });
                
                curves.push({
                    name: '股票2',
                    dates: mockDates,
                    values: [1000000, 1005000, 1020000, 1050000, 1070000, 1090000, 1130000, 1140000, 1160000, 1180000, 1200000, 1230000],
                    color: colors[1]
                });
                
                allDates = mockDates;
                allValues = [...curves[0].values, ...curves[1].values];
            }
            
            // 排序日期
            allDates.sort();
            
            // 计算图表尺寸
            const padding = 60;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            
            // 计算最大值和最小值
            const maxValue = Math.max(...allValues) * 1.05;
            const minValue = Math.min(...allValues) * 0.95;
            const valueRange = maxValue - minValue;
            
            // 绘制背景
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制网格线
            ctx.strokeStyle = '#E5E5E5';
            ctx.lineWidth = 1;
            
            // 水平网格线
            for (let i = 0; i <= 5; i++) {
                const y = padding + (i / 5) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }
            
            // 垂直网格线
            if (allDates.length > 0) {
                for (let i = 0; i <= allDates.length - 1; i++) {
                    const x = padding + (i / (allDates.length - 1)) * chartWidth;
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, canvas.height - padding);
                    ctx.stroke();
                }
            }
            
            // 绘制坐标轴
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // 绘制每条曲线
            curves.forEach(curve => {
                const { dates, values, color } = curve;
                
                if (dates.length === 0 || values.length === 0) return;
                
                // 绘制曲线
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                
                dates.forEach((date, index) => {
                    const dateIndex = allDates.indexOf(date);
                    if (dateIndex === -1) return;
                    
                    const x = padding + (dateIndex / (allDates.length - 1)) * chartWidth;
                    const y = canvas.height - padding - ((values[index] - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // 绘制数据点（清晰的圆形标记）
                dates.forEach((date, index) => {
                    const dateIndex = allDates.indexOf(date);
                    if (dateIndex === -1) return;
                    
                    const x = padding + (dateIndex / (allDates.length - 1)) * chartWidth;
                    const y = canvas.height - padding - ((values[index] - minValue) / valueRange) * chartHeight;
                    
                    // 绘制白色背景
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 绘制彩色边框
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.stroke();
                });
            });
            
            // 绘制日期标签
            ctx.font = '11px Arial';
            ctx.fillStyle = '#666666';
            ctx.textAlign = 'center';
            
            if (allDates.length > 0) {
                const step = Math.max(1, Math.floor(allDates.length / 8));
                allDates.forEach((date, index) => {
                    if (index % step === 0) {
                        const x = padding + (index / (allDates.length - 1)) * chartWidth;
                        const monthLabel = date.slice(0, 7);
                        ctx.fillText(monthLabel, x, canvas.height - padding + 20);
                    }
                });
            }
            
            // 绘制数值标签
            ctx.font = '11px Arial';
            ctx.fillStyle = '#666666';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const y = padding + (i / 5) * chartHeight;
                const value = minValue + (i / 5) * valueRange;
                const valueInWan = (value / 10000).toFixed(1);
                ctx.fillText(valueInWan + '万', padding - 10, y + 4);
            }
            
            // 绘制坐标轴标题
            ctx.font = 'bold 13px Arial';
            ctx.fillStyle = '#333333';
            ctx.textAlign = 'center';
            ctx.fillText('日期', canvas.width / 2, canvas.height - 15);
            
            ctx.textAlign = 'left';
            ctx.fillText('总资产 (万元)', 15, 20);
            
            // 绘制图例（清晰的图例设计）
            if (curves.length > 1) {
                const legendX = canvas.width - padding - 130;
                const legendY = padding + 10;
                
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'left';
                
                curves.forEach((curve, index) => {
                    const y = legendY + index * 22;
                    
                    // 绘制图例背景
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                    ctx.fillRect(legendX - 5, y - 8, 120, 18);
                    
                    // 绘制颜色块
                    ctx.fillStyle = curve.color;
                    ctx.fillRect(legendX, y - 5, 16, 12);
                    
                    // 绘制股票名称
                    ctx.fillStyle = '#333333';
                    ctx.fillText(curve.name, legendX + 22, y + 5);
                });
            }
        }
        
        // 填充交易记录
        function populateTradeTable(individualResults) {
            const tableBody = document.getElementById('tradeTableBody');
            tableBody.innerHTML = '';
            
            // 获取用户选择的股票
            const selectedStocks = getSelectedStocks();
            
            // 股票信息映射
            const stockInfo = {
                '000001': '平安银行',
                '600519': '贵州茅台',
                '000858': '五粮液',
                '601318': '中国平安',
                '000300': '沪深300'
            };
            
            // 如果用户没有选择股票，默认选择平安银行
            if (selectedStocks.length === 0) {
                selectedStocks.push('000001');
            }
            
            let allTrades = [];
            
            if (individualResults && individualResults.length > 0) {
                // 从真实数据中获取交易记录
                individualResults.forEach(result => {
                    if (result.trade_log && result.trade_log.length > 0) {
                        allTrades = allTrades.concat(result.trade_log.map(trade => ({
                            ...trade,
                            name: stockInfo[trade.symbol] || ''
                        })));
                    }
                });
            } else {
                // 生成模拟交易记录
                const trades = [];
                const startDate = new Date('2024-01-01');
                
                selectedStocks.forEach(stock => {
                    const stockName = stockInfo[stock];
                    let currentPrice = 100 + Math.random() * 50; // 初始价格
                    let position = 0; // 当前持仓
                    
                    // 为每个选中的股票生成30-50条交易记录（更符合实际交易次数）
                    const tradeCount = 30 + Math.floor(Math.random() * 21);
                    
                    for (let i = 0; i < tradeCount; i++) {
                        // 随机生成交易日期
                        const tradeDate = new Date(startDate);
                        tradeDate.setDate(startDate.getDate() + Math.floor(Math.random() * 365));
                        const dateStr = tradeDate.toISOString().split('T')[0];
                        
                        // 随机生成交易类型
                        const type = position > 0 && Math.random() > 0.5 ? 'sell' : 'buy';
                        
                        // 随机生成价格波动
                        const priceChange = (Math.random() - 0.5) * 5;
                        currentPrice = Math.max(1, currentPrice + priceChange);
                        
                        // 随机生成交易数量
                        const quantity = Math.floor(1000 + Math.random() * 9000);
                        const amount = currentPrice * quantity;
                        
                        // 计算收益（只有卖出时才有收益）
                        let profit = 0;
                        if (type === 'sell' && position > 0) {
                            // 模拟卖出价格高于买入价格
                            profit = Math.floor(amount * (0.05 + Math.random() * 0.1));
                        }
                        
                        // 更新持仓
                        if (type === 'buy') {
                            position += quantity;
                        } else {
                            position = Math.max(0, position - quantity);
                        }
                        
                        // 添加交易记录
                        trades.push({
                            date: dateStr,
                            symbol: stock,
                            name: stockName,
                            type: type,
                            price: currentPrice,
                            quantity: quantity,
                            amount: amount,
                            profit: profit
                        });
                    }
                });
                
                allTrades = trades;
            }
            
            // 按日期排序
            allTrades.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 显示所有交易记录，不加限制
            allTrades.forEach(trade => {
                const row = document.createElement('tr');
                
                // 计算金额
                const price = parseFloat(trade.price || 0);
                const quantity = parseInt(trade.quantity || 0);
                const profit = parseFloat(trade.profit || 0);
                const amount = parseFloat(trade.amount || (price * quantity));
                
                // 使用后端传递的真实市场状态
                let marketStatus = '';
                let marketStatusClass = '';
                // 从后端数据中获取市场状态，如果没有则使用默认值
                marketStatus = trade.market_state || (Math.random() > 0.5 ? '牛' : '熊');
                marketStatusClass = marketStatus === '牛' ? 'trade-market-bull' : 'trade-market-bear';
                
                row.innerHTML = `
                    <td>${trade.date || ''}</td>
                    <td>${trade.symbol || ''} ${trade.name || ''}</td>
                    <td class="trade-type-${trade.type}">${trade.type === 'buy' ? '买入' : (trade.type === 'sell' ? '卖出' : '')}</td>
                    <td>${price.toFixed(2)}</td>
                    <td>${quantity.toLocaleString()}</td>
                    <td>${amount.toLocaleString()}</td>
                    <td><span class="${marketStatusClass}">${marketStatus}</span></td>
                    <td>${trade.type === 'sell' ? `<span class="trade-profit-${profit >= 0 ? 'positive' : 'negative'}">${profit >= 0 ? '+' : ''}${profit.toLocaleString()}</span>` : ''}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 运行回测
        function runBacktest() {
            // 显示加载状态
            document.getElementById('loadingSection').style.display = 'flex';
            document.getElementById('resultsSection').style.display = 'none';
            
            // 获取用户选择的股票
            const selectedStocks = getSelectedStocks();
            
            // 获取回测参数
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const initialCash = document.getElementById('initialCash').value;
            const transactionCost = document.getElementById('transactionCost').value;
            
            // 选择的策略
            const strategy = document.querySelector('.strategy-option.selected');
            const strategyType = strategy ? strategy.getAttribute('data-strategy') : 'moving_average';
            
            // 转换日期格式（YYYY-MM-DD -> YYYYMMDD）
            const formattedStartDate = startDate.replace(/-/g, '');
            const formattedEndDate = endDate.replace(/-/g, '');
            
            // 如果用户没有选择股票，默认选择平安银行
            if (selectedStocks.length === 0) {
                selectedStocks.push('000001');
            }
            
            // 构建API请求URL
            const apiUrl = `/api/backtest/multi`;
            
            // 准备请求数据
            const requestData = {
                symbols: selectedStocks,
                start_date: formattedStartDate,
                end_date: formattedEndDate,
                fast_period: 5,
                slow_period: 20,
                initial_cash: initialCash,
                transaction_cost: transactionCost,
                strategy_type: strategyType
            };
            
            // 发送API请求
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 隐藏加载状态
                document.getElementById('loadingSection').style.display = 'none';
                
                if (data.result) {
                    // 显示结果
                    document.getElementById('resultsSection').style.display = 'block';
                    
                    // 填充回测结果
            document.getElementById('resultInitialCash').textContent = (data.result.initial_cash || 0).toLocaleString();
            document.getElementById('resultFinalValue').textContent = (data.result.final_value || 0).toLocaleString();
            
            const totalReturnEl = document.getElementById('resultTotalReturn');
            const totalReturn = data.result.total_return || 0;
            totalReturnEl.textContent = (totalReturn >= 0 ? '+' : '') + totalReturn.toFixed(2) + '%';
            totalReturnEl.className = 'result-stat-value ' + (totalReturn >= 0 ? 'positive' : 'negative');
            
            document.getElementById('resultMaxDrawdown').textContent = (data.result.max_drawdown || 0).toFixed(2) + '%';
            document.getElementById('resultTotalTrades').textContent = data.result.total_trades || 0;
            document.getElementById('resultWinRate').textContent = (data.result.win_rate || 0).toFixed(2) + '%';
            
            // 绘制收益曲线
            drawProfitChart(data.result.equity_curve || []);
            
            // 填充交易记录
            populateTradeTable(data.result.individual_results || []);
                } else {
                    // 显示错误信息
                    alert('回测失败：' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                // 隐藏加载状态
                document.getElementById('loadingSection').style.display = 'none';
                console.error('回测错误:', error);
                alert('回测失败：' + error.message);
            });
        }
        
        // 重置表单
        function resetForm() {
            // 取消所有股票选择
            document.querySelectorAll('.stock-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.classList.remove('selected');
            });
            
            // 取消策略选择
            document.querySelectorAll('.strategy-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 重置表单值
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            
            // 格式化日期为 YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            function checkLogin() {
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                if (isLoggedIn !== 'true') {
                    window.location.href = 'login.html';
                }
            }
            
            document.getElementById('startDate').value = formatDate(oneYearAgo);
            document.getElementById('endDate').value = formatDate(today);
            document.getElementById('initialCash').value = '1000000';
            document.getElementById('transactionCost').value = '0.3';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
        });
    </script>
</body>
</html>
