<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›æµ‹ - é‡åŒ–äº¤æ˜“ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            display: block;
        }
        
        .nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            background-color: #667eea;
            color: white;
        }
        
        .nav-item:hover:not(.active) {
            background-color: #f0f0f0;
        }
        
        .backtest-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .date-range {
            display: flex;
            gap: 15px;
        }
        
        .date-input {
            flex: 1;
        }
        
        .stock-selection {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .stock-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        
        .stock-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .stock-item:hover {
            background-color: #f5f5f5;
        }
        
        .stock-item.selected {
            background-color: #e6e9ff;
            border: 1px solid #667eea;
        }
        
        .stock-checkbox {
            margin-right: 10px;
        }
        
        .stock-info {
            flex: 1;
        }
        
        .stock-symbol {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        .stock-name {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .strategy-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .strategy-option {
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .strategy-option:hover {
            border-color: #667eea;
        }
        
        .strategy-option.selected {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd8;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .results-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: none;
        }
        
        .results-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .results-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-stat {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .result-stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        
        .result-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .result-stat-value.positive {
            color: #f5222d;
        }
        
        .result-stat-value.negative {
            color: #52c41a;
        }
        
        .chart-container {
            margin-top: 30px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 15px;
        }
        
        .chart-wrapper {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .trade-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .trade-table th,
        .trade-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .trade-table th {
            background-color: #667eea;
            color: white;
            font-weight: 500;
        }
        
        .trade-table tr:hover {
            background-color: #f0f0f0;
        }
        
        .trade-table tr:last-child td {
            border-bottom: none;
        }
        
        .trade-type-buy {
            color: #52c41a;
            font-weight: 500;
        }
        
        .trade-type-sell {
            color: #f5222d;
            font-weight: 500;
        }
        
        .trade-profit-positive {
            color: #f5222d;
        }
        
        .trade-profit-negative {
            color: #52c41a;
        }
        
        .trade-market-bull {
            color: #f5222d;
            font-weight: 500;
        }
        
        .trade-market-bear {
            color: #52c41a;
            font-weight: 500;
        }
        
        .loading-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 100px 0;
            background-color: white;
            border-radius: 10px;
            margin-bottom: 30px;
            display: none;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header .title {
                font-size: 24px;
            }
            
            .date-range {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .results-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¯¼èˆªæ ?-->
        <div class="nav-bar">
            <div class="nav-item" data-page="home" onclick="window.location.href='index.html'">é¦–é¡µ</div>
            <div class="nav-item" data-page="plan" onclick="window.location.href='plan.html'">è®¡åˆ’</div>
            <div class="nav-item active" data-page="backtest">å›æµ‹</div>
            <div class="nav-item" data-page="prediction" onclick="window.location.href='prediction.html'">é¢„æµ‹</div>
            <div class="nav-item" data-page="strategy" onclick="window.location.href='strategy.html'">ç­–ç•¥</div>
            <div class="nav-item" data-page="settings" onclick="window.location.href='settings.html'">è®¾ç½®</div>
        </div>
        
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <span class="title">å›æµ‹åˆ†æ</span>
            <span class="subtitle">æ™ºèƒ½ç­–ç•¥å›æµ‹ä¸ä¼˜åŒ?/span>
        </div>
        
        <!-- å›æµ‹è®¾ç½® -->
        <div class="backtest-section">
            <h2 class="section-title">å›æµ‹è®¾ç½®</h2>
            
            <!-- è‚¡ç¥¨é€‰æ‹© -->
            <div class="form-group">
                <label class="form-label">è‚¡ç¥¨é€‰æ‹©</label>
                <div class="stock-selection">
                    <div class="stock-list">
                            <!-- è‚¡ç¥¨åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½?-->
                        </div>
                </div>
            </div>
            
            <!-- å›æµ‹æ—¶é—´ -->
            <div class="form-group">
                <label class="form-label">å›æµ‹æ—¶é—´èŒƒå›´</label>
                <div class="date-range">
                    <div class="date-input">
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="date-input">
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
            </div>
            
            <!-- ç­–ç•¥é€‰æ‹© -->
            <div class="form-group">
                <label class="form-label">ç­–ç•¥é€‰æ‹©</label>
                <div class="strategy-selector">
                    <div class="strategy-option" data-strategy="moving_average">ç§»åŠ¨å¹³å‡çº¿ç­–ç•?/div>
                    <div class="strategy-option" data-strategy="mean_reversion">å‡å€¼å›å½’ç­–ç•?/div>
                    <div class="strategy-option" data-strategy="momentum">åŠ¨é‡ç­–ç•¥</div>
                    <div class="strategy-option" data-strategy="breakout">çªç ´ç­–ç•¥</div>
                    <div class="strategy-option" data-strategy="niu_huicai">ç‰›å›è¸©ç­–ç•?/div>
                </div>
            </div>
            
            <!-- åˆå§‹èµ„é‡‘ -->
            <div class="form-group">
                <label class="form-label">åˆå§‹èµ„é‡‘</label>
                <input type="number" class="form-control" id="initialCash" value="1000000" min="10000" step="10000">
            </div>
            
            <!-- äº¤æ˜“æˆæœ¬ -->
            <div class="form-group">
                <label class="form-label">äº¤æ˜“æˆæœ¬ (â€?</label>
                <input type="number" class="form-control" id="transactionCost" value="0.3" min="0" max="1" step="0.01">
            </div>
            
            <!-- æŒ‰é’®ç»?-->
            <div class="button-group">
                <button class="btn btn-primary" onclick="runBacktest()">å¼€å§‹å›æµ?/button>
                <button class="btn btn-secondary" onclick="resetForm()">é‡ç½®</button>
            </div>
        </div>
        
        <!-- åŠ è½½ä¸?-->
        <div class="loading-section" id="loadingSection">
            <div class="loading-spinner"></div>
            <span class="loading-text">æ­£åœ¨æ‰§è¡Œå›æµ‹...</span>
        </div>
        
        <!-- å›æµ‹ç»“æœ -->
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h3 class="results-title">å›æµ‹ç»“æœ</h3>
            </div>
            
            <!-- å›æµ‹ç»Ÿè®¡ -->
            <div class="results-stats">
                <div class="result-stat">
                    <span class="result-stat-label">åˆå§‹èµ„é‡‘</span>
                    <span class="result-stat-value" id="resultInitialCash">--</span>
                </div>
                <div class="result-stat">
                    <span class="result-stat-label">æœ€ç»ˆä»·å€?/span>
                    <span class="result-stat-value" id="resultFinalValue">--</span>
                </div>
                <div class="result-stat">
                    <span class="result-stat-label">æ€»æ”¶ç›Šç‡</span>
                    <span class="result-stat-value" id="resultTotalReturn">--</span>
                </div>
                <div class="result-stat">
                    <span class="result-stat-label">æœ€å¤§å›æ’?/span>
                    <span class="result-stat-value" id="resultMaxDrawdown">--</span>
                </div>
                <div class="result-stat">
                    <span class="result-stat-label">äº¤æ˜“æ¬¡æ•°</span>
                    <span class="result-stat-value" id="resultTotalTrades">--</span>
                </div>
                <div class="result-stat">
                    <span class="result-stat-label">èƒœç‡</span>
                    <span class="result-stat-value" id="resultWinRate">--</span>
                </div>
            </div>
            
            <!-- æ”¶ç›Šæ›²çº¿ -->
            <div class="chart-container">
                <h4 class="chart-title">æ”¶ç›Šæ›²çº¿</h4>
                <div class="chart-wrapper">
                    <canvas id="profitChart" width="100%" height="400"></canvas>
                </div>
            </div>
            
            <!-- äº¤æ˜“è®°å½• -->
            <div class="chart-container">
                <h4 class="chart-title">äº¤æ˜“è®°å½•</h4>
                <div class="table-container">
                    <table id="tradeTable" class="trade-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>è‚¡ç¥¨</th>
                                <th>ç±»å‹</th>
                                <th>ä»·æ ¼</th>
                                <th>æ•°é‡</th>
                                <th>é‡‘é¢</th>
                                <th>å¸‚åœºçŠ¶æ€?/th>
                                <th>æ”¶ç›Š</th>
                            </tr>
                        </thead>
                        <tbody id="tradeTableBody">
                            <!-- äº¤æ˜“è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ?-->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ä»åç«¯APIè·å–çš„è‚¡ç¥¨è¯¦ç»†ä¿¡æ?        let stockDetails = {};

        // åŠ è½½è‚¡ç¥¨æ±?        function loadStockPool() {
            console.log('åŠ è½½è‚¡ç¥¨æ±?);
            fetch('/api/stockpool/info')
                .then(response => {
                    console.log('APIå“åº”çŠ¶æ€?', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('è‚¡ç¥¨æ± æ•°æ?', data);
                    console.log('æ˜¯å¦åŒ…å«stock_details:', 'stock_details' in data);
                    // æ„å»ºè‚¡ç¥¨è¯¦ç»†ä¿¡æ¯æ˜ å°„
                    if (data.stock_details) {
                        console.log('stock_detailsé•¿åº¦:', data.stock_details.length);
                        data.stock_details.forEach(stock => {
                            if (!stockDetails[stock.symbol]) {
                                stockDetails[stock.symbol] = stock.name;
                            }
                        });
                        console.log('æ„å»ºåçš„stockDetails:', stockDetails);
                    } else {
                        console.log('æœªæ‰¾åˆ°stock_detailså­—æ®µ');
                    }
                    updateStockList(data.current_pool);
                })
                .catch(error => {
                    console.error('åŠ è½½è‚¡ç¥¨æ± å¤±è´?', error);
                    alert('åŠ è½½è‚¡ç¥¨æ± å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                });
        }

        // å®šæœŸåˆ·æ–°è‚¡ç¥¨æ± æ•°æ®ï¼ˆæ¯?ç§’ï¼‰
        setInterval(loadStockPool, 5000);
        
        // ç›‘å¬localStorageå˜åŒ–ï¼Œå®ç°å®æ—¶åŒæ­?        window.addEventListener('storage', function(e) {
            if (e.key === 'stockNames') {
                console.log('localStorageä¸­çš„è‚¡ç¥¨åç§°æ˜ å°„è¡¨å·²æ›´æ–°ï¼Œé‡æ–°åŠ è½½è‚¡ç¥¨æ± ');
                loadStockPool();
            }
        });

        // ä»localStorageè·å–è‚¡ç¥¨åç§°æ˜ å°„è¡?        function getStockNamesFromLocalStorage() {
            const stored = localStorage.getItem('stockNames');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (error) {
                    console.error('è§£ælocalStorageä¸­çš„è‚¡ç¥¨åç§°æ˜ å°„è¡¨å¤±è´?', error);
                    return {};
                }
            }
            return {};
        }

        // ä¿å­˜ç”¨æˆ·é€‰æ‹©çš„è‚¡ç¥?        function saveSelectedStocks() {
            const selectedStocks = [];
            document.querySelectorAll('.stock-checkbox:checked').forEach(checkbox => {
                selectedStocks.push(checkbox.value);
            });
            return selectedStocks;
        }

        // æ›´æ–°è‚¡ç¥¨åˆ—è¡¨
        function updateStockList(stocks) {
            // ä¿å­˜å½“å‰ç”¨æˆ·é€‰æ‹©çš„è‚¡ç¥?            const selectedStocks = saveSelectedStocks();
            
            const stockList = document.querySelector('.stock-list');
            stockList.innerHTML = '';
            
            if (stocks.length === 0) {
                stockList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">è‚¡ç¥¨æ± ä¸ºç©?/div>';
                return;
            }
            
            stocks.forEach(symbol => {
                const stockItem = document.createElement('div');
                stockItem.className = 'stock-item';
                
                // æ¯æ¬¡éƒ½é‡æ–°ä»localStorageè·å–æœ€æ–°çš„è‚¡ç¥¨åç§°æ˜ å°„è¡¨ï¼Œç¡®ä¿å®æ—¶ä¸€è‡?                const localStorageStockNames = getStockNamesFromLocalStorage();
                
                // è·å–è‚¡ç¥¨åç§°ï¼ˆä¼˜å…ˆä½¿ç”¨localStorageä¸­çš„æ˜ å°„ï¼Œç„¶åæ˜¯stockDetailsï¼Œæœ€åæ˜¯é»˜è®¤å€¼ï¼‰
                let stockName = localStorageStockNames[symbol];
                if (!stockName) {
                    stockName = stockDetails[symbol] || 'æœªçŸ¥è‚¡ç¥¨';
                }
                
                // æ£€æŸ¥å½“å‰è‚¡ç¥¨æ˜¯å¦è¢«é€‰ä¸­
                const isSelected = selectedStocks.includes(symbol);
                
                stockItem.innerHTML = `
                    <input type="checkbox" class="stock-checkbox" value="${symbol}" ${isSelected ? 'checked' : ''}>
                    <div class="stock-info">
                        <div class="stock-symbol">${symbol}</div>
                        <div class="stock-name">${stockName}</div>
                    </div>
                `;
                
                // å¦‚æœè¢«é€‰ä¸­ï¼Œæ·»åŠ selectedç±?                if (isSelected) {
                    stockItem.classList.add('selected');
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                stockItem.addEventListener('click', function(e) {
                    // æ£€æŸ¥ç‚¹å‡»çš„ç›®æ ‡æ˜¯å¦æ˜¯å¤é€‰æ¡†ï¼Œå¦‚æœæ˜¯åˆ™ä¸æ‰§è¡Œæ“ä½œ
                    if (e.target.type === 'checkbox') {
                        // å¤é€‰æ¡†çš„é»˜è®¤ç‚¹å‡»äº‹ä»¶å·²ç»å¤„ç†äº†é€‰ä¸­çŠ¶æ€çš„åˆ‡æ¢
                        // åªéœ€è¦åŒæ­¥è‚¡ç¥¨é¡¹çš„selectedç±?                        if (e.target.checked) {
                            this.classList.add('selected');
                        } else {
                            this.classList.remove('selected');
                        }
                        return;
                    }
                    
                    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯å¤é€‰æ¡†ï¼Œåˆ™åˆ‡æ¢å¤é€‰æ¡†çš„é€‰ä¸­çŠ¶æ€?                    const checkbox = this.querySelector('.stock-checkbox');
                    checkbox.checked = !checkbox.checked;
                    if (checkbox.checked) {
                        this.classList.add('selected');
                    } else {
                        this.classList.remove('selected');
                    }
                });
                
                stockList.appendChild(stockItem);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            
            // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('startDate').value = formatDate(oneYearAgo);
            document.getElementById('endDate').value = formatDate(today);
            
            // åŠ è½½è‚¡ç¥¨æ±?            loadStockPool();
            
            // ç­–ç•¥é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.strategy-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.strategy-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // è·å–é»˜è®¤ç­–ç•¥è®¾ç½®å¹¶é€‰ä¸­å¯¹åº”é€‰é¡¹
            fetch('/api/general/settings')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('è·å–é»˜è®¤ç­–ç•¥è®¾ç½®:', data);
                    // é»˜è®¤ç­–ç•¥ï¼Œå¦‚æœåç«¯æ²¡æœ‰è¿”å›ï¼Œåˆ™ä½¿ç”¨ç‰›å›è¸©ç­–ç•¥
                    const defaultStrategy = data.defaultStrategy || 'niu_huicai';
                    console.log('é»˜è®¤ç­–ç•¥:', defaultStrategy);
                    
                    // é€‰ä¸­å¯¹åº”çš„ç­–ç•¥é€‰é¡¹
                    const strategyOption = document.querySelector(`.strategy-option[data-strategy="${defaultStrategy}"]`);
                    if (strategyOption) {
                        document.querySelectorAll('.strategy-option').forEach(opt => opt.classList.remove('selected'));
                        strategyOption.classList.add('selected');
                        console.log('æˆåŠŸé€‰ä¸­ç­–ç•¥:', defaultStrategy);
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”ç­–ç•¥ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸?                        console.log('æœªæ‰¾åˆ°å¯¹åº”ç­–ç•¥ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸?);
                        document.querySelector('.strategy-option').classList.add('selected');
                    }
                })
                .catch(error => {
                    console.error('è·å–é»˜è®¤ç­–ç•¥è®¾ç½®å¤±è´¥:', error);
                    // å¤±è´¥æ—¶é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªç­–ç•?                    document.querySelector('.strategy-option').classList.add('selected');
                });
        });
        
        // è·å–ç”¨æˆ·é€‰æ‹©çš„è‚¡ç¥?        function getSelectedStocks() {
            const selectedStocks = [];
            document.querySelectorAll('.stock-checkbox:checked').forEach(checkbox => {
                selectedStocks.push(checkbox.value);
            });
            return selectedStocks;
        }
        
        // ç»˜åˆ¶æ”¶ç›Šæ›²çº¿
        function drawProfitChart(equityCurve) {
            const canvas = document.getElementById('profitChart');
            const ctx = canvas.getContext('2d');
            
            // å¼ºåˆ¶è®¾ç½®canvaså®½åº¦ï¼Œç¡®ä¿ä¸ä¸?
            canvas.width = 800;
            canvas.height = 400;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // å®šä¹‰ä¸“ä¸šé…è‰²æ–¹æ¡ˆï¼ˆå‚è€ƒè‚¡ç¥¨è½¯ä»¶é…è‰²ï¼‰
            const colors = [
                '#FF0000', // çº¢è‰²ï¼ˆä¸Šæ¶¨ï¼‰
                '#008000', // ç»¿è‰²ï¼ˆä¸‹è·Œï¼‰
                '#0000FF', // è“è‰²
                '#FFA500', // æ©™è‰²
                '#800080', // ç´«è‰²
                '#00CED1', // é’è‰²
                '#FF6347', // ç•ªèŒ„çº?                '#4169E1'  // çš‡å®¶è“?            ];
            
            // å‡†å¤‡æ•°æ®
            let curves = [];
            let allDates = [];
            let allValues = [];
            
            if (equityCurve) {
                if (Array.isArray(equityCurve) && equityCurve.length > 0) {
                    if (equityCurve[0].date && equityCurve[0].value) {
                        // å•æ¡æ›²çº¿æƒ…å†µ
                        curves.push({
                            name: 'æ€»æ”¶ç›?,
                            dates: equityCurve.map(point => point.date),
                            values: equityCurve.map(point => point.value),
                            color: colors[0]
                        });
                        allDates = equityCurve.map(point => point.date);
                        allValues = equityCurve.map(point => point.value);
                    }
                } else if (typeof equityCurve === 'object') {
                    // å¤šæ¡æ›²çº¿æƒ…å†µï¼ˆæŒ‰è‚¡ç¥¨åŒºåˆ†ï¼?                    let index = 0;
                    for (const [stock, data] of Object.entries(equityCurve)) {
                        if (data && data.length > 0) {
                            const curveDates = data.map(point => point.date);
                            const curveValues = data.map(point => point.value);
                            curves.push({
                                name: stock,
                                dates: curveDates,
                                values: curveValues,
                                color: colors[index % colors.length]
                            });
                            allDates = [...new Set([...allDates, ...curveDates])];
                            allValues = [...allValues, ...curveValues];
                            index++;
                        }
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ?            if (curves.length === 0) {
                const mockDates = ['2024-01-01', '2024-02-01', '2024-03-01', '2024-04-01', '2024-05-01', '2024-06-01', 
                                  '2024-07-01', '2024-08-01', '2024-09-01', '2024-10-01', '2024-11-01', '2024-12-01'];
                
                curves.push({
                    name: 'è‚¡ç¥¨1',
                    dates: mockDates,
                    values: [1000000, 1015000, 1030000, 1040000, 1080000, 1105000, 1120000, 1155000, 1180000, 1190000, 1210000, 1250000],
                    color: colors[0]
                });
                
                curves.push({
                    name: 'è‚¡ç¥¨2',
                    dates: mockDates,
                    values: [1000000, 1005000, 1020000, 1050000, 1070000, 1090000, 1130000, 1140000, 1160000, 1180000, 1200000, 1230000],
                    color: colors[1]
                });
                
                allDates = mockDates;
                allValues = [...curves[0].values, ...curves[1].values];
            }
            
            // æ’åºæ—¥æœŸ
            allDates.sort();
            
            // è®¡ç®—å›¾è¡¨å°ºå¯¸
            const padding = 60;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            
            // è®¡ç®—æœ€å¤§å€¼å’Œæœ€å°å€?            const maxValue = Math.max(...allValues) * 1.05;
            const minValue = Math.min(...allValues) * 0.95;
            const valueRange = maxValue - minValue;
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼çº?            ctx.strokeStyle = '#E5E5E5';
            ctx.lineWidth = 1;
            
            // æ°´å¹³ç½‘æ ¼çº?            for (let i = 0; i <= 5; i++) {
                const y = padding + (i / 5) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }
            
            // å‚ç›´ç½‘æ ¼çº?            if (allDates.length > 0) {
                for (let i = 0; i <= allDates.length - 1; i++) {
                    const x = padding + (i / (allDates.length - 1)) * chartWidth;
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, canvas.height - padding);
                    ctx.stroke();
                }
            }
            
            // ç»˜åˆ¶åæ ‡è½?            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // ç»˜åˆ¶æ¯æ¡æ›²çº¿
            curves.forEach(curve => {
                const { dates, values, color } = curve;
                
                if (dates.length === 0 || values.length === 0) return;
                
                // ç»˜åˆ¶æ›²çº¿
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                
                dates.forEach((date, index) => {
                    const dateIndex = allDates.indexOf(date);
                    if (dateIndex === -1) return;
                    
                    const x = padding + (dateIndex / (allDates.length - 1)) * chartWidth;
                    const y = canvas.height - padding - ((values[index] - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // ç»˜åˆ¶æ•°æ®ç‚¹ï¼ˆæ¸…æ™°çš„åœ†å½¢æ ‡è®°ï¼‰
                dates.forEach((date, index) => {
                    const dateIndex = allDates.indexOf(date);
                    if (dateIndex === -1) return;
                    
                    const x = padding + (dateIndex / (allDates.length - 1)) * chartWidth;
                    const y = canvas.height - padding - ((values[index] - minValue) / valueRange) * chartHeight;
                    
                    // ç»˜åˆ¶ç™½è‰²èƒŒæ™¯
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç»˜åˆ¶å½©è‰²è¾¹æ¡†
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.stroke();
                });
            });
            
            // ç»˜åˆ¶æ—¥æœŸæ ‡ç­¾
            ctx.font = '11px Arial';
            ctx.fillStyle = '#666666';
            ctx.textAlign = 'center';
            
            if (allDates.length > 0) {
                const step = Math.max(1, Math.floor(allDates.length / 8));
                allDates.forEach((date, index) => {
                    if (index % step === 0) {
                        const x = padding + (index / (allDates.length - 1)) * chartWidth;
                        const monthLabel = date.slice(0, 7);
                        ctx.fillText(monthLabel, x, canvas.height - padding + 20);
                    }
                });
            }
            
            // ç»˜åˆ¶æ•°å€¼æ ‡ç­?            ctx.font = '11px Arial';
            ctx.fillStyle = '#666666';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const y = padding + (i / 5) * chartHeight;
                const value = minValue + (i / 5) * valueRange;
                const valueInWan = (value / 10000).toFixed(1);
                ctx.fillText(valueInWan + 'ä¸?, padding - 10, y + 4);
            }
            
            // ç»˜åˆ¶åæ ‡è½´æ ‡é¢?            ctx.font = 'bold 13px Arial';
            ctx.fillStyle = '#333333';
            ctx.textAlign = 'center';
            ctx.fillText('æ—¥æœŸ', canvas.width / 2, canvas.height - 15);
            
            ctx.textAlign = 'left';
            ctx.fillText('æ€»èµ„äº?(ä¸‡å…ƒ)', 15, 20);
            
            // ç»˜åˆ¶å›¾ä¾‹ï¼ˆæ¸…æ™°çš„å›¾ä¾‹è®¾è®¡ï¼?            if (curves.length > 1) {
                const legendX = canvas.width - padding - 130;
                const legendY = padding + 10;
                
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'left';
                
                curves.forEach((curve, index) => {
                    const y = legendY + index * 22;
                    
                    // ç»˜åˆ¶å›¾ä¾‹èƒŒæ™¯
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                    ctx.fillRect(legendX - 5, y - 8, 120, 18);
                    
                    // ç»˜åˆ¶é¢œè‰²å?                    ctx.fillStyle = curve.color;
                    ctx.fillRect(legendX, y - 5, 16, 12);
                    
                    // ç»˜åˆ¶è‚¡ç¥¨åç§°
                    ctx.fillStyle = '#333333';
                    ctx.fillText(curve.name, legendX + 22, y + 5);
                });
            }
        }
        
        // å¡«å……äº¤æ˜“è®°å½•
        function populateTradeTable(individualResults) {
            const tableBody = document.getElementById('tradeTableBody');
            tableBody.innerHTML = '';
            
            // è·å–ç”¨æˆ·é€‰æ‹©çš„è‚¡ç¥?            const selectedStocks = getSelectedStocks();
            
            // è‚¡ç¥¨ä¿¡æ¯æ˜ å°„
            const stockInfo = {
                '000001': 'å¹³å®‰é“¶è¡Œ',
                '600519': 'è´µå·èŒ…å°',
                '000858': 'äº”ç²®æ¶?,
                '601318': 'ä¸­å›½å¹³å®‰',
                '000300': 'æ²ªæ·±300'
            };
            
            // å¦‚æœç”¨æˆ·æ²¡æœ‰é€‰æ‹©è‚¡ç¥¨ï¼Œé»˜è®¤é€‰æ‹©å¹³å®‰é“¶è¡Œ
            if (selectedStocks.length === 0) {
                selectedStocks.push('000001');
            }
            
            let allTrades = [];
            
            if (individualResults && individualResults.length > 0) {
                // ä»çœŸå®æ•°æ®ä¸­è·å–äº¤æ˜“è®°å½•
                individualResults.forEach(result => {
                    if (result.trade_log && result.trade_log.length > 0) {
                        allTrades = allTrades.concat(result.trade_log.map(trade => ({
                            ...trade,
                            name: stockInfo[trade.symbol] || ''
                        })));
                    }
                });
            } else {
                // ç”Ÿæˆæ¨¡æ‹Ÿäº¤æ˜“è®°å½•
                const trades = [];
                const startDate = new Date('2024-01-01');
                
                selectedStocks.forEach(stock => {
                    const stockName = stockInfo[stock];
                    let currentPrice = 100 + Math.random() * 50; // åˆå§‹ä»·æ ¼
                    let position = 0; // å½“å‰æŒä»“
                    
                    // ä¸ºæ¯ä¸ªé€‰ä¸­çš„è‚¡ç¥¨ç”Ÿæˆ?0-50æ¡äº¤æ˜“è®°å½•ï¼ˆæ›´ç¬¦åˆå®é™…äº¤æ˜“æ¬¡æ•°ï¼‰
                    const tradeCount = 30 + Math.floor(Math.random() * 21);
                    
                    for (let i = 0; i < tradeCount; i++) {
                        // éšæœºç”Ÿæˆäº¤æ˜“æ—¥æœŸ
                        const tradeDate = new Date(startDate);
                        tradeDate.setDate(startDate.getDate() + Math.floor(Math.random() * 365));
                        const dateStr = tradeDate.toISOString().split('T')[0];
                        
                        // éšæœºç”Ÿæˆäº¤æ˜“ç±»å‹
                        const type = position > 0 && Math.random() > 0.5 ? 'sell' : 'buy';
                        
                        // éšæœºç”Ÿæˆä»·æ ¼æ³¢åŠ¨
                        const priceChange = (Math.random() - 0.5) * 5;
                        currentPrice = Math.max(1, currentPrice + priceChange);
                        
                        // éšæœºç”Ÿæˆäº¤æ˜“æ•°é‡
                        const quantity = Math.floor(1000 + Math.random() * 9000);
                        const amount = currentPrice * quantity;
                        
                        // è®¡ç®—æ”¶ç›Šï¼ˆåªæœ‰å–å‡ºæ—¶æ‰æœ‰æ”¶ç›Šï¼?                        let profit = 0;
                        if (type === 'sell' && position > 0) {
                            // æ¨¡æ‹Ÿå–å‡ºä»·æ ¼é«˜äºä¹°å…¥ä»·æ ¼
                            profit = Math.floor(amount * (0.05 + Math.random() * 0.1));
                        }
                        
                        // æ›´æ–°æŒä»“
                        if (type === 'buy') {
                            position += quantity;
                        } else {
                            position = Math.max(0, position - quantity);
                        }
                        
                        // æ·»åŠ äº¤æ˜“è®°å½•
                        trades.push({
                            date: dateStr,
                            symbol: stock,
                            name: stockName,
                            type: type,
                            price: currentPrice,
                            quantity: quantity,
                            amount: amount,
                            profit: profit
                        });
                    }
                });
                
                allTrades = trades;
            }
            
            // æŒ‰æ—¥æœŸæ’åº?            allTrades.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // æ˜¾ç¤ºæ‰€æœ‰äº¤æ˜“è®°å½•ï¼Œä¸åŠ é™åˆ¶
            allTrades.forEach(trade => {
                const row = document.createElement('tr');
                
                // è®¡ç®—é‡‘é¢
                const price = parseFloat(trade.price || 0);
                const quantity = parseInt(trade.quantity || 0);
                const profit = parseFloat(trade.profit || 0);
                const amount = parseFloat(trade.amount || (price * quantity));
                
                // ä½¿ç”¨åç«¯ä¼ é€’çš„çœŸå®å¸‚åœºçŠ¶æ€?                let marketStatus = '';
                let marketStatusClass = '';
                // ä»åç«¯æ•°æ®ä¸­è·å–å¸‚åœºçŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€?                marketStatus = trade.market_state || (Math.random() > 0.5 ? 'ç‰? : 'ç†?);
                marketStatusClass = marketStatus === 'ç‰? ? 'trade-market-bull' : 'trade-market-bear';
                
                row.innerHTML = `
                    <td>${trade.date || ''}</td>
                    <td>${trade.symbol || ''} ${trade.name || ''}</td>
                    <td class="trade-type-${trade.type}">${trade.type === 'buy' ? 'ä¹°å…¥' : (trade.type === 'sell' ? 'å–å‡º' : '')}</td>
                    <td>${price.toFixed(2)}</td>
                    <td>${quantity.toLocaleString()}</td>
                    <td>${amount.toLocaleString()}</td>
                    <td><span class="${marketStatusClass}">${marketStatus}</span></td>
                    <td>${trade.type === 'sell' ? `<span class="trade-profit-${profit >= 0 ? 'positive' : 'negative'}">${profit >= 0 ? '+' : ''}${profit.toLocaleString()}</span>` : ''}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // è¿è¡Œå›æµ‹
        function runBacktest() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€?            document.getElementById('loadingSection').style.display = 'flex';
            document.getElementById('resultsSection').style.display = 'none';
            
            // è·å–ç”¨æˆ·é€‰æ‹©çš„è‚¡ç¥?            const selectedStocks = getSelectedStocks();
            
            // è·å–å›æµ‹å‚æ•°
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const initialCash = document.getElementById('initialCash').value;
            const transactionCost = document.getElementById('transactionCost').value;
            
            // é€‰æ‹©çš„ç­–ç•?            const strategy = document.querySelector('.strategy-option.selected');
            const strategyType = strategy ? strategy.getAttribute('data-strategy') : 'moving_average';
            
            // è½¬æ¢æ—¥æœŸæ ¼å¼ï¼ˆYYYY-MM-DD -> YYYYMMDDï¼?            const formattedStartDate = startDate.replace(/-/g, '');
            const formattedEndDate = endDate.replace(/-/g, '');
            
            // å¦‚æœç”¨æˆ·æ²¡æœ‰é€‰æ‹©è‚¡ç¥¨ï¼Œé»˜è®¤é€‰æ‹©å¹³å®‰é“¶è¡Œ
            if (selectedStocks.length === 0) {
                selectedStocks.push('000001');
            }
            
            // æ„å»ºAPIè¯·æ±‚URL
            const apiUrl = `/api/backtest/multi`;
            
            // å‡†å¤‡è¯·æ±‚æ•°æ®
            const requestData = {
                symbols: selectedStocks,
                start_date: formattedStartDate,
                end_date: formattedEndDate,
                fast_period: 5,
                slow_period: 20,
                initial_cash: initialCash,
                transaction_cost: transactionCost,
                strategy_type: strategyType
            };
            
            // å‘é€APIè¯·æ±‚
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // éšè—åŠ è½½çŠ¶æ€?                document.getElementById('loadingSection').style.display = 'none';
                
                if (data.result) {
                    // æ˜¾ç¤ºç»“æœ
                    document.getElementById('resultsSection').style.display = 'block';
                    
                    // å¡«å……å›æµ‹ç»“æœ
            document.getElementById('resultInitialCash').textContent = (data.result.initial_cash || 0).toLocaleString();
            document.getElementById('resultFinalValue').textContent = (data.result.final_value || 0).toLocaleString();
            
            const totalReturnEl = document.getElementById('resultTotalReturn');
            const totalReturn = data.result.total_return || 0;
            totalReturnEl.textContent = (totalReturn >= 0 ? '+' : '') + totalReturn.toFixed(2) + '%';
            totalReturnEl.className = 'result-stat-value ' + (totalReturn >= 0 ? 'positive' : 'negative');
            
            document.getElementById('resultMaxDrawdown').textContent = (data.result.max_drawdown || 0).toFixed(2) + '%';
            document.getElementById('resultTotalTrades').textContent = data.result.total_trades || 0;
            document.getElementById('resultWinRate').textContent = (data.result.win_rate || 0).toFixed(2) + '%';
            
            // ç»˜åˆ¶æ”¶ç›Šæ›²çº¿
            drawProfitChart(data.result.equity_curve || []);
            
            // å¡«å……äº¤æ˜“è®°å½•
            populateTradeTable(data.result.individual_results || []);
                } else {
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    alert('å›æµ‹å¤±è´¥ï¼? + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                // éšè—åŠ è½½çŠ¶æ€?                document.getElementById('loadingSection').style.display = 'none';
                console.error('å›æµ‹é”™è¯¯:', error);
                alert('å›æµ‹å¤±è´¥ï¼? + error.message);
            });
        }
        
        // é‡ç½®è¡¨å•
        function resetForm() {
            // å–æ¶ˆæ‰€æœ‰è‚¡ç¥¨é€‰æ‹©
            document.querySelectorAll('.stock-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.classList.remove('selected');
            });
            
            // å–æ¶ˆç­–ç•¥é€‰æ‹©
            document.querySelectorAll('.strategy-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // é‡ç½®è¡¨å•å€?            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            
            // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            function checkLogin() {
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                if (isLoggedIn !== 'true') {
                    window.location.href = 'login.html';
                }
            }
            
            document.getElementById('startDate').value = formatDate(oneYearAgo);
            document.getElementById('endDate').value = formatDate(today);
            document.getElementById('initialCash').value = '1000000';
            document.getElementById('transactionCost').value = '0.3';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
        });
    </script>
</body>
</html>
