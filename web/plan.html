<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥è®¡åˆ’ - é‡åŒ–äº¤æ˜“ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            display: block;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            background-color: #667eea;
            color: white;
        }
        
        .nav-item:hover:not(.active) {
            background-color: #f0f0f0;
        }
        
        .section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title .refresh-btn {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        
        .section-title .refresh-btn:hover {
            background-color: #5a6fd8;
        }
        
        .card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-bull {
            background-color: #e8f5e9;
            color: #c62828;
        }
        
        .status-bear {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        
        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border: 1px solid #eee;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-value.positive {
            color: #f44336;
        }
        
        .stat-value.negative {
            color: #4caf50;
        }
        
        .text-positive {
            color: #f44336;
        }
        
        .text-negative {
            color: #4caf50;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background-color: #f9f9f9;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .news-item {
            padding: 15px;
            border-left: 3px solid #667eea;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .news-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .news-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }
        
        .news-content {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
        
        .action-list {
            list-style: none;
        }
        
        .action-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .action-item:last-child {
            border-bottom: none;
        }
        
        .action-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 15px;
            min-width: 60px;
            text-align: center;
        }
        
        .action-buy {
            background-color: #e8f5e9;
            color: #c62828;
        }
        
        .action-sell {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .action-hold {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .action-content {
            flex: 1;
        }
        
        .action-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .action-detail {
            font-size: 13px;
            color: #666;
        }
        
        .execute-btn {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .execute-btn:hover {
            background-color: #5a6fd8;
        }
        
        .execute-btn:active {
            background-color: #4c5fd6;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd8;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¯¼èˆªæ ?-->
        <div class="nav-bar">
            <div class="nav-item" data-page="home" onclick="window.location.href='index.html'">é¦–é¡µ</div>
            <div class="nav-item active" data-page="plan">è®¡åˆ’</div>
            <div class="nav-item" data-page="backtest" onclick="window.location.href='backtest.html'">å›æµ‹</div>
            <div class="nav-item" data-page="prediction" onclick="window.location.href='prediction.html'">é¢„æµ‹</div>
            <div class="nav-item" data-page="strategy" onclick="window.location.href='strategy.html'">ç­–ç•¥</div>
            <div class="nav-item" data-page="settings" onclick="window.location.href='settings.html'">è®¾ç½®</div>
        </div>
        
        <!-- å¤´éƒ¨ -->
        <div class="header" style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <span class="title">æ¯æ—¥æ“ä½œè®¡åˆ’</span>
                <span class="subtitle">åŸºäºé‡åŒ–ç­–ç•¥çš„æ™ºèƒ½äº¤æ˜“å†³ç­–æ”¯æŒ?/span>
                <div style="margin-top: 8px; font-size: 12px; opacity: 0.8;">
                    æœ€åæ›´æ–? <span id="lastUpdateTime">--</span>
                </div>
            </div>
            <button class="header-btn" onclick="exportPDF()">PDF</button>
        </div>
        
        <!-- å¸‚åœºçŠ¶æ€åˆ¤æ–­æ¨¡å?-->
        <div class="section">
            <div class="section-title">
                å¸‚åœºçŠ¶æ€åˆ¤æ–?                <button class="refresh-btn" onclick="refreshMarketStatus()">åˆ·æ–°</button>
            </div>
            <div class="card">
                <div class="grid-2">
                    <div>
                        <div class="card-title">å½“å‰å¸‚åœºçŠ¶æ€?/div>
                        <div style="margin-top: 10px;">
                            <span class="stat-value" id="marketStatus">ç‰›å¸‚</span>
                        </div>
                    </div>
                    <div>
                        <div class="card-title">å»ºè®®ä»“ä½</div>
                        <div style="margin-top: 10px;">
                            <span class="stat-value" id="positionSuggestion">80%</span>
                        </div>
                    </div>
                </div>
                <div class="grid-2" style="margin-top: 20px;">
                    <div>
                        <div class="card-title">æ²ªæ·±300æŒ‡æ•°</div>
                        <div style="margin-top: 10px;">
                            <span class="stat-value" id="hs300Index">3850.23</span>
                        </div>
                    </div>
                    <div>
                        <div class="card-title">120æ—¥å‡çº?/div>
                        <div style="margin-top: 10px;">
                            <span class="stat-value" id="ma120">3760.50</span>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="marketChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- æŒä»“åˆ†ææ¨¡å— -->
        <div class="section">
            <div class="section-title">
                æŒä»“åˆ†æ
                <button class="refresh-btn" onclick="refreshPositionAnalysis()">åˆ·æ–°</button>
            </div>
            <div class="grid-5">
                <div class="stat-card">
                    <div class="stat-label">åŸå§‹èµ„é‡‘</div>
                    <div class="stat-value" id="originalCash">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ€»èµ„äº?/div>
                    <div class="stat-value" id="totalAssets">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ€»ç›ˆäº?/div>
                    <div class="stat-value" id="totalProfitLoss">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æŒä»“å¸‚å€?/div>
                    <div class="stat-value" id="positionValue">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å½“å‰ä»“ä½</div>
                    <div class="stat-value" id="currentPosition">--</div>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">æŒä»“æ˜ç»†</div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th>è‚¡ç¥¨åç§°</th>
                            <th>æŒä»“æ•°é‡</th>
                            <th>æˆæœ¬ä»?/th>
                            <th>ç°ä»·</th>
                            <th>æŒä»“é‡‘é¢</th>
                            <th>ç›ˆäºé‡‘é¢</th>
                            <th>ç›ˆäºæ¯”ä¾‹</th>
                        </tr>
                    </thead>
                    <tbody id="positionTable">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #999;">æš‚æ— æŒä»“æ•°æ®</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- è°ƒä»“ç­–ç•¥æ¨¡å— -->
        <div class="section">
            <div class="section-title">
                è°ƒä»“ç­–ç•¥
                <button class="refresh-btn" onclick="refreshAdjustStrategy()">åˆ·æ–°</button>
            </div>
            <div class="card">
                <div class="card-title">è°ƒä»“è§„åˆ™</div>
                <div style="margin-top: 15px;">
                    <div style="margin-bottom: 10px;">
                        <strong>æ­¢ç›ˆè§„åˆ™ï¼?/strong>ç›ˆåˆ©è¾¾åˆ°10%æ—¶ï¼Œè§¦å‘æ­¢ç›ˆå»ºè®®
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>æ­¢æŸè§„åˆ™ï¼?/strong>äºæŸè¾¾åˆ°4%æ—¶ï¼Œè§¦å‘æ­¢æŸå»ºè®®
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>ç‰›ç†Šè½¬æ¢è§„åˆ™ï¼?/strong>ç‰›å¸‚è½¬ç†Šå¸‚ï¼šä»“ä½ä»?0%é™è‡³30%
                    </div>
                    <div>
                        <strong>ç›˜ä¸­è°ƒæ•´ï¼?/strong>æ¯?0åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æŒä»?                    </div>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">è°ƒä»“å»ºè®®</div>
                <ul class="action-list" id="adjustmentList">
                    <li class="action-item">
                        <span class="action-type action-sell">æ­¢ç›ˆ</span>
                        <div class="action-content">
                            <div class="action-title">600519 è´µå·èŒ…å°</div>
                            <div class="action-detail">å½“å‰ç›ˆåˆ©12.3%ï¼Œå»ºè®®æ­¢ç›ˆéƒ¨åˆ†ä»“ä½?/div>
                        </div>
                    </li>
                    <li class="action-item">
                        <span class="action-type action-buy">ä¹°å…¥</span>
                        <div class="action-content">
                            <div class="action-title">000858 äº”ç²®æ¶?/div>
                            <div class="action-detail">æŠ€æœ¯å›è°ƒè‡³å…³é”®æ”¯æ’‘ä½ï¼Œå»ºè®®å»ºä»“</div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- ä¹°å…¥ç­–ç•¥æ¨¡å— -->
        <div class="section">
            <div class="section-title">
                ä¹°å…¥ç­–ç•¥
                <button class="refresh-btn" onclick="refreshBuyStrategy()">åˆ·æ–°</button>
            </div>
            <div class="card">
                <div class="card-title">ä¹°å…¥æ¡ä»¶</div>
                <div style="margin-top: 15px;">
                    <div style="margin-bottom: 10px;">
                        <strong>å¸‚åœºç¯å¢ƒï¼?/strong>æ•´ä½“å¤„äºç‰›å¸‚æˆ–ç†Šå¸‚ï¼Œæ— é‡å¤§ç³»ç»Ÿæ€§é£é™?                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>æŠ€æœ¯æ¡ä»¶ï¼š</strong>ç›®æ ‡è‚¡ç¥¨å¤„äºä¸Šå‡è¶‹åŠ¿ï¼Œå‡ºç°å¥åº·çš„æŠ€æœ¯æ€§å›è°?                    </div>
                    <div>
                        <strong>é£é™©æ§åˆ¶ï¼?/strong>å•åªè‚¡ç¥¨ä»“ä½é™åˆ¶ï¼Œä¹°å…¥ä»·æ ¼åŒºé—´æ§åˆ¶ï¼Œæ­¢æŸä½é¢„è®?                    </div>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">ä¹°å…¥å»ºè®®</div>
                <ul class="action-list" id="buyList">
                </ul>
            </div>
        </div>
        
        <!-- èµ„è®¯æ•´åˆæ¨¡å— -->
        <div class="section">
            <div class="section-title">
                èµ„è®¯æ•´åˆ
                <button class="refresh-btn" onclick="refreshNews()">åˆ·æ–°</button>
            </div>
            <div id="newsContainer">
                <div class="news-item">
                    <div class="news-title">å¤®è¡Œï¼šç»§ç»­å®æ–½ç¨³å¥è´§å¸æ”¿ç­?/div>
                    <div class="news-time">2026-01-26 10:30</div>
                    <div class="news-content">å¤®è¡Œè¡¨ç¤ºå°†ç»§ç»­å®æ–½ç¨³å¥çš„è´§å¸æ”¿ç­–ï¼Œä¿æŒæµåŠ¨æ€§åˆç†å……è£•ï¼Œæ”¯æŒå®ä½“ç»æµå‘å±•ã€?/div>
                </div>
                <div class="news-item">
                    <div class="news-title">æ²ªæ·±300æŒ‡æ•°ä¸Šæ¶¨1.2%</div>
                    <div class="news-time">2026-01-26 15:00</div>
                    <div class="news-content">ä»Šæ—¥æ²ªæ·±300æŒ‡æ•°æ”¶æŠ¥3850ç‚¹ï¼Œä¸Šæ¶¨1.2%ï¼Œæˆäº¤é¢æ”¾å¤§è‡?500äº¿å…ƒã€?/div>
                </div>
                <div class="news-item">
                    <div class="news-title">ç§‘æŠ€æ¿å—é¢†æ¶¨å¸‚åœº</div>
                    <div class="news-time">2026-01-26 14:45</div>
                    <div class="news-content">ç§‘æŠ€æ¿å—ä»Šæ—¥è¡¨ç°å¼ºåŠ¿ï¼Œå¤šåªä¸ªè‚¡æ¶¨åœï¼Œå¸‚åœºæƒ…ç»ªæ˜æ˜¾å›æš–ã€?/div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadPlanData();
        });
        
        // åŠ è½½è®¡åˆ’æ•°æ®
        async function loadPlanData() {
            try {
                await Promise.all([
                    loadMarketStatus(),
                    loadPositionAnalysis(),
                    loadAdjustmentStrategy(),
                    loadBuyStrategy(),
                    loadNews()
                ]);
            } catch (error) {
                console.error('åŠ è½½è®¡åˆ’æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å¸‚åœºçŠ¶æ€?        async function loadMarketStatus() {
            try {
                const response = await fetch('/api/plan/market-status');
                const data = await response.json();
                
                // æ›´æ–°å¸‚åœºçŠ¶æ€æ˜¾ç¤?                const statusBadge = document.getElementById('marketStatus');
                statusBadge.textContent = data.status_text;
                statusBadge.className = `stat-value ${data.status === 'bull' ? 'positive' : 'negative'}`;
                
                // æ›´æ–°ä»“ä½å»ºè®®
                document.getElementById('positionSuggestion').textContent = data.position_suggestion;
                
                // æ›´æ–°æ²ªæ·±300æŒ‡æ•°å’?20æ—¥å‡çº?                document.getElementById('hs300Index').textContent = data.hs300_index.toFixed(2);
                document.getElementById('ma120').textContent = data.ma120.toFixed(2);
                
                // åˆå§‹åŒ–å›¾è¡?                initMarketChart(data.chart_data);
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºçŠ¶æ€å¤±è´?', error);
            }
        }
        
        // åˆå§‹åŒ–å¸‚åœºçŠ¶æ€å›¾è¡?        function initMarketChart(chartData) {
            const ctx = document.getElementById('marketChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'æ²ªæ·±300æŒ‡æ•°',
                            data: chartData.hs300,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: '120æ—¥å‡çº?,
                            data: chartData.ma120,
                            borderColor: '#ff9800',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        // åŠ è½½æŒä»“åˆ†æ
        async function loadPositionAnalysis() {
            try {
                // ä¼˜å…ˆä»localStorageè·å–å¯ç”¨ç°é‡‘å€?                let availableCashParam = '';
                try {
                    const storedCash = localStorage.getItem('availableCash');
                    if (storedCash) {
                        availableCashParam = `?available_cash=${storedCash}`;
                    }
                } catch (error) {
                    console.error('è¯»å–localStorageä¸­çš„å¯ç”¨ç°é‡‘å¤±è´¥:', error);
                }
                
                // ä¼˜å…ˆä»localStorageè·å–åŸå§‹èµ„é‡‘å€?                let originalCashParam = '';
                try {
                    const storedCash = localStorage.getItem('originalCash');
                    console.log('ä»localStorageè¯»å–çš„åŸå§‹èµ„é‡?', storedCash);
                    if (storedCash) {
                        if (availableCashParam) {
                            originalCashParam = `&original_cash=${storedCash}`;
                        } else {
                            originalCashParam = `?original_cash=${storedCash}`;
                        }
                    }
                } catch (error) {
                    console.error('è¯»å–localStorageä¸­çš„åŸå§‹èµ„é‡‘å¤±è´¥:', error);
                }
                
                console.log('å¯ç”¨ç°é‡‘å‚æ•°:', availableCashParam);
                console.log('åŸå§‹èµ„é‡‘å‚æ•°:', originalCashParam);
                
                // åå¤è¯»å–æ•°æ®ç›´åˆ°ç°ä»·æ•°æ®æ­£ç¡®
                let data = null;
                let retryCount = 0;
                const maxRetries = 10;
                const retryInterval = 1000; // 1ç§?                
                while (retryCount < maxRetries) {
                    // æ·»åŠ æ—¶é—´æˆ³å‚æ•°ç¦ç”¨ç¼“å­?                    const cacheBuster = `&_t=${Date.now()}`;
                    const response = await fetch(`/api/plan/position${availableCashParam}${originalCashParam}${cacheBuster}`, {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    data = await response.json();
                    console.log(`[DEBUG] ç¬?${retryCount + 1} æ¬¡è·å–æŒä»“æ•°æ?`, data);
                    
                    // æ£€æŸ¥æ‰€æœ‰æŒä»“çš„ç°ä»·æ˜¯å¦æœ‰æ•ˆï¼ˆä¸ä¸?ã€ä¸ä¸ºnullã€ä¸ä¸ºundefinedï¼?                    const allPricesValid = data.positions && data.positions.every(pos => 
                        pos.current_price !== null && 
                        pos.current_price !== undefined && 
                        pos.current_price > 0
                    );
                    
                    if (allPricesValid) {
                        console.log(`æŒä»“æ•°æ®è¯»å–æˆåŠŸï¼Œå…±å°è¯• ${retryCount + 1} æ¬¡`);
                        break;
                    } else {
                        console.warn(`ç¬?${retryCount + 1} æ¬¡è¯»å–ï¼šç°ä»·æ•°æ®ä¸å®Œæ•´ï¼Œç­‰å¾… ${retryInterval}ms åé‡è¯?..`);
                        retryCount++;
                        if (retryCount < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, retryInterval));
                        }
                    }
                }
                
                if (retryCount >= maxRetries) {
                    console.warn(`å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•?${maxRetries}ï¼Œä½¿ç”¨æœ€åä¸€æ¬¡è¯»å–çš„æ•°æ®`);
                }
                
                // æ›´æ–°æ€»ä½“æ¦‚å†µ
                const originalCash = localStorage.getItem('originalCash');
                console.log('ä»localStorageè¯»å–çš„åŸå§‹èµ„é‡?', originalCash);
                if (originalCash) {
                    document.getElementById('originalCash').textContent = formatCurrency(parseFloat(originalCash));
                } else {
                    document.getElementById('originalCash').textContent = '--';
                }
                
                document.getElementById('totalAssets').textContent = formatCurrency(data.total_assets);
                
                // è®¡ç®—æ€»ç›ˆäºï¼šæ€»ç›ˆäº?= æ€»èµ„äº?- æœ¬é¡µçš„åŸå§‹èµ„é‡‘æ•°å€?                const totalProfitLoss = originalCash ? data.total_assets - parseFloat(originalCash) : data.total_profit_loss;
                console.log('è®¡ç®—çš„æ€»ç›ˆäº?', totalProfitLoss);
                
                const profitLossElement = document.getElementById('totalProfitLoss');
                profitLossElement.textContent = formatCurrency(totalProfitLoss);
                profitLossElement.className = `stat-value ${totalProfitLoss >= 0 ? 'positive' : 'negative'}`;
                
                document.getElementById('positionValue').textContent = formatCurrency(data.position_value);
                
                document.getElementById('currentPosition').textContent = data.current_position;
                
                // æ›´æ–°æŒä»“æ˜ç»†è¡¨æ ¼
                const tableBody = document.getElementById('positionTable');
                tableBody.innerHTML = data.positions.map(pos => {
                    const positionAmount = pos.quantity * pos.current_price;
                    return `
                    <tr>
                        <td>${pos.symbol}</td>
                        <td>${pos.name}</td>
                        <td>${pos.quantity}</td>
                        <td>${pos.cost_price.toFixed(2)}</td>
                        <td>${pos.current_price.toFixed(2)}</td>
                        <td style="font-weight: bold;">${formatCurrency(positionAmount)}</td>
                        <td class="${pos.profit_loss >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(pos.profit_loss)}</td>
                        <td class="${pos.profit_loss_percent >= 0 ? 'text-positive' : 'text-negative'}">${pos.profit_loss_percent.toFixed(2)}%</td>
                    </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½æŒä»“åˆ†æå¤±è´¥:', error);
            }
        }
        
        // åŠ è½½è°ƒä»“ç­–ç•¥
        async function loadAdjustmentStrategy() {
            try {
                const response = await fetch('/api/plan/adjustment');
                const data = await response.json();
                
                // è·å–å·²æ‰§è¡Œçš„è°ƒä»“å»ºè®®
                let executedAdjustments = [];
                try {
                    const stored = localStorage.getItem('executedAdjustments');
                    if (stored) {
                        executedAdjustments = JSON.parse(stored);
                    }
                } catch (error) {
                    console.error('è¯»å–å·²æ‰§è¡Œçš„è°ƒä»“å»ºè®®å¤±è´¥:', error);
                }
                
                // æ›´æ–°è°ƒä»“å»ºè®®åˆ—è¡¨
                const adjustmentList = document.getElementById('adjustmentList');
                if (data.suggestions && data.suggestions.length > 0) {
                    // è¿‡æ»¤å·²æ‰§è¡Œçš„è°ƒä»“å»ºè®®
                    const filteredSuggestions = data.suggestions.filter(suggestion => {
                        const key = `${suggestion.symbol}_${suggestion.action_text}`;
                        return !executedAdjustments.includes(key);
                    });
                    
                    if (filteredSuggestions.length > 0) {
                        adjustmentList.innerHTML = filteredSuggestions.map(suggestion => {
                            // åªä¸ºå–å‡ºç±»å‹çš„å»ºè®®æ·»åŠ æ‰§è¡ŒæŒ‰é’?                            const executeButton = suggestion.action === 'sell' ? 
                                `<button class="execute-btn" onclick="executeSell('${suggestion.symbol}', '${suggestion.name}', '${suggestion.action_text}')">æ‰§è¡Œ</button>` : '';
                            
                            return `
                            <li class="action-item">
                                <span class="action-type action-${suggestion.action}">${suggestion.action_text}</span>
                                <div class="action-content">
                                    <div class="action-title">${suggestion.symbol} ${suggestion.name} ${suggestion.current_price !== undefined ? `- å½“å‰ä»·æ ¼: Â¥${suggestion.current_price.toFixed(2)}` : ''}</div>
                                    <div class="action-detail">${suggestion.reason} - ${suggestion.detail}</div>
                                </div>
                                ${executeButton}
                            </li>
                            `;
                        }).join('');
                    } else {
                        // å½“è¿‡æ»¤åæ²¡æœ‰å»ºè®®æ—¶ï¼Œæ˜¾ç¤ºæš‚æ— 
                        adjustmentList.innerHTML = `
                            <li class="action-item" style="justify-content: center; padding: 20px;">
                                <div class="action-content" style="text-align: center; color: #666;">
                                    æš‚æ— 
                                </div>
                            </li>
                        `;
                    }
                } else {
                    // å½“æ²¡æœ‰å»ºè®®æ—¶ï¼Œæ˜¾ç¤ºæš‚æ—?                    adjustmentList.innerHTML = `
                        <li class="action-item" style="justify-content: center; padding: 20px;">
                            <div class="action-content" style="text-align: center; color: #666;">
                                æš‚æ— 
                            </div>
                        </li>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½è°ƒä»“ç­–ç•¥å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ä¹°å…¥ç­–ç•¥
        async function loadBuyStrategy() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/plan/buy?_t=${timestamp}`);
                const data = await response.json();
                
                // è·å–å½“å‰æŒä»“åˆ—è¡¨ï¼Œç”¨äºè¿‡æ»¤å·²æŒä»“çš„è‚¡ç¥?                let heldSymbols = [];
                try {
                    const positionResponse = await fetch(`/api/plan/position?_t=${timestamp}`);
                    const positionData = await positionResponse.json();
                    if (positionData.positions && positionData.positions.length > 0) {
                        heldSymbols = positionData.positions.map(pos => pos.symbol);
                        console.log('å·²æŒä»“è‚¡ç¥¨ä»£ç ?', heldSymbols);
                    }
                } catch (error) {
                    console.error('è·å–æŒä»“æ•°æ®å¤±è´¥:', error);
                }
                
                // æ›´æ–°ä¹°å…¥å»ºè®®åˆ—è¡¨ï¼Œå‰”é™¤å·²æŒä»“çš„è‚¡ç¥?                const buyList = document.getElementById('buyList');
                if (data.suggestions && data.suggestions.length > 0) {
                    const filteredSuggestions = data.suggestions.filter(suggestion => !heldSymbols.includes(suggestion.symbol));
                    
                    if (filteredSuggestions.length > 0) {
                        buyList.innerHTML = filteredSuggestions.map(suggestion => {
                            // åªä¸ºä¹°å…¥ç±»å‹çš„å»ºè®®æ·»åŠ æ‰§è¡ŒæŒ‰é’?                            const executeButton = suggestion.action === 'buy' ? 
                                `<button class="execute-btn" onclick="executeBuy('${suggestion.symbol}', '${suggestion.name}', ${suggestion.price_range ? suggestion.price_range.split('-')[1] : 0})">æ‰§è¡Œ</button>` : '';
                            
                            return `
                            <li class="action-item">
                                <span class="action-type action-${suggestion.action}">${suggestion.action_text}</span>
                                <div class="action-content">
                                    <div class="action-title">${suggestion.symbol} ${suggestion.name} ${suggestion.current_price !== undefined ? `- å½“å‰ä»·æ ¼: Â¥${suggestion.current_price.toFixed(2)}` : ''}</div>
                                    <div class="action-detail">${suggestion.reason} ${suggestion.price_range ? `- å»ºè®®ä»·æ ¼åŒºé—´ï¼?{suggestion.price_range}å…ƒï¼Œæ­¢æŸä½ï¼š${suggestion.stop_loss}å…ƒ` : ''}</div>
                                </div>
                                ${executeButton}
                            </li>
                            `;
                        }).join('');
                    } else {
                        // å½“è¿‡æ»¤åæ²¡æœ‰å»ºè®®æ—¶ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                        buyList.innerHTML = `
                            <li class="action-item" style="justify-content: center; padding: 20px;">
                                <div class="action-content" style="text-align: center; color: #666;">
                                    æš‚æ— ä¹°å…¥å»ºè®®ï¼ˆå·²è¿‡æ»¤æŒä»“è‚¡ç¥¨ï¼?                                </div>
                            </li>
                        `;
                    }
                } else {
                    // å½“æ²¡æœ‰å»ºè®®æ—¶ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ?                    buyList.innerHTML = `
                        <li class="action-item" style="justify-content: center; padding: 20px;">
                            <div class="action-content" style="text-align: center; color: #666;">
                                æš‚æ— ä¹°å…¥å»ºè®®
                            </div>
                        </li>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ä¹°å…¥ç­–ç•¥å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½èµ„è®¯
        async function loadNews() {
            try {
                const response = await fetch('/api/plan/news');
                const data = await response.json();
                
                // æ›´æ–°èµ„è®¯åˆ—è¡¨
                const newsContainer = document.getElementById('newsContainer');
                newsContainer.innerHTML = data.news.map(news => `
                    <div class="news-item">
                        <div class="news-title">${news.title}</div>
                        <div class="news-time">${news.time} - ${news.source}</div>
                        <div class="news-content">${news.content}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½èµ„è®¯å¤±è´¥:', error);
            }
        }
        
        // æ ¼å¼åŒ–è´§å¸?        function formatCurrency(value) {
            return 'Â¥' + value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // åˆ·æ–°å¸‚åœºçŠ¶æ€?        async function refreshMarketStatus() {
            const btn = event.target;
            btn.textContent = 'åˆ·æ–°ä¸?..';
            btn.disabled = true;
            
            try {
                await loadMarketStatus();
                alert('å¸‚åœºçŠ¶æ€å·²æ›´æ–°');
            } catch (error) {
                console.error('åˆ·æ–°å¸‚åœºçŠ¶æ€å¤±è´?', error);
                alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                btn.textContent = 'åˆ·æ–°';
                btn.disabled = false;
            }
        }
        
        // åˆ·æ–°æŒä»“åˆ†æ
        async function refreshPositionAnalysis() {
            const btn = event.target;
            btn.textContent = 'åˆ·æ–°ä¸?..';
            btn.disabled = true;
            
            try {
                await loadPositionAnalysis();
                alert('æŒä»“åˆ†æå·²æ›´æ–?);
            } catch (error) {
                console.error('åˆ·æ–°æŒä»“åˆ†æå¤±è´¥:', error);
                alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                btn.textContent = 'åˆ·æ–°';
                btn.disabled = false;
            }
        }
        
        // åˆ·æ–°è°ƒä»“ç­–ç•¥
        async function refreshAdjustStrategy() {
            const btn = event.target;
            btn.textContent = 'åˆ·æ–°ä¸?..';
            btn.disabled = true;
            
            try {
                await loadAdjustmentStrategy();
                alert('è°ƒä»“ç­–ç•¥å·²æ›´æ–?);
            } catch (error) {
                console.error('åˆ·æ–°è°ƒä»“ç­–ç•¥å¤±è´¥:', error);
                alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                btn.textContent = 'åˆ·æ–°';
                btn.disabled = false;
            }
        }
        
        // åˆ·æ–°ä¹°å…¥ç­–ç•¥
        async function refreshBuyStrategy() {
            const btn = event.target;
            btn.textContent = 'åˆ·æ–°ä¸?..';
            btn.disabled = true;
            
            try {
                await loadBuyStrategy();
                alert('ä¹°å…¥ç­–ç•¥å·²æ›´æ–?);
            } catch (error) {
                console.error('åˆ·æ–°ä¹°å…¥ç­–ç•¥å¤±è´¥:', error);
                alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                btn.textContent = 'åˆ·æ–°';
                btn.disabled = false;
            }
        }
        
        // æ‰§è¡Œä¹°å…¥æ“ä½œ
        async function executeBuy(symbol, name, suggestedPrice) {
            try {
                // è·å–è‚¡ç¥¨å½“å‰ä»·æ ¼
                const response = await fetch(`/api/stocks/kline?symbol=${symbol}&start_date=2026-01-01`);
                
                if (!response.ok) {
                    console.error(`è·å– ${symbol} ä»·æ ¼å¤±è´¥: ${response.status}`);
                    alert(`è·å–è‚¡ç¥¨ä»·æ ¼å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•`);
                    return;
                }
                
                const data = await response.json();
                
                let currentPrice = suggestedPrice;
                if (data && data.kline && data.kline.length > 0) {
                    currentPrice = data.kline[data.kline.length - 1].close;
                    console.log(`è·å–åˆ?${symbol} çš„æœ€æ–°ä»·æ ? ${currentPrice}`);
                } else {
                    console.warn(`æ— æ³•è·å– ${symbol} çš„æœ€æ–°ä»·æ ¼ï¼Œä½¿ç”¨å»ºè®®ä»·æ ¼: ${suggestedPrice}`);
                    currentPrice = suggestedPrice;
                }
                
                // è·å–å¸‚åœºçŠ¶æ€?                const marketStatusResponse = await fetch('/api/plan/market-status');
                
                if (!marketStatusResponse.ok) {
                    console.error(`è·å–å¸‚åœºçŠ¶æ€å¤±è´? ${marketStatusResponse.status}`);
                    alert(`è·å–å¸‚åœºçŠ¶æ€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•`);
                    return;
                }
                
                const marketStatusData = await marketStatusResponse.json();
                const isBullMarket = marketStatusData.status === 'bull';
                const targetPositionPct = isBullMarket ? 0.8 : 0.3;
                
                // è·å–å½“å‰æŒä»“æ•°æ®
                const positionResponse = await fetch('/api/plan/position');
                
                if (!positionResponse.ok) {
                    console.error(`è·å–æŒä»“æ•°æ®å¤±è´¥: ${positionResponse.status}`);
                    alert(`è·å–æŒä»“æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•`);
                    return;
                }
                
                const positionData = await positionResponse.json();
                const positions = positionData.positions || [];
                
                // ä½¿ç”¨åç«¯è¿”å›çš„å¯ç”¨èµ„é‡?                let availableCash = positionData.available_cash || 187500.00;
                
                // æ›´æ–°localStorageä»¥ä¿æŒåŒæ­?                try {
                    localStorage.setItem('availableCash', availableCash.toString());
                } catch (error) {
                    console.error('æ›´æ–°localStorageå¤±è´¥:', error);
                }
                
                let positionValue = 0;
                positions.forEach(pos => {
                    positionValue += parseFloat(pos.quantity) * parseFloat(pos.current_price);
                });
                
                const totalAssets = availableCash + positionValue;
                
                // è®¡ç®—ç›®æ ‡æŒä»“å¸‚å€?                const targetPositionValue = totalAssets * targetPositionPct;
                
                // æ£€æŸ¥å½“å‰ä»“ä½æ˜¯å¦å·²è¶…è¿‡ç›®æ ‡ä»“ä½
                if (positionValue >= targetPositionValue) {
                    alert(`å½“å‰ä»“ä½å·²è¾¾åˆ°ç›®æ ‡ä»“ä½?{(targetPositionPct * 100).toFixed(0)}%ï¼Œæ— æ³•ç»§ç»­ä¹°å…¥`);
                    return;
                }
                
                // è®¡ç®—å¯ç”¨ä¹°å…¥é‡‘é¢
                const availableBuyAmount = Math.min(availableCash, targetPositionValue - positionValue);
                
                // å•åªè‚¡ç¥¨æŒä»“ä¸Šé™æ§åˆ¶ï¼šä¸è¶…è¿‡æ€»èµ„äº§çš„20%
                const maxSingleStockValue = totalAssets * 0.2;
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè‚¡ç¥¨
                const existingPosition = positions.find(pos => pos.symbol === symbol);
                let availableForStock;
                
                if (existingPosition) {
                    const existingValue = parseFloat(existingPosition.quantity) * currentPrice;
                    if (existingValue >= maxSingleStockValue) {
                        alert(`è‚¡ç¥¨ ${symbol} å·²è¾¾åˆ°å•åªè‚¡ç¥¨æŒä»“ä¸Šé™?0%`);
                        return;
                    }
                    availableForStock = Math.min(availableBuyAmount, maxSingleStockValue - existingValue);
                } else {
                    availableForStock = Math.min(availableBuyAmount, maxSingleStockValue);
                }
                
                // è®¡ç®—ä¹°å…¥æ•°é‡ï¼ˆå¿…é¡»æ˜¯100çš„æ•´æ•°å€ï¼‰
                let maxQuantity = Math.floor(availableForStock / currentPrice);
                maxQuantity = Math.floor(maxQuantity / 100) * 100;
                
                // ç¡®ä¿è‡³å°‘ä¹°å…¥100è‚?                if (maxQuantity < 100) {
                    alert(`å¯ç”¨èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•ä¹°å…?00è‚¡`);
                    return;
                }
                
                const quantity = maxQuantity;
                const buyAmount = currentPrice * quantity;
                
                // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡?                const confirmMsg = `ç¡®è®¤ä¹°å…¥ ${name} (${symbol})ï¼Ÿ\n\n` +
                    `å½“å‰ä»·æ ¼ï¼?{currentPrice.toFixed(2)} å…ƒ\n` +
                    `å»ºè®®ä»·æ ¼ï¼?{suggestedPrice} å…ƒ\n` +
                    `ä¹°å…¥æ•°é‡ï¼?{quantity} è‚¡\n` +
                    `ä¹°å…¥é‡‘é¢ï¼?{buyAmount.toFixed(2)} å…ƒ\n\n` +
                    `å¸‚åœºçŠ¶æ€ï¼š${isBullMarket ? 'ç‰›å¸‚' : 'ç†Šå¸‚'}\n` +
                    `ç›®æ ‡ä»“ä½ï¼?{(targetPositionPct * 100).toFixed(0)}%\n` +
                    `å½“å‰ä»“ä½ï¼?{((positionValue / totalAssets) * 100).toFixed(1)}%\n\n` +
                    `ç³»ç»Ÿå°†è‡ªåŠ¨åº”ç”¨ä»¥ä¸‹è§„åˆ™ï¼š\n` +
                    `- ä»“ä½æ§åˆ¶ï¼šç‰›å¸?0%ï¼Œç†Šå¸?0%\n` +
                    `- å•åªè‚¡ç¥¨ä¸Šé™ï¼šæ€»èµ„äº§çš„20%\n` +
                    `- äº¤æ˜“æ•°é‡ï¼?00è‚¡æ•´æ•°å€`;
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                // æ‰§è¡Œä¹°å…¥æ“ä½œ
                const createPositionResponse = await fetch('/api/plan/position', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        name: name,
                        quantity: quantity,
                        cost_price: currentPrice
                    })
                });
                
                if (!createPositionResponse.ok) {
                    console.error(`åˆ›å»ºæŒä»“å¤±è´¥: ${createPositionResponse.status}`);
                    const errorData = await createPositionResponse.json();
                    const errorMsg = errorData.error || errorData.message || 'åˆ›å»ºæŒä»“å¤±è´¥';
                    alert(`ä¹°å…¥å¤±è´¥ï¼?{errorMsg}`);
                    return;
                }
                
                const positionResult = await createPositionResponse.json();
                
                if (createPositionResponse.ok && positionResult.message) {
                    const actualQuantity = positionResult.position ? positionResult.position.quantity : quantity;
                    const actualPrice = positionResult.position ? positionResult.position.cost_price : currentPrice;
                    const actualAmount = actualPrice * actualQuantity;
                    
                    // æ›´æ–°æœ¬åœ°å­˜å‚¨çš„å¯ç”¨èµ„é‡?                    const newAvailableCash = availableCash - actualAmount;
                    localStorage.setItem('availableCash', newAvailableCash.toString());
                    
                    alert(`ä¹°å…¥æˆåŠŸï¼\n\n` +
                        `è‚¡ç¥¨ï¼?{name} (${symbol})\n` +
                        `ä»·æ ¼ï¼?{actualPrice.toFixed(2)} å…ƒ\n` +
                        `æ•°é‡ï¼?{actualQuantity} è‚¡\n` +
                        `é‡‘é¢ï¼?{actualAmount.toFixed(2)} å…ƒ\n` +
                        `å‰©ä½™å¯ç”¨èµ„é‡‘ï¼?{newAvailableCash.toFixed(2)} å…ƒ\n\n` +
                        `ç³»ç»Ÿå·²è‡ªåŠ¨åº”ç”¨ä»“ä½æ§åˆ¶ç­–ç•¥`);
                    
                    // åˆ·æ–°æŒä»“åˆ†æ
                    await loadPositionAnalysis();
                    // åˆ·æ–°ä¹°å…¥å»ºè®®
                    await loadBuyStrategy();
                } else {
                    const errorMsg = positionResult.error || positionResult.message || 'æœªçŸ¥é”™è¯¯';
                    alert(`ä¹°å…¥å¤±è´¥ï¼?{errorMsg}`);
                    console.error('ä¹°å…¥å¤±è´¥:', positionResult);
                }
                
            } catch (error) {
                console.error('æ‰§è¡Œä¹°å…¥å¤±è´¥:', error);
                alert('ä¹°å…¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // æ‰§è¡Œå–å‡ºæ“ä½œ
        async function executeSell(symbol, name, actionText) {
            try {
                // è·å–å½“å‰æŒä»“æ•°æ®
                const positionResponse = await fetch('/api/plan/position');
                const positionData = await positionResponse.json();
                
                // æŸ¥æ‰¾è¦å–å‡ºçš„è‚¡ç¥¨
                const position = positionData.positions.find(pos => pos.symbol === symbol);
                if (!position) {
                    alert(`è‚¡ç¥¨ ${name} (${symbol}) ä¸åœ¨æŒä»“ä¸­`);
                    return;
                }
                
                const totalQuantity = parseInt(position.quantity);
                const currentPrice = parseFloat(position.current_price);
                const profitLossPercent = parseFloat(position.profit_loss_percent);
                
                // æ ¹æ®è°ƒä»“ç­–ç•¥è®¡ç®—å–å‡ºæ•°é‡
                let sellQuantity;
                let sellReason;
                
                if (actionText === 'æ­¢ç›ˆ' || actionText === 'æ­¢æŸ') {
                    // æ­¢ç›ˆæˆ–æ­¢æŸï¼šå–å‡ºå…¨éƒ¨æŒä»“
                    sellQuantity = totalQuantity;
                    sellReason = actionText;
                } else if (actionText === 'ç‰›è½¬ç†?) {
                    // ç‰›è½¬ç†Šï¼šå–å‡ºæŒä»“æ•°é‡çš?5/8ï¼ˆè‚¡æ•°å–æ•´ï¼Œ100çš„å€æ•°ï¼?                    const rawQuantity = Math.floor(totalQuantity * 5 / 8);
                    sellQuantity = Math.floor(rawQuantity / 100) * 100;
                    sellReason = 'ç‰›è½¬ç†?;
                }
                
                // ç¡®ä¿è‡³å°‘å–å‡º100è‚¡ï¼ˆå¦‚æœæ˜¯ç‰›è½¬ç†Šï¼?                if (actionText === 'ç‰›è½¬ç†? && sellQuantity < 100) {
                    sellQuantity = 100;
                }
                
                const sellAmount = currentPrice * sellQuantity;
                const profitLoss = (currentPrice - parseFloat(position.cost_price)) * sellQuantity;
                const remainingQuantity = totalQuantity - sellQuantity;
                
                const confirmMsg = `ç¡®è®¤å–å‡º ${name} (${symbol})ï¼Ÿ\n\nå–å‡ºåŸå› ï¼?{sellReason}\nå–å‡ºæ•°é‡ï¼?{sellQuantity} è‚¡ï¼ˆæ€»æŒä»?${totalQuantity} è‚¡ï¼‰\nå½“å‰ä»·æ ¼ï¼?{currentPrice.toFixed(2)} å…ƒ\nå–å‡ºé‡‘é¢ï¼?{sellAmount.toFixed(2)} å…ƒ\nç›ˆäºé‡‘é¢ï¼?{profitLoss.toFixed(2)} å…ƒ\nç›ˆäºæ¯”ä¾‹ï¼?{profitLossPercent.toFixed(2)}%\n\næ­¤æ“ä½œå°†ï¼š\n1. æŒ‰ç°ä»·å–å‡?${sellQuantity} è‚¡\n2. ${remainingQuantity > 0 ? 'æ›´æ–°æŒä»“ï¼Œå‰©ä½?' + remainingQuantity + ' è‚? : 'ä»æŒä»“ä¸­åˆ é™¤'}\n3. å¢åŠ å–å‡ºé‡‘é¢åˆ°å¯ç”¨èµ„é‡‘`;
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                let sellResult;
                
                if (remainingQuantity > 0) {
                    // è¿˜æœ‰å‰©ä½™è‚¡ç¥¨ï¼Œæ›´æ–°æŒä»?                    const updateResponse = await fetch(`/api/plan/position/${symbol}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            quantity: remainingQuantity
                        })
                    });
                    
                    sellResult = await updateResponse.json();
                } else {
                    // æ²¡æœ‰å‰©ä½™è‚¡ç¥¨ï¼Œåˆ é™¤æŒä»?                    const deleteResponse = await fetch(`/api/plan/position/${symbol}`, {
                        method: 'DELETE'
                    });
                    
                    sellResult = await deleteResponse.json();
                }
                
                if (sellResult.message) {
                    // è·å–å½“å‰å¯ç”¨èµ„é‡‘
                    let availableCash = 187500.00;
                    try {
                        const storedCash = localStorage.getItem('availableCash');
                        if (storedCash) {
                            availableCash = parseFloat(storedCash);
                        }
                    } catch (error) {
                        console.error('è¯»å–å¯ç”¨èµ„é‡‘å¤±è´¥:', error);
                    }
                    
                    // æ›´æ–°å¯ç”¨èµ„é‡‘
                    const newAvailableCash = availableCash + sellAmount;
                    localStorage.setItem('availableCash', newAvailableCash.toString());
                    
                    // è®°å½•å·²æ‰§è¡Œçš„è°ƒä»“å»ºè®®
                    try {
                        let executedAdjustments = [];
                        const stored = localStorage.getItem('executedAdjustments');
                        if (stored) {
                            executedAdjustments = JSON.parse(stored);
                        }
                        const key = `${symbol}_${actionText}`;
                        if (!executedAdjustments.includes(key)) {
                            executedAdjustments.push(key);
                            localStorage.setItem('executedAdjustments', JSON.stringify(executedAdjustments));
                        }
                    } catch (error) {
                        console.error('è®°å½•å·²æ‰§è¡Œçš„è°ƒä»“å»ºè®®å¤±è´¥:', error);
                    }
                    
                    alert(`å–å‡ºæˆåŠŸï¼\n\nè‚¡ç¥¨ï¼?{name} (${symbol})\nåŸå› ï¼?{sellReason}\nä»·æ ¼ï¼?{currentPrice.toFixed(2)} å…ƒ\nå–å‡ºæ•°é‡ï¼?{sellQuantity} è‚¡\nå‰©ä½™æ•°é‡ï¼?{remainingQuantity} è‚¡\nå–å‡ºé‡‘é¢ï¼?{sellAmount.toFixed(2)} å…ƒ\nç›ˆäºï¼?{profitLoss.toFixed(2)} å…?(${profitLossPercent.toFixed(2)}%)\n\nå¯ç”¨èµ„é‡‘ï¼?{newAvailableCash.toFixed(2)} å…ƒ`);
                    
                    // åˆ·æ–°æŒä»“åˆ†æ
                    await loadPositionAnalysis();
                    // åˆ·æ–°è°ƒä»“ç­–ç•¥
                    await loadAdjustmentStrategy();
                } else {
                    alert(`å–å‡ºå¤±è´¥ï¼?{sellResult.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
            } catch (error) {
                console.error('æ‰§è¡Œå–å‡ºå¤±è´¥:', error);
                alert('å–å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // åˆ·æ–°èµ„è®¯
        async function refreshNews() {
            const btn = event.target;
            btn.textContent = 'åˆ·æ–°ä¸?..';
            btn.disabled = true;
            
            try {
                await loadNews();
                btn.textContent = 'åˆ·æ–°';
                btn.disabled = false;
                alert('èµ„è®¯å·²æ›´æ–?);
            } catch (error) {
                console.error('åˆ·æ–°èµ„è®¯å¤±è´¥:', error);
                btn.textContent = 'åˆ·æ–°';
                btn.disabled = false;
                alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å¯¼å‡ºPDF
        async function exportPDF() {
            try {
                // ä»localStorageè·å–å¯ç”¨ç°é‡‘å’ŒåŸå§‹èµ„é‡?                let availableCash = 187500.00;
                let originalCash = 200000.00;
                
                try {
                    const storedAvailableCash = localStorage.getItem('availableCash');
                    if (storedAvailableCash) {
                        availableCash = parseFloat(storedAvailableCash);
                    }
                } catch (error) {
                    console.error('è¯»å–localStorageä¸­çš„å¯ç”¨ç°é‡‘å¤±è´¥:', error);
                }
                
                try {
                    const storedOriginalCash = localStorage.getItem('originalCash');
                    if (storedOriginalCash) {
                        originalCash = parseFloat(storedOriginalCash);
                    }
                } catch (error) {
                    console.error('è¯»å–localStorageä¸­çš„åŸå§‹èµ„é‡‘å¤±è´¥:', error);
                }
                
                // æ„å»ºè¯·æ±‚å‚æ•°
                const params = new URLSearchParams({
                    available_cash: availableCash,
                    original_cash: originalCash
                });
                
                const response = await fetch(`/api/plan/export-pdf?${params.toString()}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `æ¯æ—¥æ“ä½œè®¡åˆ’_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    alert('PDFå¯¼å‡ºæˆåŠŸ');
                } else {
                    const errorData = await response.json();
                    alert(`å¯¼å‡ºå¤±è´¥: ${errorData.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('å¯¼å‡ºPDFå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        let autoRefreshInterval = null;
        let dataUpdateInterval = 10;
        
        // åŠ è½½æ•°æ®æ›´æ–°é—´éš”é…ç½®
        function loadDataUpdateInterval() {
            fetch('/api/data-update/config')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('åŠ è½½æ•°æ®æ›´æ–°é—´éš”å¤±è´¥:', data.error);
                    } else {
                        dataUpdateInterval = data.update_interval || 10;
                        console.log('æ•°æ®æ›´æ–°é—´éš”:', dataUpdateInterval, 'åˆ†é’Ÿ');
                        setupAutoRefresh();
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ•°æ®æ›´æ–°é—´éš”å¤±è´¥:', error);
                });
        }
        
        // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                console.log('è‡ªåŠ¨åˆ·æ–°æ•°æ®...');
                refreshMarketStatus();
                refreshPositionAnalysis();
                refreshAdjustmentStrategy();
                refreshBuyStrategy();
                updateLastUpdateTime();
            }, dataUpdateInterval * 60 * 1000);
            
            console.log('è‡ªåŠ¨åˆ·æ–°å·²è®¾ç½®ï¼Œé—´éš”:', dataUpdateInterval, 'åˆ†é’Ÿ');
        }
        
        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—?        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdateTime').textContent = timeStr;
        }
        
        function checkLogin() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            loadDataUpdateInterval();
            updateLastUpdateTime();
        });
    </script>
</body>
</html>
