﻿﻿﻿<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日计划 - 量化交易系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            display: block;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            background-color: #667eea;
            color: white;
        }
        
        .nav-item:hover:not(.active) {
            background-color: #f0f0f0;
        }
        
        .section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title .refresh-btn {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        
        .section-title .refresh-btn:hover {
            background-color: #5a6fd8;
        }
        
        .card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-bull {
            background-color: #e8f5e9;
            color: #c62828;
        }
        
        .status-bear {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        
        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border: 1px solid #eee;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-value.positive {
            color: #f44336;
        }
        
        .stat-value.negative {
            color: #4caf50;
        }
        
        .text-positive {
            color: #f44336;
        }
        
        .text-negative {
            color: #4caf50;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background-color: #f9f9f9;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .news-item {
            padding: 15px;
            border-left: 3px solid #667eea;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .news-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .news-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }
        
        .news-content {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
        
        .action-list {
            list-style: none;
        }
        
        .action-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .action-item:last-child {
            border-bottom: none;
        }
        
        .action-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 15px;
            min-width: 60px;
            text-align: center;
        }
        
        .action-buy {
            background-color: #e8f5e9;
            color: #c62828;
        }
        
        .action-sell {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .action-hold {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .action-content {
            flex: 1;
        }
        
        .action-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .action-detail {
            font-size: 13px;
            color: #666;
        }
        
        .execute-btn {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .execute-btn:hover {
            background-color: #5a6fd8;
        }
        
        .execute-btn:active {
            background-color: #4c5fd6;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd8;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <div class="nav-bar">
            <div class="nav-item" data-page="home" onclick="window.location.href='index.html'">首页</div>
            <div class="nav-item active" data-page="plan">计划</div>
            <div class="nav-item" data-page="backtest" onclick="window.location.href='backtest.html'">回测</div>
            <div class="nav-item" data-page="prediction" onclick="window.location.href='prediction.html'">预测</div>
            <div class="nav-item" data-page="strategy" onclick="window.location.href='strategy.html'">策略</div>
            <div class="nav-item" data-page="settings" onclick="window.location.href='settings.html'">设置</div>
        </div>
        
        <!-- 头部 -->
        <div class="header" style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <span class="title">每日操作计划</span>
                <span class="subtitle">基于量化策略的智能交易决策支持</span>
                <div style="margin-top: 8px; font-size: 12px; opacity: 0.8;">
                    最后更新: <span id="lastUpdateTime">--</span>
                </div>
            </div>
            <button class="header-btn" onclick="exportPDF()">PDF</button>
        </div>
        
        <!-- 市场状态判断模块 -->
        <div class="section">
            <div class="section-title">
                市场状态判断
                <button class="refresh-btn" onclick="refreshMarketStatus()">刷新</button>
            </div>
            <div class="card">
                <div class="grid-2">
                    <div>
                        <div class="card-title">当前市场状态</div>
                        <div style="margin-top: 10px;">
                            <span class="stat-value" id="marketStatus">牛市</span>
                        </div>
                    </div>
                    <div>
                        <div class="card-title">建议仓位</div>
                        <div style="margin-top: 10px;">
                            <span class="stat-value" id="positionSuggestion">80%</span>
                        </div>
                    </div>
                </div>
                <div class="grid-2" style="margin-top: 20px;">
                    <div>
                        <div class="card-title">沪深300指数</div>
                        <div style="margin-top: 10px;">
                            <span class="stat-value" id="hs300Index">3850.23</span>
                        </div>
                    </div>
                    <div>
                        <div class="card-title">120日均线</div>
                        <div style="margin-top: 10px;">
                            <span class="stat-value" id="ma120">3760.50</span>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="marketChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 持仓分析模块 -->
        <div class="section">
            <div class="section-title">
                持仓分析
                <button class="refresh-btn" onclick="refreshPositionAnalysis()">刷新</button>
            </div>
            <div class="grid-5">
                <div class="stat-card">
                    <div class="stat-label">原始资金</div>
                    <div class="stat-value" id="originalCash">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">总资产</div>
                    <div class="stat-value" id="totalAssets">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">总盈亏</div>
                    <div class="stat-value" id="totalProfitLoss">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">持仓市值</div>
                    <div class="stat-value" id="positionValue">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">当前仓位</div>
                    <div class="stat-value" id="currentPosition">--</div>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">持仓明细</div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>股票代码</th>
                            <th>股票名称</th>
                            <th>持仓数量</th>
                            <th>成本价</th>
                            <th>现价</th>
                            <th>持仓金额</th>
                            <th>盈亏金额</th>
                            <th>盈亏比例</th>
                        </tr>
                    </thead>
                    <tbody id="positionTable">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #999;">暂无持仓数据</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 调仓策略模块 -->
        <div class="section">
            <div class="section-title">
                调仓策略
                <button class="refresh-btn" onclick="refreshAdjustStrategy()">刷新</button>
            </div>
            <div class="card">
                <div class="card-title">调仓规则</div>
                <div style="margin-top: 15px;">
                    <div style="margin-bottom: 10px;">
                        <strong>止盈规则：</strong>盈利达到10%时，触发止盈建议
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>止损规则：</strong>亏损达到4%时，触发止损建议
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>牛熊转换规则：</strong>牛市转熊市：仓位从80%降至30%
                    </div>
                    <div>
                        <strong>盘中调整：</strong>每30分钟检查一次持仓
                    </div>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">调仓建议</div>
                <ul class="action-list" id="adjustmentList">
                    <li class="action-item">
                        <span class="action-type action-sell">止盈</span>
                        <div class="action-content">
                            <div class="action-title">600519 贵州茅台</div>
                            <div class="action-detail">当前盈利12.3%，建议止盈部分仓位</div>
                        </div>
                    </li>
                    <li class="action-item">
                        <span class="action-type action-buy">买入</span>
                        <div class="action-content">
                            <div class="action-title">000858 五粮液</div>
                            <div class="action-detail">技术回调至关键支撑位，建议建仓</div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- 买入策略模块 -->
        <div class="section">
            <div class="section-title">
                买入策略
                <button class="refresh-btn" onclick="refreshBuyStrategy()">刷新</button>
            </div>
            <div class="card">
                <div class="card-title">买入条件</div>
                <div style="margin-top: 15px;">
                    <div style="margin-bottom: 10px;">
                        <strong>市场环境：</strong>整体处于牛市或熊市，无重大系统性风险
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>技术条件：</strong>目标股票处于上升趋势，出现健康的技术性回调
                    </div>
                    <div>
                        <strong>风险控制：</strong>单只股票仓位限制，买入价格区间控制，止损位预设
                    </div>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">买入建议</div>
                <ul class="action-list" id="buyList">
                </ul>
            </div>
        </div>
        
        <!-- 资讯整合模块 -->
        <div class="section">
            <div class="section-title">
                资讯整合
                <button class="refresh-btn" onclick="refreshNews()">刷新</button>
            </div>
            <div id="newsContainer">
                <div class="news-item">
                    <div class="news-title">央行：继续实施稳健货币政策</div>
                    <div class="news-time">2026-01-26 10:30</div>
                    <div class="news-content">央行表示将继续实施稳健的货币政策，保持流动性合理充裕，支持实体经济发展。</div>
                </div>
                <div class="news-item">
                    <div class="news-title">沪深300指数上涨1.2%</div>
                    <div class="news-time">2026-01-26 15:00</div>
                    <div class="news-content">今日沪深300指数收报3850点，上涨1.2%，成交额放大至3500亿元。</div>
                </div>
                <div class="news-item">
                    <div class="news-title">科技板块领涨市场</div>
                    <div class="news-time">2026-01-26 14:45</div>
                    <div class="news-content">科技板块今日表现强势，多只个股涨停，市场情绪明显回暖。</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadPlanData();
        });
        
        // 加载计划数据
        async function loadPlanData() {
            try {
                await Promise.all([
                    loadMarketStatus(),
                    loadPositionAnalysis(),
                    loadAdjustmentStrategy(),
                    loadBuyStrategy(),
                    loadNews()
                ]);
            } catch (error) {
                console.error('加载计划数据失败:', error);
            }
        }
        
        // 加载市场状态
        async function loadMarketStatus() {
            try {
                const response = await fetch('/api/plan/market-status');
                const data = await response.json();
                
                // 更新市场状态显示
                const statusBadge = document.getElementById('marketStatus');
                statusBadge.textContent = data.status_text;
                statusBadge.className = `stat-value ${data.status === 'bull' ? 'positive' : 'negative'}`;
                
                // 更新仓位建议
                document.getElementById('positionSuggestion').textContent = data.position_suggestion;
                
                // 更新沪深300指数和120日均线
                document.getElementById('hs300Index').textContent = data.hs300_index.toFixed(2);
                document.getElementById('ma120').textContent = data.ma120.toFixed(2);
                
                // 初始化图表
                initMarketChart(data.chart_data);
            } catch (error) {
                console.error('加载市场状态失败:', error);
            }
        }
        
        // 初始化市场状态图表
        function initMarketChart(chartData) {
            const ctx = document.getElementById('marketChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: '沪深300指数',
                            data: chartData.hs300,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: '120日均线',
                            data: chartData.ma120,
                            borderColor: '#ff9800',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        // 加载持仓分析
        async function loadPositionAnalysis() {
            try {
                // 优先从localStorage获取可用现金值
                let availableCashParam = '';
                try {
                    const storedCash = localStorage.getItem('availableCash');
                    if (storedCash) {
                        availableCashParam = `?available_cash=${storedCash}`;
                    }
                } catch (error) {
                    console.error('读取localStorage中的可用现金失败:', error);
                }
                
                // 优先从localStorage获取原始资金值
                let originalCashParam = '';
                try {
                    const storedCash = localStorage.getItem('originalCash');
                    console.log('从localStorage读取的原始资金:', storedCash);
                    if (storedCash) {
                        if (availableCashParam) {
                            originalCashParam = `&original_cash=${storedCash}`;
                        } else {
                            originalCashParam = `?original_cash=${storedCash}`;
                        }
                    }
                } catch (error) {
                    console.error('读取localStorage中的原始资金失败:', error);
                }
                
                console.log('可用现金参数:', availableCashParam);
                console.log('原始资金参数:', originalCashParam);
                
                // 反复读取数据直到现价数据正确
                let data = null;
                let retryCount = 0;
                const maxRetries = 10;
                const retryInterval = 1000; // 1秒
                
                while (retryCount < maxRetries) {
                    // 添加时间戳参数禁用缓存
                    const cacheBuster = `&_t=${Date.now()}`;
                    const response = await fetch(`/api/plan/position${availableCashParam}${originalCashParam}${cacheBuster}`, {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    data = await response.json();
                    console.log(`[DEBUG] 第 ${retryCount + 1} 次获取持仓数据:`, data);
                    
                    // 检查所有持仓的现价是否有效（不为0、不为null、不为undefined）
                    const allPricesValid = data.positions && data.positions.every(pos => 
                        pos.current_price !== null && 
                        pos.current_price !== undefined && 
                        pos.current_price > 0
                    );
                    
                    if (allPricesValid) {
                        console.log(`持仓数据读取成功，共尝试 ${retryCount + 1} 次`);
                        break;
                    } else {
                        console.warn(`第 ${retryCount + 1} 次读取：现价数据不完整，等待 ${retryInterval}ms 后重试...`);
                        retryCount++;
                        if (retryCount < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, retryInterval));
                        }
                    }
                }
                
                if (retryCount >= maxRetries) {
                    console.warn(`已达到最大重试次数 ${maxRetries}，使用最后一次读取的数据`);
                }
                
                // 更新总体概况
                const originalCash = localStorage.getItem('originalCash');
                console.log('从localStorage读取的原始资金:', originalCash);
                if (originalCash) {
                    document.getElementById('originalCash').textContent = formatCurrency(parseFloat(originalCash));
                } else {
                    document.getElementById('originalCash').textContent = '--';
                }
                
                document.getElementById('totalAssets').textContent = formatCurrency(data.total_assets);
                
                // 计算总盈亏：总盈亏 = 总资产 - 本页的原始资金数值
                const totalProfitLoss = originalCash ? data.total_assets - parseFloat(originalCash) : data.total_profit_loss;
                console.log('计算的总盈亏:', totalProfitLoss);
                
                const profitLossElement = document.getElementById('totalProfitLoss');
                profitLossElement.textContent = formatCurrency(totalProfitLoss);
                profitLossElement.className = `stat-value ${totalProfitLoss >= 0 ? 'positive' : 'negative'}`;
                
                document.getElementById('positionValue').textContent = formatCurrency(data.position_value);
                
                document.getElementById('currentPosition').textContent = data.current_position;
                
                // 更新持仓明细表格
                const tableBody = document.getElementById('positionTable');
                tableBody.innerHTML = data.positions.map(pos => {
                    const positionAmount = pos.quantity * pos.current_price;
                    return `
                    <tr>
                        <td>${pos.symbol}</td>
                        <td>${pos.name}</td>
                        <td>${pos.quantity}</td>
                        <td>${pos.cost_price.toFixed(2)}</td>
                        <td>${pos.current_price.toFixed(2)}</td>
                        <td style="font-weight: bold;">${formatCurrency(positionAmount)}</td>
                        <td class="${pos.profit_loss >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(pos.profit_loss)}</td>
                        <td class="${pos.profit_loss_percent >= 0 ? 'text-positive' : 'text-negative'}">${pos.profit_loss_percent.toFixed(2)}%</td>
                    </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('加载持仓分析失败:', error);
            }
        }
        
        // 加载调仓策略
        async function loadAdjustmentStrategy() {
            try {
                const response = await fetch('/api/plan/adjustment');
                const data = await response.json();
                
                // 获取已执行的调仓建议
                let executedAdjustments = [];
                try {
                    const stored = localStorage.getItem('executedAdjustments');
                    if (stored) {
                        executedAdjustments = JSON.parse(stored);
                    }
                } catch (error) {
                    console.error('读取已执行的调仓建议失败:', error);
                }
                
                // 更新调仓建议列表
                const adjustmentList = document.getElementById('adjustmentList');
                if (data.suggestions && data.suggestions.length > 0) {
                    // 过滤已执行的调仓建议
                    const filteredSuggestions = data.suggestions.filter(suggestion => {
                        const key = `${suggestion.symbol}_${suggestion.action_text}`;
                        return !executedAdjustments.includes(key);
                    });
                    
                    if (filteredSuggestions.length > 0) {
                        adjustmentList.innerHTML = filteredSuggestions.map(suggestion => {
                            // 只为卖出类型的建议添加执行按钮
                            const executeButton = suggestion.action === 'sell' ? 
                                `<button class="execute-btn" onclick="executeSell('${suggestion.symbol}', '${suggestion.name}', '${suggestion.action_text}')">执行</button>` : '';
                            
                            return `
                            <li class="action-item">
                                <span class="action-type action-${suggestion.action}">${suggestion.action_text}</span>
                                <div class="action-content">
                                    <div class="action-title">${suggestion.symbol} ${suggestion.name} ${suggestion.current_price !== undefined ? `- 当前价格: ¥${suggestion.current_price.toFixed(2)}` : ''}</div>
                                    <div class="action-detail">${suggestion.reason} - ${suggestion.detail}</div>
                                </div>
                                ${executeButton}
                            </li>
                            `;
                        }).join('');
                    } else {
                        // 当过滤后没有建议时，显示暂无
                        adjustmentList.innerHTML = `
                            <li class="action-item" style="justify-content: center; padding: 20px;">
                                <div class="action-content" style="text-align: center; color: #666;">
                                    暂无
                                </div>
                            </li>
                        `;
                    }
                } else {
                    // 当没有建议时，显示暂无
                    adjustmentList.innerHTML = `
                        <li class="action-item" style="justify-content: center; padding: 20px;">
                            <div class="action-content" style="text-align: center; color: #666;">
                                暂无
                            </div>
                        </li>
                    `;
                }
            } catch (error) {
                console.error('加载调仓策略失败:', error);
            }
        }
        
        // 加载买入策略
        async function loadBuyStrategy() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/plan/buy?_t=${timestamp}`);
                const data = await response.json();
                
                // 获取当前持仓列表，用于过滤已持仓的股票
                let heldSymbols = [];
                try {
                    const positionResponse = await fetch(`/api/plan/position?_t=${timestamp}`);
                    const positionData = await positionResponse.json();
                    if (positionData.positions && positionData.positions.length > 0) {
                        heldSymbols = positionData.positions.map(pos => pos.symbol);
                        console.log('已持仓股票代码:', heldSymbols);
                    }
                } catch (error) {
                    console.error('获取持仓数据失败:', error);
                }
                
                // 更新买入建议列表，剔除已持仓的股票
                const buyList = document.getElementById('buyList');
                if (data.suggestions && data.suggestions.length > 0) {
                    const filteredSuggestions = data.suggestions.filter(suggestion => !heldSymbols.includes(suggestion.symbol));
                    
                    if (filteredSuggestions.length > 0) {
                        buyList.innerHTML = filteredSuggestions.map(suggestion => {
                            // 只为买入类型的建议添加执行按钮
                            const executeButton = suggestion.action === 'buy' ? 
                                `<button class="execute-btn" onclick="executeBuy('${suggestion.symbol}', '${suggestion.name}', ${suggestion.price_range ? suggestion.price_range.split('-')[1] : 0})">执行</button>` : '';
                            
                            return `
                            <li class="action-item">
                                <span class="action-type action-${suggestion.action}">${suggestion.action_text}</span>
                                <div class="action-content">
                                    <div class="action-title">${suggestion.symbol} ${suggestion.name} ${suggestion.current_price !== undefined ? `- 当前价格: ¥${suggestion.current_price.toFixed(2)}` : ''}</div>
                                    <div class="action-detail">${suggestion.reason} ${suggestion.price_range ? `- 建议价格区间：${suggestion.price_range}元，止损位：${suggestion.stop_loss}元` : ''}</div>
                                </div>
                                ${executeButton}
                            </li>
                            `;
                        }).join('');
                    } else {
                        // 当过滤后没有建议时，显示提示信息
                        buyList.innerHTML = `
                            <li class="action-item" style="justify-content: center; padding: 20px;">
                                <div class="action-content" style="text-align: center; color: #666;">
                                    暂无买入建议（已过滤持仓股票）
                                </div>
                            </li>
                        `;
                    }
                } else {
                    // 当没有建议时，显示提示信息
                    buyList.innerHTML = `
                        <li class="action-item" style="justify-content: center; padding: 20px;">
                            <div class="action-content" style="text-align: center; color: #666;">
                                暂无买入建议
                            </div>
                        </li>
                    `;
                }
            } catch (error) {
                console.error('加载买入策略失败:', error);
            }
        }
        
        // 加载资讯
        async function loadNews() {
            try {
                const response = await fetch('/api/plan/news');
                const data = await response.json();
                
                // 更新资讯列表
                const newsContainer = document.getElementById('newsContainer');
                newsContainer.innerHTML = data.news.map(news => `
                    <div class="news-item">
                        <div class="news-title">${news.title}</div>
                        <div class="news-time">${news.time} - ${news.source}</div>
                        <div class="news-content">${news.content}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载资讯失败:', error);
            }
        }
        
        // 格式化货币
        function formatCurrency(value) {
            return '¥' + value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // 刷新市场状态
        async function refreshMarketStatus() {
            const btn = event.target;
            btn.textContent = '刷新中...';
            btn.disabled = true;
            
            try {
                await loadMarketStatus();
                alert('市场状态已更新');
            } catch (error) {
                console.error('刷新市场状态失败:', error);
                alert('刷新失败，请稍后重试');
            } finally {
                btn.textContent = '刷新';
                btn.disabled = false;
            }
        }
        
        // 刷新持仓分析
        async function refreshPositionAnalysis() {
            const btn = event.target;
            btn.textContent = '刷新中...';
            btn.disabled = true;
            
            try {
                await loadPositionAnalysis();
                alert('持仓分析已更新');
            } catch (error) {
                console.error('刷新持仓分析失败:', error);
                alert('刷新失败，请稍后重试');
            } finally {
                btn.textContent = '刷新';
                btn.disabled = false;
            }
        }
        
        // 刷新调仓策略
        async function refreshAdjustStrategy() {
            const btn = event.target;
            btn.textContent = '刷新中...';
            btn.disabled = true;
            
            try {
                await loadAdjustmentStrategy();
                alert('调仓策略已更新');
            } catch (error) {
                console.error('刷新调仓策略失败:', error);
                alert('刷新失败，请稍后重试');
            } finally {
                btn.textContent = '刷新';
                btn.disabled = false;
            }
        }
        
        // 刷新买入策略
        async function refreshBuyStrategy() {
            const btn = event.target;
            btn.textContent = '刷新中...';
            btn.disabled = true;
            
            try {
                await loadBuyStrategy();
                alert('买入策略已更新');
            } catch (error) {
                console.error('刷新买入策略失败:', error);
                alert('刷新失败，请稍后重试');
            } finally {
                btn.textContent = '刷新';
                btn.disabled = false;
            }
        }
        
        // 执行买入操作
        async function executeBuy(symbol, name, suggestedPrice) {
            try {
                // 获取股票当前价格
                const response = await fetch(`/api/stocks/kline?symbol=${symbol}&start_date=2026-01-01`);
                
                if (!response.ok) {
                    console.error(`获取 ${symbol} 价格失败: ${response.status}`);
                    alert(`获取股票价格失败，请稍后重试`);
                    return;
                }
                
                const data = await response.json();
                
                let currentPrice = suggestedPrice;
                if (data && data.kline && data.kline.length > 0) {
                    currentPrice = data.kline[data.kline.length - 1].close;
                    console.log(`获取到 ${symbol} 的最新价格: ${currentPrice}`);
                } else {
                    console.warn(`无法获取 ${symbol} 的最新价格，使用建议价格: ${suggestedPrice}`);
                    currentPrice = suggestedPrice;
                }
                
                // 获取市场状态
                const marketStatusResponse = await fetch('/api/plan/market-status');
                
                if (!marketStatusResponse.ok) {
                    console.error(`获取市场状态失败: ${marketStatusResponse.status}`);
                    alert(`获取市场状态失败，请稍后重试`);
                    return;
                }
                
                const marketStatusData = await marketStatusResponse.json();
                const isBullMarket = marketStatusData.status === 'bull';
                const targetPositionPct = isBullMarket ? 0.8 : 0.3;
                
                // 获取当前持仓数据
                const positionResponse = await fetch('/api/plan/position');
                
                if (!positionResponse.ok) {
                    console.error(`获取持仓数据失败: ${positionResponse.status}`);
                    alert(`获取持仓数据失败，请稍后重试`);
                    return;
                }
                
                const positionData = await positionResponse.json();
                const positions = positionData.positions || [];
                
                // 使用后端返回的可用资金
                let availableCash = positionData.available_cash || 187500.00;
                
                // 更新localStorage以保持同步
                try {
                    localStorage.setItem('availableCash', availableCash.toString());
                } catch (error) {
                    console.error('更新localStorage失败:', error);
                }
                
                let positionValue = 0;
                positions.forEach(pos => {
                    positionValue += parseFloat(pos.quantity) * parseFloat(pos.current_price);
                });
                
                const totalAssets = availableCash + positionValue;
                
                // 计算目标持仓市值
                const targetPositionValue = totalAssets * targetPositionPct;
                
                // 检查当前仓位是否已超过目标仓位
                if (positionValue >= targetPositionValue) {
                    alert(`当前仓位已达到目标仓位${(targetPositionPct * 100).toFixed(0)}%，无法继续买入`);
                    return;
                }
                
                // 计算可用买入金额
                const availableBuyAmount = Math.min(availableCash, targetPositionValue - positionValue);
                
                // 单只股票持仓上限控制：不超过总资产的20%
                const maxSingleStockValue = totalAssets * 0.2;
                
                // 检查是否已存在相同股票
                const existingPosition = positions.find(pos => pos.symbol === symbol);
                let availableForStock;
                
                if (existingPosition) {
                    const existingValue = parseFloat(existingPosition.quantity) * currentPrice;
                    if (existingValue >= maxSingleStockValue) {
                        alert(`股票 ${symbol} 已达到单只股票持仓上限20%`);
                        return;
                    }
                    availableForStock = Math.min(availableBuyAmount, maxSingleStockValue - existingValue);
                } else {
                    availableForStock = Math.min(availableBuyAmount, maxSingleStockValue);
                }
                
                // 计算买入数量（必须是100的整数倍）
                let maxQuantity = Math.floor(availableForStock / currentPrice);
                maxQuantity = Math.floor(maxQuantity / 100) * 100;
                
                // 确保至少买入100股
                if (maxQuantity < 100) {
                    alert(`可用资金不足，无法买入100股`);
                    return;
                }
                
                const quantity = maxQuantity;
                const buyAmount = currentPrice * quantity;
                
                // 显示确认对话框
                const confirmMsg = `确认买入 ${name} (${symbol})？\n\n` +
                    `当前价格：${currentPrice.toFixed(2)} 元\n` +
                    `建议价格：${suggestedPrice} 元\n` +
                    `买入数量：${quantity} 股\n` +
                    `买入金额：${buyAmount.toFixed(2)} 元\n\n` +
                    `市场状态：${isBullMarket ? '牛市' : '熊市'}\n` +
                    `目标仓位：${(targetPositionPct * 100).toFixed(0)}%\n` +
                    `当前仓位：${((positionValue / totalAssets) * 100).toFixed(1)}%\n\n` +
                    `系统将自动应用以下规则：\n` +
                    `- 仓位控制：牛市80%，熊市30%\n` +
                    `- 单只股票上限：总资产的20%\n` +
                    `- 交易数量：100股整数倍`;
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                // 执行买入操作
                const createPositionResponse = await fetch('/api/plan/position', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        name: name,
                        quantity: quantity,
                        cost_price: currentPrice
                    })
                });
                
                if (!createPositionResponse.ok) {
                    console.error(`创建持仓失败: ${createPositionResponse.status}`);
                    const errorData = await createPositionResponse.json();
                    const errorMsg = errorData.error || errorData.message || '创建持仓失败';
                    alert(`买入失败：${errorMsg}`);
                    return;
                }
                
                const positionResult = await createPositionResponse.json();
                
                if (createPositionResponse.ok && positionResult.message) {
                    const actualQuantity = positionResult.position ? positionResult.position.quantity : quantity;
                    const actualPrice = positionResult.position ? positionResult.position.cost_price : currentPrice;
                    const actualAmount = actualPrice * actualQuantity;
                    
                    // 更新本地存储的可用资金
                    const newAvailableCash = availableCash - actualAmount;
                    localStorage.setItem('availableCash', newAvailableCash.toString());
                    
                    alert(`买入成功！\n\n` +
                        `股票：${name} (${symbol})\n` +
                        `价格：${actualPrice.toFixed(2)} 元\n` +
                        `数量：${actualQuantity} 股\n` +
                        `金额：${actualAmount.toFixed(2)} 元\n` +
                        `剩余可用资金：${newAvailableCash.toFixed(2)} 元\n\n` +
                        `系统已自动应用仓位控制策略`);
                    
                    // 刷新持仓分析
                    await loadPositionAnalysis();
                    // 刷新买入建议
                    await loadBuyStrategy();
                } else {
                    const errorMsg = positionResult.error || positionResult.message || '未知错误';
                    alert(`买入失败：${errorMsg}`);
                    console.error('买入失败:', positionResult);
                }
                
            } catch (error) {
                console.error('执行买入失败:', error);
                alert('买入失败，请稍后重试');
            }
        }
        
        // 执行卖出操作
        async function executeSell(symbol, name, actionText) {
            try {
                // 获取当前持仓数据
                const positionResponse = await fetch('/api/plan/position');
                const positionData = await positionResponse.json();
                
                // 查找要卖出的股票
                const position = positionData.positions.find(pos => pos.symbol === symbol);
                if (!position) {
                    alert(`股票 ${name} (${symbol}) 不在持仓中`);
                    return;
                }
                
                const totalQuantity = parseInt(position.quantity);
                const currentPrice = parseFloat(position.current_price);
                const profitLossPercent = parseFloat(position.profit_loss_percent);
                
                // 根据调仓策略计算卖出数量
                let sellQuantity;
                let sellReason;
                
                if (actionText === '止盈' || actionText === '止损') {
                    // 止盈或止损：卖出全部持仓
                    sellQuantity = totalQuantity;
                    sellReason = actionText;
                } else if (actionText === '牛转熊') {
                    // 牛转熊：卖出持仓数量的 5/8（股数取整，100的倍数）
                    const rawQuantity = Math.floor(totalQuantity * 5 / 8);
                    sellQuantity = Math.floor(rawQuantity / 100) * 100;
                    sellReason = '牛转熊';
                }
                
                // 确保至少卖出100股（如果是牛转熊）
                if (actionText === '牛转熊' && sellQuantity < 100) {
                    sellQuantity = 100;
                }
                
                const sellAmount = currentPrice * sellQuantity;
                const profitLoss = (currentPrice - parseFloat(position.cost_price)) * sellQuantity;
                const remainingQuantity = totalQuantity - sellQuantity;
                
                const confirmMsg = `确认卖出 ${name} (${symbol})？\n\n卖出原因：${sellReason}\n卖出数量：${sellQuantity} 股（总持仓 ${totalQuantity} 股）\n当前价格：${currentPrice.toFixed(2)} 元\n卖出金额：${sellAmount.toFixed(2)} 元\n盈亏金额：${profitLoss.toFixed(2)} 元\n盈亏比例：${profitLossPercent.toFixed(2)}%\n\n此操作将：\n1. 按现价卖出 ${sellQuantity} 股\n2. ${remainingQuantity > 0 ? '更新持仓，剩余 ' + remainingQuantity + ' 股' : '从持仓中删除'}\n3. 增加卖出金额到可用资金`;
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                let sellResult;
                
                if (remainingQuantity > 0) {
                    // 还有剩余股票，更新持仓
                    const updateResponse = await fetch(`/api/plan/position/${symbol}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            quantity: remainingQuantity
                        })
                    });
                    
                    sellResult = await updateResponse.json();
                } else {
                    // 没有剩余股票，删除持仓
                    const deleteResponse = await fetch(`/api/plan/position/${symbol}`, {
                        method: 'DELETE'
                    });
                    
                    sellResult = await deleteResponse.json();
                }
                
                if (sellResult.message) {
                    // 获取当前可用资金
                    let availableCash = 187500.00;
                    try {
                        const storedCash = localStorage.getItem('availableCash');
                        if (storedCash) {
                            availableCash = parseFloat(storedCash);
                        }
                    } catch (error) {
                        console.error('读取可用资金失败:', error);
                    }
                    
                    // 更新可用资金
                    const newAvailableCash = availableCash + sellAmount;
                    localStorage.setItem('availableCash', newAvailableCash.toString());
                    
                    // 记录已执行的调仓建议
                    try {
                        let executedAdjustments = [];
                        const stored = localStorage.getItem('executedAdjustments');
                        if (stored) {
                            executedAdjustments = JSON.parse(stored);
                        }
                        const key = `${symbol}_${actionText}`;
                        if (!executedAdjustments.includes(key)) {
                            executedAdjustments.push(key);
                            localStorage.setItem('executedAdjustments', JSON.stringify(executedAdjustments));
                        }
                    } catch (error) {
                        console.error('记录已执行的调仓建议失败:', error);
                    }
                    
                    alert(`卖出成功！\n\n股票：${name} (${symbol})\n原因：${sellReason}\n价格：${currentPrice.toFixed(2)} 元\n卖出数量：${sellQuantity} 股\n剩余数量：${remainingQuantity} 股\n卖出金额：${sellAmount.toFixed(2)} 元\n盈亏：${profitLoss.toFixed(2)} 元 (${profitLossPercent.toFixed(2)}%)\n\n可用资金：${newAvailableCash.toFixed(2)} 元`);
                    
                    // 刷新持仓分析
                    await loadPositionAnalysis();
                    // 刷新调仓策略
                    await loadAdjustmentStrategy();
                } else {
                    alert(`卖出失败：${sellResult.message || '未知错误'}`);
                }
                
            } catch (error) {
                console.error('执行卖出失败:', error);
                alert('卖出失败，请稍后重试');
            }
        }
        
        // 刷新资讯
        async function refreshNews() {
            const btn = event.target;
            btn.textContent = '刷新中...';
            btn.disabled = true;
            
            try {
                await loadNews();
                btn.textContent = '刷新';
                btn.disabled = false;
                alert('资讯已更新');
            } catch (error) {
                console.error('刷新资讯失败:', error);
                btn.textContent = '刷新';
                btn.disabled = false;
                alert('刷新失败，请重试');
            }
        }
        
        // 导出PDF
        async function exportPDF() {
            try {
                // 从localStorage获取可用现金和原始资金
                let availableCash = 187500.00;
                let originalCash = 200000.00;
                
                try {
                    const storedAvailableCash = localStorage.getItem('availableCash');
                    if (storedAvailableCash) {
                        availableCash = parseFloat(storedAvailableCash);
                    }
                } catch (error) {
                    console.error('读取localStorage中的可用现金失败:', error);
                }
                
                try {
                    const storedOriginalCash = localStorage.getItem('originalCash');
                    if (storedOriginalCash) {
                        originalCash = parseFloat(storedOriginalCash);
                    }
                } catch (error) {
                    console.error('读取localStorage中的原始资金失败:', error);
                }
                
                // 构建请求参数
                const params = new URLSearchParams({
                    available_cash: availableCash,
                    original_cash: originalCash
                });
                
                const response = await fetch(`/api/plan/export-pdf?${params.toString()}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `每日操作计划_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    alert('PDF导出成功');
                } else {
                    const errorData = await response.json();
                    alert(`导出失败: ${errorData.error || '未知错误'}`);
                }
            } catch (error) {
                console.error('导出PDF失败:', error);
                alert('导出失败，请稍后重试');
            }
        }
        
        // 自动刷新功能
        let autoRefreshInterval = null;
        let dataUpdateInterval = 10;
        
        // 加载数据更新间隔配置
        function loadDataUpdateInterval() {
            fetch('/api/data-update/config')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('加载数据更新间隔失败:', data.error);
                    } else {
                        dataUpdateInterval = data.update_interval || 10;
                        console.log('数据更新间隔:', dataUpdateInterval, '分钟');
                        setupAutoRefresh();
                    }
                })
                .catch(error => {
                    console.error('加载数据更新间隔失败:', error);
                });
        }
        
        // 设置自动刷新
        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                console.log('自动刷新数据...');
                refreshMarketStatus();
                refreshPositionAnalysis();
                refreshAdjustmentStrategy();
                refreshBuyStrategy();
                updateLastUpdateTime();
            }, dataUpdateInterval * 60 * 1000);
            
            console.log('自动刷新已设置，间隔:', dataUpdateInterval, '分钟');
        }
        
        // 更新最后更新时间
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdateTime').textContent = timeStr;
        }
        
        function checkLogin() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html';
            }
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            loadDataUpdateInterval();
            updateLastUpdateTime();
        });
    </script>
</body>
</html>
