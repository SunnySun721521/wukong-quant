﻿﻿﻿﻿﻿﻿<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统设置 - 量化交易系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            display: block;
        }
        
        .nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            background-color: #667eea;
            color: white;
        }
        
        .nav-item:hover:not(.active) {
            background-color: #f0f0f0;
        }
        
        .settings-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
        }
        
        .form-checkbox input {
            margin-right: 10px;
        }
        
        .settings-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab-item {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-item.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stock-pool {
            margin-top: 15px;
        }
        
        .stock-pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stock-pool-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        
        .stock-pool-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd8;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .stock-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        
        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
        }
        
        .stock-item:hover {
            background-color: #f5f5f5;
        }
        
        .stock-info {
            display: flex;
            align-items: center;
        }
        
        .stock-symbol {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-right: 10px;
        }
        
        .stock-name {
            font-size: 12px;
            color: #666;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn-large {
            padding: 12px 30px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header .title {
                font-size: 24px;
            }
            
            .nav-bar {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .nav-item {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .settings-tabs {
                overflow-x: auto;
            }
            
            .tab-item {
                white-space: nowrap;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn-large {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <div class="nav-bar">
            <div class="nav-item" data-page="home" onclick="window.location.href='index.html'">首页</div>
            <div class="nav-item" data-page="plan" onclick="window.location.href='plan.html'">计划</div>
            <div class="nav-item" data-page="backtest" onclick="window.location.href='backtest.html'">回测</div>
            <div class="nav-item" data-page="prediction" onclick="window.location.href='prediction.html'">预测</div>
            <div class="nav-item" data-page="strategy" onclick="window.location.href='strategy.html'">策略</div>
            <div class="nav-item active" data-page="settings">设置</div>
        </div>
        
        <!-- 头部 -->
        <div class="header">
            <span class="title">系统设置</span>
            <span class="subtitle">系统配置与参数调整</span>
        </div>
        
        <!-- 设置内容 -->
        <div class="settings-section">
            <!-- 设置选项卡 -->
            <div class="settings-tabs">
                <div class="tab-item active" data-tab="general">通用设置</div>
                <div class="tab-item" data-tab="data">数据设置</div>
                <div class="tab-item" data-tab="strategy">策略设置</div>
                <div class="tab-item" data-tab="stock_pool">股票池管理</div>
                <div class="tab-item" data-tab="position">持仓管理</div>
                <div class="tab-item" data-tab="scheduler">定时任务</div>
            </div>
            
            <!-- 通用设置 -->
            <div class="tab-content active" id="general">
                <div class="form-group">
                    <label class="form-label">系统语言</label>
                    <select class="form-control" id="systemLanguage">
                        <option value="zh-CN">简体中文</option>
                        <option value="en-US">English</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">时区</label>
                    <select class="form-control" id="timezone">
                        <option value="Asia/Shanghai">中国标准时间</option>
                        <option value="America/New_York">美国东部时间</option>
                        <option value="Europe/London">英国标准时间</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">界面主题</label>
                    <select class="form-control" id="theme">
                        <option value="light">浅色主题</option>
                        <option value="dark">深色主题</option>
                    </select>
                </div>
                
                <div class="form-group form-checkbox">
                    <input type="checkbox" id="autoUpdate">
                    <label for="autoUpdate">自动检查更新</label>
                </div>
                
                <div class="form-group form-checkbox">
                    <input type="checkbox" id="enableNotification">
                    <label for="enableNotification">启用通知</label>
                </div>
            </div>
            
            <!-- 数据设置 -->
            <div class="tab-content" id="data">
                <div class="form-group">
                    <label class="form-label">数据来源</label>
                    <select class="form-control" id="dataSource">
                        <option value="efinance">efinance (A股)</option>
                        <option value="yfinance">yfinance (美股)</option>
                        <option value="tushare">Tushare (A股)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">缓存有效期 (秒)</label>
                    <input type="number" class="form-control" id="cacheExpiry" value="3600" min="60" max="86400">
                </div>
                
                <div class="form-group form-checkbox">
                    <input type="checkbox" id="enableCache">
                    <label for="enableCache">启用数据缓存</label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">数据更新频率 (分钟)</label>
                    <input type="number" class="form-control" id="updateFrequency" value="30" min="1" max="1440">
                </div>
            </div>
            
            <!-- 策略设置 -->
            <div class="tab-content" id="strategy">
                <div class="form-group">
                    <label class="form-label">默认策略</label>
                    <select class="form-control" id="defaultStrategy">
                        <option value="moving_average">移动平均线策略</option>
                        <option value="mean_reversion">均值回归策略</option>
                        <option value="momentum">动量策略</option>
                        <option value="breakout">突破策略</option>
                        <option value="niu_huicai" selected>牛回测策略</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">默认初始资金</label>
                    <input type="number" class="form-control" id="defaultInitialCash" value="1000000" min="10000" step="10000">
                </div>
                
                <div class="form-group">
                    <label class="form-label">默认交易成本 (‰)</label>
                    <input type="number" class="form-control" id="defaultTransactionCost" value="0.3" min="0" max="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">默认回测周期</label>
                    <select class="form-control" id="defaultBacktestPeriod">
                        <option value="1y">1年</option>
                        <option value="2y">2年</option>
                        <option value="3y">3年</option>
                        <option value="5y">5年</option>
                    </select>
                </div>
                
                <hr>
                
                <h3>策略参数</h3>
                
                <div class="form-group">
                    <label class="form-label">PE阈值</label>
                    <input type="number" class="form-control" id="peThreshold" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ROE阈值</label>
                    <input type="number" class="form-control" id="roeThreshold" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">短期均线</label>
                    <input type="number" class="form-control" id="smaShort" min="1" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">长期均线</label>
                    <input type="number" class="form-control" id="smaLong" min="1" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">仓位比例 (%)</label>
                    <input type="number" class="form-control" id="position_pct" min="0" max="100" step="1">
                </div>
            </div>
            
            <!-- 股票池管理 -->
            <div class="tab-content" id="stock_pool">
                <div class="stock-pool">
                    <div class="stock-pool-header">
                        <div class="stock-pool-title">默认股票池</div>
                        <div class="stock-pool-actions">
                            <button class="btn btn-primary" onclick="importStockPool()">导入</button>
                            <button class="btn btn-secondary" onclick="exportStockPool()">导出</button>
                            <button class="btn btn-secondary" onclick="addStock()">添加</button>
                            <button class="btn btn-info" onclick="updateStockNames()">映射表</button>
                            <button class="btn btn-danger" onclick="clearStockPool()">清空</button>
                        </div>
                    </div>
                    
                    <div class="stock-list">
                        <div class="stock-item">
                            <div class="stock-info">
                                <span class="stock-symbol">000001</span>
                                <span class="stock-name">平安银行</span>
                            </div>
                            <button class="btn btn-secondary" onclick="removeStock('000001')">删除</button>
                        </div>
                        <div class="stock-item">
                            <div class="stock-info">
                                <span class="stock-symbol">600519</span>
                                <span class="stock-name">贵州茅台</span>
                            </div>
                            <button class="btn btn-secondary" onclick="removeStock('600519')">删除</button>
                        </div>
                        <div class="stock-item">
                            <div class="stock-info">
                                <span class="stock-symbol">000858</span>
                                <span class="stock-name">五粮液</span>
                            </div>
                            <button class="btn btn-secondary" onclick="removeStock('000858')">删除</button>
                        </div>
                        <div class="stock-item">
                            <div class="stock-info">
                                <span class="stock-symbol">601318</span>
                                <span class="stock-name">中国平安</span>
                            </div>
                            <button class="btn btn-secondary" onclick="removeStock('601318')">删除</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 持仓管理 -->
            <div class="tab-content" id="position">
                <div class="stock-pool">
                    <div class="stock-pool-header">
                        <div class="stock-pool-title">持仓管理</div>
                        <div class="stock-pool-actions">
                            <button class="btn btn-primary" onclick="initPositionTable()">初始化持仓表</button>
                            <button class="btn btn-secondary" onclick="addPosition()">添加持仓</button>
                            <button class="btn btn-info" onclick="loadPositions()">刷新</button>
                        </div>
                    </div>
                    
                    <!-- 资产概览 -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">原始资金</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;" id="originalCash">--</div>
                            <div style="margin-top: 10px;">
                                <input type="number" id="customOriginalCash" placeholder="自定义原始资金" style="width: 80%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" step="0.01" min="0">
                                <button class="btn btn-secondary" onclick="updateOriginalCash()" style="margin-top: 5px; font-size: 12px; padding: 3px 8px;">更新</button>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">总资产</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;" id="totalAssets">--</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">持仓市值</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;" id="positionValue">--</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">可用现金</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;" id="availableCash">--</div>
                            <div style="margin-top: 10px;">
                                <input type="number" id="customAvailableCash" placeholder="自定义现金" style="width: 80%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" step="0.01" min="0">
                                <button class="btn btn-secondary" onclick="updateAvailableCash()" style="margin-top: 5px; font-size: 12px; padding: 3px 8px;">更新</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stock-list" id="position-list">
                        <!-- 持仓列表将通过JavaScript动态加载 -->
                        <div style="text-align: center; color: #666; padding: 20px;">请点击"刷新"按钮加载持仓数据</div>
                    </div>
                </div>
            </div>
            
            <!-- 定时任务 -->
            <div class="tab-content" id="scheduler">
                <div style="display: flex; gap: 20px; align-items: flex-start;">
                    <!-- 左侧：PDF自动导出定时任务 -->
                    <div style="flex: 1;">
                        <div class="section-title">PDF自动导出定时任务</div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">任务状态</div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 16px; font-weight: bold; color: #333;" id="schedulerStatus">加载中...</div>
                                <button class="btn btn-primary" onclick="startScheduler()">启动</button>
                                <button class="btn btn-secondary" onclick="stopScheduler()">停止</button>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">执行时间设置</div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 15px;">定时任务仅在工作日（周一至周五）执行</div>
                            
                            <div id="scheduledTimesList" style="margin-bottom: 15px;">
                                <!-- 定时时间列表将通过JavaScript动态加载 -->
                            </div>
                            
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                                <select class="form-control" id="newHour" style="width: 100px;">
                                    <option value="0">00</option>
                                    <option value="1">01</option>
                                    <option value="2">02</option>
                                    <option value="3">03</option>
                                    <option value="4">04</option>
                                    <option value="5">05</option>
                                    <option value="6">06</option>
                                    <option value="7">07</option>
                                    <option value="8">08</option>
                                    <option value="9">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12" selected>12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                    <option value="21">21</option>
                                    <option value="22">22</option>
                                    <option value="23">23</option>
                                </select>
                                <span style="font-size: 16px; color: #666;">:</span>
                                <select class="form-control" id="newMinute" style="width: 100px;">
                                    <option value="0" selected>00</option>
                                    <option value="5">05</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                    <option value="35">35</option>
                                    <option value="40">40</option>
                                    <option value="45">45</option>
                                    <option value="50">50</option>
                                    <option value="55">55</option>
                                </select>
                                <button class="btn btn-primary" onclick="addScheduledTime()">添加时间</button>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">最近执行记录</div>
                            <div id="schedulerLogs" style="font-size: 12px; color: #999;">
                                暂无执行记录
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">邮件发送配置</div>
                            
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <label style="font-size: 12px; color: #666;">邮件发送功能:</label>
                                <select class="form-control" id="emailEnabled" style="width: 100px;" onchange="toggleEmailConfig()">
                                    <option value="false">禁用</option>
                                    <option value="true">启用</option>
                                </select>
                            </div>
                            
                            <div id="emailConfigArea" style="display: none;">
                                <div style="margin-bottom: 15px;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">发送邮箱地址:</label>
                                    <div style="display: flex; gap: 5px;">
                                        <input type="text" class="form-control" id="senderEmail" placeholder="请输入QQ邮箱地址" style="flex: 1;">
                                        <span style="font-size: 14px; color: #666; align-self: center;">@qq.com</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">邮箱授权码:</label>
                                    <div style="display: flex; gap: 5px;">
                                        <input type="password" class="form-control" id="senderAuthCode" placeholder="请输入邮箱授权码" style="flex: 1;">
                                        <button class="btn btn-secondary" onclick="toggleAuthCodeVisibility()" style="padding: 5px 10px;">显示</button>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">接收邮箱列表:</label>
                                    <div id="recipientsList" style="margin-bottom: 10px; max-height: 200px; overflow-y: auto;">
                                        <!-- 接收人列表将通过JavaScript动态加载 -->
                                    </div>
                                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                        <input type="email" class="form-control" id="newRecipient" placeholder="请输入接收邮箱地址" style="flex: 1;">
                                        <input type="text" class="form-control" id="newRecipientName" placeholder="姓名（可选）" style="flex: 1;">
                                        <button class="btn btn-primary" onclick="addRecipient()">添加</button>
                                    </div>
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        <button class="btn btn-secondary" onclick="showImportModal()" style="padding: 5px 10px; font-size: 12px;">导入</button>
                                        <button class="btn btn-secondary" onclick="exportRecipients()" style="padding: 5px 10px; font-size: 12px;">导出</button>
                                        <button class="btn btn-danger" onclick="showClearRecipientsModal()" style="padding: 5px 10px; font-size: 12px;">清空</button>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">邮件模板:</label>
                                    <select class="form-control" id="emailTemplate">
                                        <option value="simple">简洁版</option>
                                        <option value="detailed">详细版</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <button class="btn btn-primary" onclick="saveEmailConfig()">保存邮件配置</button>
                                    <button class="btn btn-secondary" onclick="sendTestEmail()">发送测试邮件</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧：数据自动更新配置 -->
                    <div style="flex: 1;">
                        <div class="section-title">数据自动更新配置</div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">数据自动更新配置</div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 15px;">自动更新计划页面中的市场状态判断、持仓分析、调仓策略、买入策略数据</div>
                            
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; color: #666;">更新间隔（分钟）:</label>
                                    <select class="form-control" id="dataUpdateInterval" style="width: 150px;">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="15">15</option>
                                        <option value="20">20</option>
                                        <option value="30">30</option>
                                        <option value="60">60</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="saveDataUpdateConfig()">保存数据更新配置</button>
                            </div>
                            
                            <div style="font-size: 12px; color: #999; margin-bottom: 10px;">上次更新时间: <span id="lastDataUpdateTime" style="color: #27ae60; font-weight: 500;">--</span></div>
                            
                            <div id="dataUpdateLogs" style="max-height: 200px; overflow-y: auto; font-size: 11px; color: #999;">
                                <!-- 数据更新日志将通过JavaScript动态加载 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 按钮组 -->
            <div class="button-group">
                <button class="btn btn-primary btn-large" onclick="saveSettings()">保存设置</button>
                <button class="btn btn-secondary btn-large" onclick="resetSettings()">恢复默认</button>
            </div>
        </div>
    </div>
    
    <script>
        // 全局股票名称映射表（优先从localStorage加载）
        let globalStockNames = (function() {
            try {
                const stored = localStorage.getItem('stockNames');
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (error) {
                console.error('解析localStorage中的股票名称映射表失败:', error);
            }
            // 默认股票名称映射（当localStorage中没有数据时使用）
            return {
                '300308': '中际旭创',
                '603000': '人民网',
                '300502': '新易盛',
                '300274': '阳光电源',
                '002371': '北方华创',
                '300750': '宁德时代',
                '601899': '紫金矿业',
                '600519': '贵州茅台',
                '000858': '五粮液',
                '000333': '美的集团',
                '000651': '格力电器',
                '600031': '三一重工',
                '000002': '万科A',
                '601988': '中国银行',
                '601288': '农业银行',
                '601398': '工商银行',
                '600000': '浦发银行',
                '601166': '兴业银行',
                '600016': '民生银行',
                '601818': '光大银行',
                '601628': '中国人寿',
                '601336': '新华保险',
                '601601': '中国太保',
                '600030': '中信证券',
                '601688': '华泰证券',
                '601211': '国泰君安',
                '600837': '海通证券',
                '601901': '方正证券',
                '000568': '泸州老窖',
                '600809': '山西汾酒',
                '000799': '酒鬼酒',
                '000001': '平安银行',
                '600036': '招商银行',
                '600276': '恒瑞医药',
                '601888': '中国中免',
                '600887': '伊利股份',
                '601318': '中国平安',
                '301269': '华大九天',
                '688981': '中芯国际',
                '688599': '天合光能',
                '688396': '华润微',
                '601766': '中国中车',
                '600157': '永泰能源',
                '688256': '寒武纪',
                '300563': '神宇股份',
                '002079': '苏州固锝'
            };
        })();
        
        function checkLogin() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html';
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            // 选项卡切换
            document.querySelectorAll('.tab-item').forEach(item => {
                item.addEventListener('click', function() {
                    // 移除所有活动状态
                    document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // 添加当前活动状态
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // 如果切换到股票池管理选项卡，加载股票池数据
                    if (tabId === 'stock_pool') {
                        loadStockPool();
                    }
                });
            });
            
            // 加载设置
            loadSettings();
        });
        
        // 加载设置
        function loadSettings() {
            console.log('加载设置');
            
            // 从后端加载通用设置
            fetch('/api/general/settings')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('通用设置:', data);
                    
                    // 将通用设置应用到表单
                    if (data.systemLanguage) {
                        document.getElementById('systemLanguage').value = data.systemLanguage;
                    }
                    if (data.timezone) {
                        document.getElementById('timezone').value = data.timezone;
                    }
                    if (data.theme) {
                        document.getElementById('theme').value = data.theme;
                    }
                    if (data.autoUpdate !== undefined) {
                        document.getElementById('autoUpdate').checked = data.autoUpdate;
                    }
                    if (data.enableNotification !== undefined) {
                        document.getElementById('enableNotification').checked = data.enableNotification;
                    }
                })
                .catch(error => {
                    console.error('加载通用设置失败:', error);
                    console.error('错误详情:', error.message);
                });
            
            // 从后端加载策略参数
            fetch('/api/strategy/params')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('策略参数:', data);
                    
                    // 将策略参数应用到表单
                    if (data.peThreshold) {
                        document.getElementById('peThreshold').value = data.peThreshold;
                    }
                    if (data.roeThreshold) {
                        document.getElementById('roeThreshold').value = data.roeThreshold;
                    }
                    if (data.smaShort) {
                        document.getElementById('smaShort').value = data.smaShort;
                    }
                    if (data.smaLong) {
                        document.getElementById('smaLong').value = data.smaLong;
                    }
                    if (data.position_pct) {
                        document.getElementById('position_pct').value = data.position_pct;
                    }
                })
                .catch(error => {
                    console.error('加载策略参数失败:', error);
                    console.error('错误详情:', error.message);
                });
            
            // 从后端加载数据设置
            fetch('/api/data/settings')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('数据设置:', data);
                    
                    // 将数据设置应用到表单
                    if (data.dataSource) {
                        document.getElementById('dataSource').value = data.dataSource;
                    }
                    if (data.cacheExpiry) {
                        document.getElementById('cacheExpiry').value = data.cacheExpiry;
                    }
                    if (data.enableCache !== undefined) {
                        document.getElementById('enableCache').checked = data.enableCache;
                    }
                    if (data.updateFrequency) {
                        document.getElementById('updateFrequency').value = data.updateFrequency;
                    }
                })
                .catch(error => {
                    console.error('加载数据设置失败:', error);
                    console.error('错误详情:', error.message);
                });
        }
        
        // 保存设置
        function saveSettings() {
            console.log('保存设置');
            
            // 从表单获取通用设置
            const generalSettings = {
                systemLanguage: document.getElementById('systemLanguage').value,
                timezone: document.getElementById('timezone').value,
                theme: document.getElementById('theme').value,
                autoUpdate: document.getElementById('autoUpdate').checked,
                enableNotification: document.getElementById('enableNotification').checked
            };
            
            // 从表单获取数据设置
            const dataSettings = {
                dataSource: document.getElementById('dataSource').value,
                cacheExpiry: parseInt(document.getElementById('cacheExpiry').value),
                enableCache: document.getElementById('enableCache').checked,
                updateFrequency: parseInt(document.getElementById('updateFrequency').value)
            };
            
            console.log('通用设置:', generalSettings);
            console.log('数据设置:', dataSettings);
            
            // 保存通用设置到后端
            fetch('/api/general/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(generalSettings)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error, status = ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('保存通用设置结果:', data);
                
                // 保存数据设置到后端
                return fetch('/api/data/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataSettings)
                });
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error, status = ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('保存数据设置结果:', data);
                alert('设置保存成功');
            })
            .catch(error => {
                console.error('保存设置失败:', error);
                console.error('错误详情:', error.message);
                console.error('错误堆栈:', error.stack);
                alert('设置保存失败，请检查网络连接。错误详情: ' + error.message);
            });
        }
        
        // 恢复默认设置
        function resetSettings() {
            if (confirm('确定要恢复默认设置吗？')) {
                console.log('恢复默认设置');
                // 这里可以添加恢复默认设置的逻辑
                alert('默认设置已恢复');
            }
        }
        
        // 加载股票池
        function loadStockPool() {
            console.log('加载股票池');
            fetch('/api/stockpool/info')
                .then(response => response.json())
                .then(data => {
                    console.log('股票池数据:', data);
                    
                    // 注意：映射表内容只能在系统设置的股票池管理里的映射表功能修改
                    // 此处不再从后端更新映射表，确保用户修改的映射表不会被覆盖
                    
                    updateStockList(data.current_pool);
                })
                .catch(error => {
                    console.error('加载股票池失败:', error);
                    alert('加载股票池失败，请检查网络连接');
                });
        }
        
        // 更新股票列表
        function updateStockList(stocks) {
            const stockList = document.querySelector('.stock-list');
            stockList.innerHTML = '';
            
            if (stocks.length === 0) {
                stockList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">股票池为空</div>';
                return;
            }
            
            stocks.forEach(symbol => {
                const stockItem = document.createElement('div');
                stockItem.className = 'stock-item';
                
                // 获取股票名称
                let stockName = '未知股票';
                
                // 检查是否在全局股票名称映射表中
                if (globalStockNames[symbol]) {
                    stockName = globalStockNames[symbol];
                } else {
                    // 尝试通过股票代码的前几位判断类型
                    const prefix = symbol.substring(0, 1);
                    const prefix3 = symbol.substring(0, 3);
                    
                    if (prefix3 === '688') {
                        stockName = `科创板股票 (${symbol})`;
                    } else if (prefix === '6') {
                        stockName = `沪市股票 (${symbol})`;
                    } else if (prefix === '0') {
                        stockName = `深市股票 (${symbol})`;
                    } else if (prefix === '3') {
                        stockName = `创业板股票 (${symbol})`;
                    } else if (prefix === '8') {
                        stockName = `北交所股票 (${symbol})`;
                    } else {
                        stockName = `未知股票 (${symbol})`;
                    }
                }
                
                stockItem.innerHTML = `
                    <div class="stock-info">
                        <span class="stock-symbol">${symbol}</span>
                        <span class="stock-name">${stockName}</span>
                    </div>
                    <button class="btn btn-secondary" onclick="removeStock('${symbol}')">删除</button>
                `;
                
                stockList.appendChild(stockItem);
            });
        }
        
        // 导入股票池
        function importStockPool() {
            console.log('导入股票池');
            
            // 创建文件输入元素
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.txt';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const content = event.target.result;
                        let stocks;
                        
                        // 尝试解析JSON
                        try {
                            const data = JSON.parse(content);
                            stocks = Array.isArray(data) ? data : data.stocks || [];
                        } catch (jsonError) {
                            // 尝试解析文本文件（每行一个股票代码）
                            stocks = content.split('\n')
                                .map(line => line.trim())
                                .filter(line => line && /^\d{6}$/.test(line));
                        }
                        
                        if (!stocks || stocks.length === 0) {
                            alert('文件中没有有效的股票代码');
                            return;
                        }
                        
                        // 调用后端API更新股票池，设置adjust: false以保留所有导入的股票
                        fetch('/api/stockpool/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ stocks: stocks, adjust: false })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('导入股票池结果:', data);
                            if (data.error) {
                                alert(`导入失败: ${data.error}`);
                            } else {
                                alert(`导入成功: 共导入 ${stocks.length} 只股票`);
                                loadStockPool(); // 重新加载股票池
                            }
                        })
                        .catch(error => {
                            console.error('导入股票池失败:', error);
                            alert('导入股票池失败，请检查网络连接');
                        });
                    } catch (error) {
                        console.error('文件解析失败:', error);
                        alert('文件解析失败，请确保文件格式正确');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // 导出股票池
        function exportStockPool() {
            console.log('导出股票池');
            
            // 获取股票池数据
            fetch('/api/stockpool/info')
                .then(response => response.json())
                .then(data => {
                    const stocks = data.current_pool || [];
                    
                    if (!stocks || stocks.length === 0) {
                        alert('股票池为空，无需导出');
                        return;
                    }
                    
                    // 准备导出数据
                    const exportData = {
                        stocks: stocks,
                        last_updated: new Date().toISOString(),
                        pool_size: stocks.length
                    };
                    
                    // 创建JSON字符串
                    const jsonString = JSON.stringify(exportData, null, 2);
                    
                    // 创建Blob对象
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    
                    // 创建下载链接
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `stock_pool_${new Date().toISOString().split('T')[0]}.json`;
                    
                    // 触发下载
                    document.body.appendChild(a);
                    a.click();
                    
                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    console.log('股票池导出成功:', stocks.length, '只股票');
                })
                .catch(error => {
                    console.error('导出股票池失败:', error);
                    alert('导出股票池失败，请检查网络连接');
                });
        }
        
        // 清空股票池
        function clearStockPool() {
            if (confirm('确定要清空股票池吗？此操作不可撤销。')) {
                console.log('清空股票池');
                
                // 调用后端API清空股票池
                fetch('/api/stockpool/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('清空股票池结果:', data);
                    if (data.error) {
                        alert(`清空失败: ${data.error}`);
                    } else {
                        alert(`清空成功: ${data.message}`);
                        loadStockPool(); // 重新加载股票池
                    }
                })
                .catch(error => {
                    console.error('清空股票池失败:', error);
                    alert('清空股票池失败，请检查网络连接');
                });
            }
        }
        
        // 打开股票名称映射表编辑模态框
        function updateStockNames() {
            console.log('打开股票名称映射表编辑');
            
            // 创建模态框
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                width: 80%;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            `;
            
            // 模态框标题
            const modalTitle = document.createElement('h2');
            modalTitle.textContent = '编辑股票名称映射表';
            modalTitle.style.marginBottom = '20px';
            modalContent.appendChild(modalTitle);
            
            // 搜索和添加区域
            const searchAddArea = document.createElement('div');
            searchAddArea.style.cssText = `
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                padding: 15px;
                background: #f5f5f5;
                border-radius: 8px;
                flex-wrap: wrap;
            `;
            
            // 搜索输入
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = '搜索股票代码或名称';
            searchInput.style.flex = '1';
            searchInput.style.minWidth = '200px';
            searchInput.style.padding = '10px';
            searchInput.style.border = '1px solid #ddd';
            searchInput.style.borderRadius = '4px';
            searchAddArea.appendChild(searchInput);
            
            // 导入按钮
            const importButton = document.createElement('button');
            importButton.textContent = '导入';
            importButton.style.cssText = `
                padding: 10px 20px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            importButton.onclick = function() {
                importMappings();
            };
            searchAddArea.appendChild(importButton);
            
            // 导出按钮
            const exportButton = document.createElement('button');
            exportButton.textContent = '导出';
            exportButton.style.cssText = `
                padding: 10px 20px;
                background: #17a2b8;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            exportButton.onclick = function() {
                exportMappings();
            };
            searchAddArea.appendChild(exportButton);
            
            // 批量删除按钮
            const batchDeleteButton = document.createElement('button');
            batchDeleteButton.textContent = '批量删除';
            batchDeleteButton.style.cssText = `
                padding: 10px 20px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            batchDeleteButton.onclick = function() {
                batchDeleteMappings();
            };
            searchAddArea.appendChild(batchDeleteButton);
            
            // 添加按钮
            const addButton = document.createElement('button');
            addButton.textContent = '添加映射';
            addButton.style.cssText = `
                padding: 10px 20px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            addButton.onclick = function() {
                addNewMapping();
            };
            searchAddArea.appendChild(addButton);
            modalContent.appendChild(searchAddArea);
            
            // 映射表容器
            const mappingContainer = document.createElement('div');
            mappingContainer.id = 'mappingContainer';
            mappingContainer.style.cssText = `
                display: grid;
                grid-template-columns: 150px 1fr 100px;
                gap: 10px;
                margin-bottom: 20px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 8px;
            `;
            
            // 表头
            const headerCode = document.createElement('div');
            headerCode.textContent = '股票代码';
            headerCode.style.fontWeight = 'bold';
            headerCode.style.padding = '10px';
            headerCode.style.background = '#f0f0f0';
            mappingContainer.appendChild(headerCode);
            
            const headerName = document.createElement('div');
            headerName.textContent = '股票名称';
            headerName.style.fontWeight = 'bold';
            headerName.style.padding = '10px';
            headerName.style.background = '#f0f0f0';
            mappingContainer.appendChild(headerName);
            
            const headerAction = document.createElement('div');
            headerAction.textContent = '操作';
            headerAction.style.fontWeight = 'bold';
            headerAction.style.padding = '10px';
            headerAction.style.background = '#f0f0f0';
            mappingContainer.appendChild(headerAction);
            
            // 填充当前映射表
            Object.entries(globalStockNames).forEach(([code, name]) => {
                addMappingRow(mappingContainer, code, name);
            });
            
            modalContent.appendChild(mappingContainer);
            
            // 按钮区域
            const buttonArea = document.createElement('div');
            buttonArea.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: flex-end;
                margin-top: 20px;
            `;
            
            // 保存按钮
            const saveButton = document.createElement('button');
            saveButton.textContent = '保存更改';
            saveButton.style.cssText = `
                padding: 12px 30px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
                font-size: 14px;
            `;
            saveButton.onclick = function() {
                saveMappingChanges();
                document.body.removeChild(modal);
            };
            buttonArea.appendChild(saveButton);
            
            // 取消按钮
            const cancelButton = document.createElement('button');
            cancelButton.textContent = '取消';
            cancelButton.style.cssText = `
                padding: 12px 30px;
                background: #f0f0f0;
                color: #333;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
                font-size: 14px;
            `;
            cancelButton.onclick = function() {
                document.body.removeChild(modal);
            };
            buttonArea.appendChild(cancelButton);
            modalContent.appendChild(buttonArea);
            
            // 关闭模态框
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 添加新映射
            function addNewMapping() {
                const newCode = prompt('请输入股票代码:');
                if (newCode && /^\d{6}$/.test(newCode)) {
                    if (!globalStockNames[newCode]) {
                        const newName = prompt('请输入股票名称:');
                        if (newName) {
                            globalStockNames[newCode] = newName;
                            addMappingRow(mappingContainer, newCode, newName);
                        }
                    } else {
                        alert('该股票代码已存在映射');
                    }
                } else {
                    alert('请输入有效的6位股票代码');
                }
            }
            
            // 添加映射行
            function addMappingRow(container, code, name) {
                // 代码输入
                const codeInput = document.createElement('input');
                codeInput.type = 'text';
                codeInput.value = code;
                codeInput.style.padding = '8px';
                codeInput.style.border = '1px solid #ddd';
                codeInput.style.borderRadius = '4px';
                codeInput.style.fontSize = '14px';
                container.appendChild(codeInput);
                
                // 名称输入
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = name;
                nameInput.style.padding = '8px';
                nameInput.style.border = '1px solid #ddd';
                nameInput.style.borderRadius = '4px';
                nameInput.style.fontSize = '14px';
                container.appendChild(nameInput);
                
                // 删除按钮
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '删除';
                deleteButton.style.cssText = `
                    padding: 8px 12px;
                    background: #ff4757;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                `;
                deleteButton.onclick = function() {
                    delete globalStockNames[code];
                    container.removeChild(codeInput);
                    container.removeChild(nameInput);
                    container.removeChild(deleteButton);
                };
                container.appendChild(deleteButton);
            }
            
            // 保存映射更改
            function saveMappingChanges() {
                const inputs = mappingContainer.querySelectorAll('input');
                const newMappings = {};
                
                for (let i = 0; i < inputs.length; i += 2) {
                    const code = inputs[i].value.trim();
                    const name = inputs[i + 1].value.trim();
                    if (code && name && /^\d{6}$/.test(code)) {
                        newMappings[code] = name;
                    }
                }
                
                // 清空旧映射表并更新
                Object.keys(globalStockNames).forEach(key => {
                    delete globalStockNames[key];
                });
                Object.assign(globalStockNames, newMappings);
                console.log('股票名称映射表已更新:', globalStockNames);
                
                // 保存到localStorage，以便其他页面（如回测页面）可以使用
                try {
                    localStorage.setItem('stockNames', JSON.stringify(globalStockNames));
                    console.log('股票名称映射表已保存到localStorage');
                } catch (error) {
                    console.error('保存到localStorage失败:', error);
                }
                
                // 更新股票列表显示
                loadStockPool();
                
                alert('股票名称映射表更新成功');
            }
            
            // 导入映射表
            function importMappings() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.txt';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        let importCount = 0;
                        
                        lines.forEach(line => {
                            line = line.trim();
                            if (!line) return;
                            
                            const parts = line.split(/[,\t，]+/);
                            if (parts.length >= 2) {
                                const code = parts[0].trim();
                                const name = parts[1].trim();
                                
                                if (/^\d{6}$/.test(code) && name) {
                                    globalStockNames[code] = name;
                                    importCount++;
                                }
                            }
                        });
                        
                        // 清空并重新填充映射表
                        while (mappingContainer.children.length > 3) {
                            mappingContainer.removeChild(mappingContainer.lastChild);
                            mappingContainer.removeChild(mappingContainer.lastChild);
                            mappingContainer.removeChild(mappingContainer.lastChild);
                        }
                        
                        Object.entries(globalStockNames).forEach(([code, name]) => {
                            addMappingRow(mappingContainer, code, name);
                        });
                        
                        alert(`成功导入 ${importCount} 条映射数据`);
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
            
            // 导出映射表
            function exportMappings() {
                const mappings = Object.entries(globalStockNames);
                if (mappings.length === 0) {
                    alert('映射表为空，无法导出');
                    return;
                }
                
                let csvContent = '股票代码,股票名称\n';
                mappings.forEach(([code, name]) => {
                    csvContent += `${code},${name}\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', '股票名称映射表.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // 批量删除映射
            function batchDeleteMappings() {
                const codesToDelete = prompt('请输入要删除的股票代码，多个代码用逗号分隔：');
                if (!codesToDelete) return;
                
                const codes = codesToDelete.split(/[,，\s]+/).filter(code => /^\d{6}$/.test(code));
                
                if (codes.length === 0) {
                    alert('未输入有效的股票代码');
                    return;
                }
                
                let deletedCount = 0;
                codes.forEach(code => {
                    if (globalStockNames[code]) {
                        delete globalStockNames[code];
                        deletedCount++;
                    }
                });
                
                // 清空并重新填充映射表
                while (mappingContainer.children.length > 3) {
                    mappingContainer.removeChild(mappingContainer.lastChild);
                    mappingContainer.removeChild(mappingContainer.lastChild);
                    mappingContainer.removeChild(mappingContainer.lastChild);
                }
                
                Object.entries(globalStockNames).forEach(([code, name]) => {
                    addMappingRow(mappingContainer, code, name);
                });
                
                alert(`成功删除 ${deletedCount} 条映射数据`);
            }
        }
        
        // 添加股票
        function addStock() {
            const symbol = prompt('请输入股票代码');
            if (symbol) {
                console.log('添加股票:', symbol);
                
                // 验证股票代码格式
                if (!/^\d{6}$/.test(symbol)) {
                    alert('股票代码格式错误，请输入6位数字');
                    return;
                }
                
                // 调用后端API添加股票
                fetch('/api/stockpool/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stock_code: symbol })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('添加股票结果:', data);
                    if (data.error) {
                        alert(`添加失败: ${data.error}`);
                    } else {
                        alert(`添加成功: ${data.message}`);
                        loadStockPool(); // 重新加载股票池
                    }
                })
                .catch(error => {
                    console.error('添加股票失败:', error);
                    console.error('错误详情:', error.message);
                    alert('添加股票失败，请检查网络连接。错误详情: ' + error.message);
                });
            }
        }
        
        // 移除股票
        function removeStock(symbol) {
            if (confirm(`确定要从股票池中移除 ${symbol} 吗？`)) {
                console.log('移除股票:', symbol);
                
                // 调用后端API移除股票
                fetch('/api/stockpool/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stock_code: symbol })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('移除股票结果:', data);
                    if (data.error) {
                        alert(`移除失败: ${data.error}`);
                    } else {
                        alert(`移除成功: ${data.message}`);
                        loadStockPool(); // 重新加载股票池
                    }
                })
                .catch(error => {
                    console.error('移除股票失败:', error);
                    console.error('错误详情:', error.message);
                    alert('移除股票失败，请检查网络连接。错误详情: ' + error.message);
                });
            }
        }
        
        // 初始化持仓表
        function initPositionTable() {
            const warningMessage = '⚠️ 警告：此操作将清空现有持仓数据并创建默认持仓！\n\n' +
                                  '默认持仓包含以下股票：\n' +
                                  '• 600519 贵州茅台\n' +
                                  '• 000858 五粮液\n' +
                                  '• 002371 北方华创\n\n' +
                                  '注意：这些默认股票可能不在您的股票池中！\n\n' +
                                  '确定要继续吗？';
            
            if (confirm(warningMessage)) {
                const secondConfirm = '再次确认：您确定要清空所有持仓并创建默认数据吗？\n\n此操作不可撤销！';
                if (confirm(secondConfirm)) {
                    console.log('初始化持仓表');
                    
                    // 调用后端API初始化持仓表
                    fetch('/api/plan/position/init', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('HTTP error, status = ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('初始化持仓表结果:', data);
                        if (data.error) {
                            alert(`初始化失败: ${data.error}`);
                        } else {
                            alert(`初始化成功: ${data.message}`);
                            loadPositions(); // 重新加载持仓数据
                        }
                    })
                    .catch(error => {
                        console.error('初始化持仓表失败:', error);
                        console.error('错误详情:', error.message);
                        alert('初始化持仓表失败，请检查网络连接。错误详情: ' + error.message);
                    });
                }
            }
        }
        
        // 加载持仓数据
        function loadPositions() {
            console.log('加载持仓数据');
            
            // 从后端获取现金配置
            fetch('/api/config/available_cash')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(config => {
                    console.log('从后端读取的现金配置:', config);
                    
                    // 更新localStorage
                    localStorage.setItem('availableCash', config.available_cash.toString());
                    localStorage.setItem('originalCash', config.original_cash.toString());
                    
                    // 更新输入框的值
                    document.getElementById('customAvailableCash').value = config.available_cash;
                    
                    // 构建请求参数
                    const availableCashParam = `?available_cash=${config.available_cash}`;
                    const originalCashParam = `&original_cash=${config.original_cash}`;
                    
                    console.log('可用现金参数:', availableCashParam);
                    console.log('原始资金参数:', originalCashParam);
                    
                    // 添加时间戳避免缓存
                    const timestamp = new Date().getTime();
                    
                    // 调用后端API获取持仓数据
                    const url = `/api/plan/position${availableCashParam}${originalCashParam}&_t=${timestamp}`;
                    console.log('完整URL:', url);
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('HTTP error, status = ' + response.status);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('持仓数据:', data);
                            
                            // 更新资产概览
                            document.getElementById('originalCash').textContent = formatCurrency(data.original_cash || 200000.00);
                            document.getElementById('totalAssets').textContent = formatCurrency(data.total_assets);
                            document.getElementById('positionValue').textContent = formatCurrency(data.position_value);
                            document.getElementById('availableCash').textContent = formatCurrency(data.available_cash);
                            
                            updatePositionList(data.positions);
                        })
                        .catch(error => {
                            console.error('加载持仓数据失败:', error);
                            console.error('错误详情:', error.message);
                            alert('加载持仓数据失败，请检查网络连接。错误详情: ' + error.message);
                        });
                })
                .catch(error => {
                    console.error('加载现金配置失败:', error);
                    // 出错时使用localStorage的值
                    loadPositionsWithLocalStorage();
                });
        }
        
        // 格式化货币
        function formatCurrency(value) {
            return '¥' + value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // 使用localStorage加载持仓数据（备用方案）
        function loadPositionsWithLocalStorage() {
            console.log('使用localStorage加载持仓数据');
            
            // 优先从localStorage获取可用现金值
            let availableCashParam = '';
            try {
                const storedCash = localStorage.getItem('availableCash');
                console.log('从localStorage读取的可用现金:', storedCash);
                if (storedCash) {
                    availableCashParam = `?available_cash=${storedCash}`;
                    // 更新输入框的值
                    document.getElementById('customAvailableCash').value = storedCash;
                } else {
                    // 获取自定义可用现金值
                    const customCash = document.getElementById('customAvailableCash').value;
                    console.log('从输入框获取的可用现金:', customCash);
                    availableCashParam = customCash ? `?available_cash=${customCash}` : '';
                }
            } catch (error) {
                console.error('读取localStorage中的可用现金失败:', error);
                // 出错时使用输入框的值
                const customCash = document.getElementById('customAvailableCash').value;
                availableCashParam = customCash ? `?available_cash=${customCash}` : '';
            }
            
            console.log('可用现金参数:', availableCashParam);
            
            // 优先从localStorage获取原始资金值
            let originalCashParam = '';
            try {
                const storedCash = localStorage.getItem('originalCash');
                console.log('从localStorage读取的原始资金:', storedCash);
                if (storedCash) {
                    if (availableCashParam) {
                        originalCashParam = `&original_cash=${storedCash}`;
                    } else {
                        originalCashParam = `?original_cash=${storedCash}`;
                    }
                    // 更新输入框的值
                    document.getElementById('customOriginalCash').value = storedCash;
                } else {
                    // 获取自定义原始资金值
                    const customCash = document.getElementById('customOriginalCash').value;
                    console.log('从输入框获取的原始资金:', customCash);
                    if (customCash) {
                        if (availableCashParam) {
                            originalCashParam = `&original_cash=${customCash}`;
                        } else {
                            originalCashParam = `?original_cash=${customCash}`;
                        }
                    }
                }
            } catch (error) {
                console.error('读取localStorage中的原始资金失败:', error);
                // 出错时使用输入框的值
                const customCash = document.getElementById('customOriginalCash').value;
                if (customCash) {
                    if (availableCashParam) {
                        originalCashParam = `&original_cash=${customCash}`;
                    } else {
                        originalCashParam = `?original_cash=${customCash}`;
                    }
                }
            }
            
            console.log('原始资金参数:', originalCashParam);
            
            // 添加时间戳避免缓存
            const timestamp = new Date().getTime();
            
            // 调用后端API获取持仓数据
            const url = `/api/plan/position${availableCashParam}${originalCashParam}&_t=${timestamp}`;
            console.log('完整URL:', url);
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('持仓数据:', data);
                    
                    // 更新资产概览
                    document.getElementById('totalAssets').textContent = data.total_assets ? data.total_assets.toFixed(2) : '--';
                    document.getElementById('positionValue').textContent = data.position_value ? data.position_value.toFixed(2) : '--';
                    document.getElementById('availableCash').textContent = data.available_cash ? data.available_cash.toFixed(2) : '--';
                    
                    // 直接从localStorage读取并显示原始资金
                    const originalCash = localStorage.getItem('originalCash');
                    console.log('从localStorage读取的原始资金:', originalCash);
                    if (originalCash) {
                        document.getElementById('originalCash').textContent = parseFloat(originalCash).toFixed(2);
                        document.getElementById('customOriginalCash').value = originalCash;
                    } else {
                        document.getElementById('originalCash').textContent = '--';
                    }
                    
                    updatePositionList(data.positions);
                })
                .catch(error => {
                    console.error('加载持仓数据失败:', error);
                    console.error('错误详情:', error.message);
                    alert('加载持仓数据失败，请检查网络连接。错误详情: ' + error.message);
                });
        }
        
        // 更新可用现金
        function updateAvailableCash() {
            const customCash = document.getElementById('customAvailableCash').value;
            if (customCash) {
                // 保存到localStorage
                localStorage.setItem('availableCash', customCash);
                
                // 保存到后端配置文件
                const originalCash = localStorage.getItem('originalCash') || 200000.00;
                fetch('/api/config/available_cash', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        available_cash: parseFloat(customCash),
                        original_cash: parseFloat(originalCash)
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('现金配置已保存到后端:', data);
                    alert('可用现金已更新');
                })
                .catch(error => {
                    console.error('保存现金配置失败:', error);
                    alert('保存现金配置失败，但已更新本地显示');
                });
            }
            loadPositions();
        }
        
        // 更新原始资金
        function updateOriginalCash() {
            const customCash = document.getElementById('customOriginalCash').value;
            // 保存到localStorage
            if (customCash) {
                localStorage.setItem('originalCash', customCash);
            }
            loadPositions();
        }
        
        // 更新持仓列表
        function updatePositionList(positions) {
            const positionList = document.getElementById('position-list');
            positionList.innerHTML = '';
            
            if (!positions || positions.length === 0) {
                positionList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">持仓表为空</div>';
                return;
            }
            
            positions.forEach(position => {
                const positionItem = document.createElement('div');
                positionItem.className = 'stock-item';
                
                const positionAmount = position.quantity * position.current_price;
                
                positionItem.innerHTML = `
                    <div class="stock-info">
                        <span class="stock-symbol">${position.symbol}</span>
                        <span class="stock-name">${position.name}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: #666;">数量: ${position.quantity}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: #666;">成本: ${position.cost_price.toFixed(2)}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: #666;">现价: ${position.current_price.toFixed(2)}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: #666; font-weight: bold;">持仓金额: ${positionAmount.toFixed(2)}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: ${position.profit_loss >= 0 ? '#e74c3c' : '#27ae60'};">盈亏: ${position.profit_loss.toFixed(2)}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: ${position.profit_loss_percent >= 0 ? '#e74c3c' : '#27ae60'};">${position.profit_loss_percent.toFixed(2)}%</span>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-primary" onclick="editPosition('${position.symbol}')">编辑</button>
                        <button class="btn btn-danger" onclick="deletePosition('${position.symbol}')">删除</button>
                    </div>
                `;
                
                positionList.appendChild(positionItem);
            });
        }
        
        // 添加持仓
        function addPosition() {
            console.log('添加持仓');
            
            // 创建模态框
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                width: 400px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            `;
            
            // 模态框标题
            const modalTitle = document.createElement('h2');
            modalTitle.textContent = '添加持仓';
            modalTitle.style.marginBottom = '20px';
            modalContent.appendChild(modalTitle);
            
            // 表单
            const form = document.createElement('div');
            form.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">股票代码</label>
                    <input type="text" id="symbol" placeholder="请输入6位股票代码" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">股票名称</label>
                    <input type="text" id="name" placeholder="自动填充" disabled style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">持仓数量</label>
                    <input type="number" id="quantity" placeholder="请输入持仓数量" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">成本价</label>
                    <input type="number" id="cost_price" step="0.01" placeholder="请输入成本价" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">当前价</label>
                    <input type="number" id="current_price" step="0.01" placeholder="实时获取" disabled style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                </div>
            `;
            modalContent.appendChild(form);
            
            // 添加股票代码输入事件，自动填充股票名称
            const symbolInput = form.querySelector('#symbol');
            symbolInput.addEventListener('input', function() {
                const symbol = this.value.trim();
                const nameInput = form.querySelector('#name');
                
                if (symbol.length === 6 && /^\d{6}$/.test(symbol)) {
                    // 从全局股票名称映射表中获取股票名称
                    if (globalStockNames[symbol]) {
                        nameInput.value = globalStockNames[symbol];
                    } else {
                        nameInput.value = '未知股票';
                    }
                } else {
                    nameInput.value = '';
                }
            });
            
            // 按钮区域
            const buttonArea = document.createElement('div');
            buttonArea.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: flex-end;
                margin-top: 20px;
            `;
            
            // 保存按钮
            const saveButton = document.createElement('button');
            saveButton.textContent = '保存';
            saveButton.style.cssText = `
                padding: 10px 20px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            saveButton.onclick = function() {
                const symbol = document.getElementById('symbol').value;
                const quantity = document.getElementById('quantity').value;
                const cost_price = document.getElementById('cost_price').value;
                
                // 验证输入
                if (!symbol || !quantity || !cost_price) {
                    alert('请填写所有必填字段');
                    return;
                }
                
                if (!/^\d{6}$/.test(symbol)) {
                    alert('股票代码格式错误，请输入6位数字');
                    return;
                }
                
                // 构建持仓数据（只包含必填字段，股票名称和当前价由后端处理）
                const positionData = {
                    symbol: symbol,
                    quantity: parseInt(quantity),
                    cost_price: parseFloat(cost_price)
                };
                
                // 调用后端API添加持仓
                fetch('/api/plan/position', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(positionData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('添加持仓结果:', data);
                    if (data.error) {
                        alert(`添加失败: ${data.error}`);
                    } else {
                        alert(`添加成功: ${data.message}`);
                        loadPositions(); // 重新加载持仓数据
                        document.body.removeChild(modal);
                    }
                })
                .catch(error => {
                    console.error('添加持仓失败:', error);
                    console.error('错误详情:', error.message);
                    alert('添加持仓失败，请检查网络连接。错误详情: ' + error.message);
                });
            };
            buttonArea.appendChild(saveButton);
            
            // 取消按钮
            const cancelButton = document.createElement('button');
            cancelButton.textContent = '取消';
            cancelButton.style.cssText = `
                padding: 10px 20px;
                background: #f0f0f0;
                color: #333;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            cancelButton.onclick = function() {
                document.body.removeChild(modal);
            };
            buttonArea.appendChild(cancelButton);
            modalContent.appendChild(buttonArea);
            
            // 关闭模态框
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }
        
        // 编辑持仓
        function editPosition(symbol) {
            console.log('编辑持仓:', symbol);
            
            // 调用后端API获取持仓数据
            fetch('/api/plan/position')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    const position = data.positions.find(p => p.symbol === symbol);
                    if (!position) {
                        alert('持仓数据不存在');
                        return;
                    }
                    
                    // 创建模态框
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    `;
                    
                    // 创建模态框内容
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        padding: 30px;
                        border-radius: 10px;
                        width: 400px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    `;
                    
                    // 模态框标题
                    const modalTitle = document.createElement('h2');
                    modalTitle.textContent = '编辑持仓';
                    modalTitle.style.marginBottom = '20px';
                    modalContent.appendChild(modalTitle);
                    
                    // 表单
                    const form = document.createElement('div');
                    form.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">股票代码</label>
                            <input type="text" id="symbol" value="${position.symbol}" disabled style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">股票名称</label>
                            <input type="text" id="name" value="${position.name}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">持仓数量</label>
                            <input type="number" id="quantity" value="${position.quantity}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">成本价</label>
                            <input type="number" id="cost_price" step="0.01" value="${position.cost_price}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">当前价</label>
                            <input type="number" id="current_price" step="0.01" value="${position.current_price}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    `;
                    modalContent.appendChild(form);
                    
                    // 按钮区域
                    const buttonArea = document.createElement('div');
                    buttonArea.style.cssText = `
                        display: flex;
                        gap: 15px;
                        justify-content: flex-end;
                        margin-top: 20px;
                    `;
                    
                    // 保存按钮
                    const saveButton = document.createElement('button');
                    saveButton.textContent = '保存';
                    saveButton.style.cssText = `
                        padding: 10px 20px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: 500;
                    `;
                    saveButton.onclick = function() {
                        const name = document.getElementById('name').value;
                        const quantity = document.getElementById('quantity').value;
                        const cost_price = document.getElementById('cost_price').value;
                        const current_price = document.getElementById('current_price').value;
                        
                        // 验证输入
                        if (!name || !quantity || !cost_price || !current_price) {
                            alert('请填写所有必填字段');
                            return;
                        }
                        
                        // 构建持仓数据
                        const positionData = {
                            name: name,
                            quantity: parseInt(quantity),
                            cost_price: parseFloat(cost_price),
                            current_price: parseFloat(current_price)
                        };
                        
                        // 调用后端API更新持仓
                        fetch(`/api/plan/position/${symbol}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(positionData)
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('HTTP error, status = ' + response.status);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('更新持仓结果:', data);
                            if (data.error) {
                                alert(`更新失败: ${data.error}`);
                            } else {
                                alert(`更新成功: ${data.message}`);
                                loadPositions(); // 重新加载持仓数据
                                document.body.removeChild(modal);
                            }
                        })
                        .catch(error => {
                            console.error('更新持仓失败:', error);
                            console.error('错误详情:', error.message);
                            alert('更新持仓失败，请检查网络连接。错误详情: ' + error.message);
                        });
                    };
                    buttonArea.appendChild(saveButton);
                    
                    // 取消按钮
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = '取消';
                    cancelButton.style.cssText = `
                        padding: 10px 20px;
                        background: #f0f0f0;
                        color: #333;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: 500;
                    `;
                    cancelButton.onclick = function() {
                        document.body.removeChild(modal);
                    };
                    buttonArea.appendChild(cancelButton);
                    modalContent.appendChild(buttonArea);
                    
                    // 关闭模态框
                    modal.onclick = function(e) {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    };
                    
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                })
                .catch(error => {
                    console.error('获取持仓数据失败:', error);
                    console.error('错误详情:', error.message);
                    alert('获取持仓数据失败，请检查网络连接。错误详情: ' + error.message);
                });
        }
        
        // 删除持仓
        function deletePosition(symbol) {
            if (confirm(`确定要删除持仓 ${symbol} 吗？`)) {
                console.log('删除持仓:', symbol);
                
                // 调用后端API删除持仓
                fetch(`/api/plan/position/${symbol}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('删除持仓结果:', data);
                    if (data.error) {
                        alert(`删除失败: ${data.error}`);
                    } else {
                        alert(`删除成功: ${data.message}`);
                        loadPositions(); // 重新加载持仓数据
                    }
                })
                .catch(error => {
                    console.error('删除持仓失败:', error);
                    console.error('错误详情:', error.message);
                    alert('删除持仓失败，请检查网络连接。错误详情: ' + error.message);
                });
            }
        }
        
        // 定时任务相关函数
        let scheduledTimes = [];
        
        // 加载定时任务配置
        function loadSchedulerConfig() {
            fetch('/api/scheduler/config')
                .then(response => response.json())
                .then(data => {
                    scheduledTimes = data.scheduled_times || [];
                    updateSchedulerStatus(data.is_running);
                    renderScheduledTimes();
                })
                .catch(error => {
                    console.error('加载定时任务配置失败:', error);
                    document.getElementById('schedulerStatus').textContent = '加载失败';
                });
        }
        
        // 更新调度器状态显示
        function updateSchedulerStatus(isRunning) {
            const statusElement = document.getElementById('schedulerStatus');
            if (isRunning) {
                statusElement.textContent = '运行中';
                statusElement.style.color = '#27ae60';
            } else {
                statusElement.textContent = '已停止';
                statusElement.style.color = '#e74c3c';
            }
        }
        
        // 渲染定时时间列表
        function renderScheduledTimes() {
            const container = document.getElementById('scheduledTimesList');
            if (scheduledTimes.length === 0) {
                container.innerHTML = '<div style="color: #999; text-align: center; padding: 10px;">暂无定时时间</div>';
                return;
            }
            
            container.innerHTML = scheduledTimes.map((time, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px;">
                    <div style="font-size: 16px; font-weight: 500; color: #333;">
                        ${String(time.hour).padStart(2, '0')}:${String(time.minute).padStart(2, '0')}
                    </div>
                    <button class="btn btn-secondary" onclick="removeScheduledTime(${index})" style="padding: 5px 10px; font-size: 12px;">删除</button>
                </div>
            `).join('');
        }
        
        // 添加定时时间
        function addScheduledTime() {
            const hour = parseInt(document.getElementById('newHour').value);
            const minute = parseInt(document.getElementById('newMinute').value);
            
            // 检查是否已存在相同时间
            const exists = scheduledTimes.some(t => t.hour === hour && t.minute === minute);
            if (exists) {
                alert('该时间已存在');
                return;
            }
            
            scheduledTimes.push({ hour, minute });
            scheduledTimes.sort((a, b) => a.hour * 60 + a.minute - (b.hour * 60 + b.minute));
            
            saveSchedulerConfig();
            renderScheduledTimes();
        }
        
        // 删除定时时间
        function removeScheduledTime(index) {
            scheduledTimes.splice(index, 1);
            saveSchedulerConfig();
            renderScheduledTimes();
        }
        
        // 保存定时任务配置
        function saveSchedulerConfig() {
            fetch('/api/scheduler/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    scheduled_times: scheduledTimes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`保存失败: ${data.error}`);
                } else {
                    console.log('定时任务配置已保存');
                }
            })
            .catch(error => {
                console.error('保存定时任务配置失败:', error);
                alert('保存失败，请检查网络连接');
            });
        }
        
        // 启动调度器
        function startScheduler() {
            fetch('/api/scheduler/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`启动失败: ${data.error}`);
                } else {
                    updateSchedulerStatus(true);
                    alert('定时任务已启动');
                }
            })
            .catch(error => {
                console.error('启动定时任务失败:', error);
                alert('启动失败，请检查网络连接');
            });
        }
        
        // 停止调度器
        function stopScheduler() {
            fetch('/api/scheduler/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`停止失败: ${data.error}`);
                } else {
                    updateSchedulerStatus(false);
                    alert('定时任务已停止');
                }
            })
            .catch(error => {
                console.error('停止定时任务失败:', error);
                alert('停止失败，请检查网络连接');
            });
        }
        
        // 加载执行记录
        function loadSchedulerExecutionLog() {
            fetch('/api/scheduler/execution-log')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('加载执行记录失败:', data.error);
                        document.getElementById('schedulerLogs').textContent = '加载失败';
                    } else {
                        renderSchedulerExecutionLog(data.executions || []);
                    }
                })
                .catch(error => {
                    console.error('加载执行记录失败:', error);
                    document.getElementById('schedulerLogs').textContent = '加载失败';
                });
        }
        
        // 渲染执行记录
        function renderSchedulerExecutionLog(executions) {
            const container = document.getElementById('schedulerLogs');
            if (executions.length === 0) {
                container.innerHTML = '暂无执行记录';
                return;
            }
            
            // 去重：只保留每个时间点的第一条记录
            const uniqueExecutions = [];
            const seenTimes = new Set();
            
            for (const exec of executions) {
                const key = `${exec.date}_${exec.time}`;
                if (!seenTimes.has(key)) {
                    seenTimes.add(key);
                    uniqueExecutions.push(exec);
                }
            }
            
            container.innerHTML = uniqueExecutions.map(exec => `
                <div style="padding: 8px 0; border-bottom: 1px solid #eee; font-size: 12px;">
                    <div style="color: #666; margin-bottom: 4px;">
                        <span style="color: #27ae60; font-weight: 500;">${exec.date}</span>
                        <span style="color: #999; margin: 0 8px;">${exec.time}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // 加载数据更新配置
        function loadDataUpdateConfig() {
            fetch('/api/data/settings')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('加载数据更新配置失败:', data.error);
                    } else {
                        document.getElementById('dataUpdateInterval').value = data.update_interval || 10;
                    }
                })
                .catch(error => {
                    console.error('加载数据更新配置失败:', error);
                });
        }
        
        // 保存数据更新配置
        function saveDataUpdateConfig() {
            const interval = parseInt(document.getElementById('dataUpdateInterval').value);
            
            console.log('保存数据更新配置，间隔:', interval, '分钟');
            
            fetch('/api/data/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    update_interval: interval
                })
            })
            .then(response => {
                console.log('响应状态:', response.status);
                if (!response.ok) {
                    throw new Error('HTTP error, status = ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('响应数据:', data);
                if (data.error) {
                    alert('保存失败: ' + data.error);
                } else {
                    alert('数据更新配置已保存');
                    loadDataUpdateLogs();
                }
            })
            .catch(error => {
                console.error('保存数据更新配置失败:', error);
                console.error('错误详情:', error.message);
                alert('保存失败: ' + error.message);
            });
        }
        
        // 加载数据更新日志
        function loadDataUpdateLogs() {
            fetch('/api/dataupdatelog')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('加载数据更新日志失败:', data.error);
                    } else {
                        renderDataUpdateLogs(data.logs || []);
                    }
                })
                .catch(error => {
                    console.error('加载数据更新日志失败:', error);
                });
        }
        
        // 渲染数据更新日志
        function renderDataUpdateLogs(logs) {
            const container = document.getElementById('dataUpdateLogs');
            if (logs.length === 0) {
                container.innerHTML = '暂无更新记录';
                return;
            }
            
            // 按时间倒序排列
            const sortedLogs = [...logs].reverse();
            
            // 更新最后更新时间
            if (sortedLogs.length > 0) {
                const lastLog = sortedLogs[0];
                document.getElementById('lastDataUpdateTime').textContent = lastLog.timestamp;
            }
            
            container.innerHTML = sortedLogs.map(log => `
                <div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                    <div style="color: ${log.success ? '#27ae60' : '#e74c3c'}; font-weight: 500;">
                        ${log.timestamp} - ${log.module}
                    </div>
                    ${log.error ? `<div style="color: #e74c3c; font-size: 10px;">错误: ${log.error}</div>` : ''}
                </div>
            `).join('');
        }
        
        // 邮件配置相关函数
        function toggleEmailConfig() {
            const enabled = document.getElementById('emailEnabled').value === 'true';
            const configArea = document.getElementById('emailConfigArea');
            configArea.style.display = enabled ? 'block' : 'none';
        }
        
        function toggleAuthCodeVisibility() {
            const authCodeInput = document.getElementById('senderAuthCode');
            const button = event.target;
            if (authCodeInput.type === 'password') {
                authCodeInput.type = 'text';
                button.textContent = '隐藏';
            } else {
                authCodeInput.type = 'password';
                button.textContent = '显示';
            }
        }
        
        function loadEmailConfig() {
            console.log("开始加载邮件配置...");
            fetch('/api/email/config')
                .then(response => response.json())
                .then(data => {
                    console.log("邮件配置数据:", data);
                    if (data.error) {
                        console.error('加载邮件配置失败:', data.error);
                        // 如果是数据库未初始化的错误，延迟重试
                        if (data.error && data.error.includes('no such table')) {
                            console.log("数据库未初始化，延迟重试...");
                            setTimeout(loadEmailConfig, 2000);
                        }
                    } else {
                        const config = data;
                        document.getElementById('emailEnabled').value = config.enabled ? 'true' : 'false';
                        document.getElementById('senderEmail').value = config.sender_email || '';
                        document.getElementById('senderAuthCode').value = config.sender_auth_code || '';
                        document.getElementById('emailTemplate').value = config.email_body_template || 'simple';
                        toggleEmailConfig();
                        console.log("邮件配置加载成功");
                    }
                })
                .catch(error => {
                    console.error('加载邮件配置失败:', error);
                    // 网络错误时延迟重试
                    setTimeout(loadEmailConfig, 3000);
                });
        }
        
        function saveEmailConfig() {
            const config = {
                enabled: document.getElementById('emailEnabled').value === 'true',
                sender_email: document.getElementById('senderEmail').value,
                sender_auth_code: document.getElementById('senderAuthCode').value,
                email_body_template: document.getElementById('emailTemplate').value
            };
            
            fetch('/api/email/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`保存失败: ${data.error}`);
                } else {
                    alert('邮件配置已保存');
                }
            })
            .catch(error => {
                console.error('保存邮件配置失败:', error);
                alert('保存失败，请检查网络连接');
            });
        }
        
        function renderRecipients(recipients) {
            const container = document.getElementById('recipientsList');
            if (recipients.length === 0) {
                container.innerHTML = '<div style="font-size: 12px; color: #999;">暂无接收人</div>';
                return;
            }
            
            container.innerHTML = recipients.map(recipient => `
                <div style="display: flex; gap: 5px; margin-bottom: 5px; align-items: center;">
                    <input type="checkbox" id="recipient_active_${recipient.id}" ${recipient.is_active ? 'checked' : ''} 
                           onchange="toggleRecipientActive(${recipient.id})" style="margin: 0;">
                    <input type="email" class="form-control" value="${recipient.email_address}" readonly 
                           style="flex: 2; background: ${recipient.is_active ? '#fff' : '#e9ecef'}; 
                                  ${!recipient.is_active ? 'color: #999;' : ''}">
                    <input type="text" class="form-control" value="${recipient.name || ''}" placeholder="姓名" 
                           style="flex: 1; background: ${recipient.is_active ? '#fff' : '#e9ecef'};
                                  ${!recipient.is_active ? 'color: #999;' : ''}"
                           onchange="updateRecipientName(${recipient.id}, this.value)">
                    <button class="btn btn-secondary" onclick="editRecipient(${recipient.id})" 
                            style="padding: 5px 10px; font-size: 11px;">编辑</button>
                    <button class="btn btn-danger" onclick="deleteRecipient(${recipient.id})" 
                            style="padding: 5px 10px; font-size: 11px;">删除</button>
                </div>
            `).join('');
        }
        
        function loadRecipients() {
            console.log("开始加载接收邮箱列表...");
            fetch('/api/email/recipients')
                .then(response => response.json())
                .then(data => {
                    console.log("接收邮箱数据:", data);
                    if (data.success) {
                        renderRecipients(data.data);
                        console.log("接收邮箱列表加载成功");
                    } else {
                        console.error('加载接收邮箱失败:', data.error);
                        // 如果是数据库未初始化的错误，延迟重试
                        if (data.error && data.error.includes('no such table')) {
                            console.log("数据库未初始化，延迟重试...");
                            setTimeout(loadRecipients, 2000);
                        }
                    }
                })
                .catch(error => {
                    console.error('加载接收邮箱失败:', error);
                    // 网络错误时延迟重试
                    setTimeout(loadRecipients, 3000);
                });
        }

        function getRecipients() {
            const recipientElements = document.querySelectorAll('#recipientsList input[type="email"]');
            const recipients = [];
            recipientElements.forEach(element => {
                const checkbox = element.parentElement.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    recipients.push(element.value);
                }
            });
            return recipients;
        }

        function addRecipient() {
            const emailInput = document.getElementById('newRecipient');
            const nameInput = document.getElementById('newRecipientName');
            const email = emailInput.value.trim();
            const name = nameInput.value.trim();
            
            if (!email) {
                alert('请输入邮箱地址');
                return;
            }
            
            if (!validateEmail(email)) {
                alert('请输入有效的邮箱地址');
                return;
            }
            
            fetch('/api/email/recipients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email_address: email,
                    name: name || null,
                    description: null,
                    is_active: true
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        emailInput.value = '';
                        nameInput.value = '';
                        loadRecipients();
                    } else {
                        alert(`添加失败: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('添加接收邮箱失败:', error);
                    alert('添加失败，请检查网络连接');
                });
        }
        
        function deleteRecipient(recipientId) {
            if (!confirm('确定要删除此接收邮箱吗？')) {
                return;
            }
            
            fetch(`/api/email/recipients/${recipientId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadRecipients();
                    } else {
                        alert(`删除失败: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('删除接收邮箱失败:', error);
                    alert('删除失败，请检查网络连接');
                });
        }
        
        function toggleRecipientActive(recipientId) {
            const checkbox = document.getElementById(`recipient_active_${recipientId}`);
            const isActive = checkbox.checked;
            
            fetch(`/api/email/recipients/${recipientId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    is_active: isActive
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadRecipients();
                    } else {
                        alert(`更新失败: ${data.error}`);
                        checkbox.checked = !isActive;
                    }
                })
                .catch(error => {
                    console.error('更新接收邮箱失败:', error);
                    alert('更新失败，请检查网络连接');
                    checkbox.checked = !isActive;
                });
        }
        
        function updateRecipientName(recipientId, name) {
            fetch(`/api/email/recipients/${recipientId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name || null
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert(`更新失败: ${data.error}`);
                        loadRecipients();
                    }
                })
                .catch(error => {
                    console.error('更新接收邮箱失败:', error);
                    alert('更新失败，请检查网络连接');
                    loadRecipients();
                });
        }
        
        function editRecipient(recipientId) {
            const email = prompt('请输入新的邮箱地址:');
            if (!email) {
                return;
            }
            
            if (!validateEmail(email)) {
                alert('请输入有效的邮箱地址');
                return;
            }
            
            fetch(`/api/email/recipients/${recipientId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email_address: email
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadRecipients();
                    } else {
                        alert(`更新失败: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('更新接收邮箱失败:', error);
                    alert('更新失败，请检查网络连接');
                });
        }
        
        function checkSchedulerStatus() {
            console.log("检查定时任务状态...");
            fetch('/api/scheduler/status')
                .then(response => response.json())
                .then(data => {
                    console.log("定时任务状态:", data);
                    if (data.success) {
                        const status = data.status;
                        updateSchedulerStatus(status.is_running);
                        
                        if (status.is_running) {
                            console.log("✅ 定时任务运行正常");
                            const timeStrs = status.scheduled_times.map(t => 
                                `${t.hour.toString().padStart(2, '0')}:${t.minute.toString().padStart(2, '0')}`
                            );
                            console.log(`定时执行时间: ${timeStrs.join(', ')}`);
                        } else {
                            console.log("❌ 定时任务未运行");
                            // 尝试启动定时任务
                            startScheduler();
                        }
                    } else {
                        console.error('检查定时任务状态失败:', data.error);
                    }
                })
                .catch(error => {
                    console.error('检查定时任务状态失败:', error);
                });
        }
        
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }
        
        function hideImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importFile').value = '';
        }
        
        function importRecipients() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择要导入的文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/email/recipients/import', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        hideImportModal();
                        loadRecipients();
                    } else {
                        alert(`导入失败: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('导入接收邮箱失败:', error);
                    console.error('错误详情:', error.message);
                    console.error('错误堆栈:', error.stack);
                    alert('导入失败，请检查网络连接。错误详情: ' + error.message);
                });
        }
        
        function exportRecipients() {
            window.location.href = '/api/email/recipients/export';
        }
        
        function showClearRecipientsModal() {
            document.getElementById('clearRecipientsModal').style.display = 'block';
        }
        
        function hideClearRecipientsModal() {
            document.getElementById('clearRecipientsModal').style.display = 'none';
        }
        
        function clearRecipients() {
            fetch('/api/email/recipients', {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('清空成功');
                        hideClearRecipientsModal();
                        loadRecipients();
                    } else {
                        alert(`清空失败: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('清空接收邮箱失败:', error);
                    alert('清空失败，请检查网络连接');
                });
        }
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function sendTestEmail() {
            const config = {
                enabled: document.getElementById('emailEnabled').value === 'true',
                sender_email: document.getElementById('senderEmail').value,
                sender_auth_code: document.getElementById('senderAuthCode').value,
                recipients: getRecipients(),
                email_body_template: document.getElementById('emailTemplate').value
            };
            
            if (!config.sender_email) {
                alert('请输入发送邮箱地址');
                return;
            }
            
            if (!config.sender_auth_code) {
                alert('请输入邮箱授权码');
                return;
            }
            
            if (config.recipients.length === 0) {
                alert('请至少添加一个接收邮箱地址');
                return;
            }
            
            fetch('/api/email/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`发送测试邮件失败: ${data.error}`);
                } else {
                    alert('测试邮件发送成功，请检查邮箱');
                }
            })
            .catch(error => {
                console.error('发送测试邮件失败:', error);
                alert('发送失败，请检查网络连接');
            });
        }
        
        // 页面加载时初始化定时任务配置
        document.addEventListener('DOMContentLoaded', function() {
            console.log("页面加载完成，开始初始化...");
            
            // 先加载基础配置
            loadSchedulerConfig();
            loadSchedulerExecutionLog();
            loadDataUpdateConfig();
            loadDataUpdateLogs();
            
            // 延迟加载邮箱相关配置，确保数据库初始化完成
            setTimeout(function() {
                console.log("延迟加载邮箱配置...");
                loadEmailConfig();
                loadRecipients();
                
                // 检查定时任务状态
                checkSchedulerStatus();
            }, 1000);
        });
    </script>
    
    <!-- 导入接收邮箱模态框 -->
    <div id="importModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 400px; max-width: 90%;">
            <h3 style="margin-bottom: 15px;">导入接收邮箱</h3>
            <p style="margin-bottom: 15px; font-size: 12px; color: #666;">支持CSV和Excel文件，文件中需包含email_address列（必填），可选包含name和description列。</p>
            <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="width: 100%; margin-bottom: 15px;">
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideImportModal()">取消</button>
                <button class="btn btn-primary" onclick="importRecipients()">导入</button>
            </div>
        </div>
    </div>
    
    <!-- 清空接收邮箱确认模态框 -->
    <div id="clearRecipientsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 400px; max-width: 90%;">
            <h3 style="margin-bottom: 15px;">确认清空</h3>
            <p style="margin-bottom: 15px; color: #e74c3c;">确定要清空所有接收邮箱吗？此操作不可恢复！</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideClearRecipientsModal()">取消</button>
                <button class="btn btn-danger" onclick="clearRecipients()">确认清空</button>
            </div>
        </div>
    </div>
</body>
</html>
