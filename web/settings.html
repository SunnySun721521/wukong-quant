<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè®¾ç½® - é‡åŒ–äº¤æ˜“ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            display: block;
        }
        
        .nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            background-color: #667eea;
            color: white;
        }
        
        .nav-item:hover:not(.active) {
            background-color: #f0f0f0;
        }
        
        .settings-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
        }
        
        .form-checkbox input {
            margin-right: 10px;
        }
        
        .settings-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab-item {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-item.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stock-pool {
            margin-top: 15px;
        }
        
        .stock-pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stock-pool-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        
        .stock-pool-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd8;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .stock-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        
        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
        }
        
        .stock-item:hover {
            background-color: #f5f5f5;
        }
        
        .stock-info {
            display: flex;
            align-items: center;
        }
        
        .stock-symbol {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-right: 10px;
        }
        
        .stock-name {
            font-size: 12px;
            color: #666;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn-large {
            padding: 12px 30px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header .title {
                font-size: 24px;
            }
            
            .nav-bar {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .nav-item {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .settings-tabs {
                overflow-x: auto;
            }
            
            .tab-item {
                white-space: nowrap;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn-large {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¯¼èˆªæ ?-->
        <div class="nav-bar">
            <div class="nav-item" data-page="home" onclick="window.location.href='index.html'">é¦–é¡µ</div>
            <div class="nav-item" data-page="plan" onclick="window.location.href='plan.html'">è®¡åˆ’</div>
            <div class="nav-item" data-page="backtest" onclick="window.location.href='backtest.html'">å›æµ‹</div>
            <div class="nav-item" data-page="prediction" onclick="window.location.href='prediction.html'">é¢„æµ‹</div>
            <div class="nav-item" data-page="strategy" onclick="window.location.href='strategy.html'">ç­–ç•¥</div>
            <div class="nav-item active" data-page="settings">è®¾ç½®</div>
        </div>
        
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <span class="title">ç³»ç»Ÿè®¾ç½®</span>
            <span class="subtitle">ç³»ç»Ÿé…ç½®ä¸å‚æ•°è°ƒæ•?/span>
        </div>
        
        <!-- è®¾ç½®å†…å®¹ -->
        <div class="settings-section">
            <!-- è®¾ç½®é€‰é¡¹å?-->
            <div class="settings-tabs">
                <div class="tab-item active" data-tab="general">é€šç”¨è®¾ç½®</div>
                <div class="tab-item" data-tab="data">æ•°æ®è®¾ç½®</div>
                <div class="tab-item" data-tab="strategy">ç­–ç•¥è®¾ç½®</div>
                <div class="tab-item" data-tab="stock_pool">è‚¡ç¥¨æ± ç®¡ç?/div>
                <div class="tab-item" data-tab="position">æŒä»“ç®¡ç†</div>
                <div class="tab-item" data-tab="scheduler">å®šæ—¶ä»»åŠ¡</div>
            </div>
            
            <!-- é€šç”¨è®¾ç½® -->
            <div class="tab-content active" id="general">
                <div class="form-group">
                    <label class="form-label">ç³»ç»Ÿè¯­è¨€</label>
                    <select class="form-control" id="systemLanguage">
                        <option value="zh-CN">ç®€ä½“ä¸­æ–?/option>
                        <option value="en-US">English</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ—¶åŒº</label>
                    <select class="form-control" id="timezone">
                        <option value="Asia/Shanghai">ä¸­å›½æ ‡å‡†æ—¶é—´</option>
                        <option value="America/New_York">ç¾å›½ä¸œéƒ¨æ—¶é—´</option>
                        <option value="Europe/London">è‹±å›½æ ‡å‡†æ—¶é—´</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ç•Œé¢ä¸»é¢˜</label>
                    <select class="form-control" id="theme">
                        <option value="light">æµ…è‰²ä¸»é¢˜</option>
                        <option value="dark">æ·±è‰²ä¸»é¢˜</option>
                    </select>
                </div>
                
                <div class="form-group form-checkbox">
                    <input type="checkbox" id="autoUpdate">
                    <label for="autoUpdate">è‡ªåŠ¨æ£€æŸ¥æ›´æ–?/label>
                </div>
                
                <div class="form-group form-checkbox">
                    <input type="checkbox" id="enableNotification">
                    <label for="enableNotification">å¯ç”¨é€šçŸ¥</label>
                </div>
            </div>
            
            <!-- æ•°æ®è®¾ç½® -->
            <div class="tab-content" id="data">
                <div class="form-group">
                    <label class="form-label">æ•°æ®æ¥æº</label>
                    <select class="form-control" id="dataSource">
                        <option value="efinance">efinance (Aè‚?</option>
                        <option value="yfinance">yfinance (ç¾è‚¡)</option>
                        <option value="tushare">Tushare (Aè‚?</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ç¼“å­˜æœ‰æ•ˆæœ?(ç§?</label>
                    <input type="number" class="form-control" id="cacheExpiry" value="3600" min="60" max="86400">
                </div>
                
                <div class="form-group form-checkbox">
                    <input type="checkbox" id="enableCache">
                    <label for="enableCache">å¯ç”¨æ•°æ®ç¼“å­˜</label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ•°æ®æ›´æ–°é¢‘ç‡ (åˆ†é’Ÿ)</label>
                    <input type="number" class="form-control" id="updateFrequency" value="30" min="1" max="1440">
                </div>
            </div>
            
            <!-- ç­–ç•¥è®¾ç½® -->
            <div class="tab-content" id="strategy">
                <div class="form-group">
                    <label class="form-label">é»˜è®¤ç­–ç•¥</label>
                    <select class="form-control" id="defaultStrategy">
                        <option value="moving_average">ç§»åŠ¨å¹³å‡çº¿ç­–ç•?/option>
                        <option value="mean_reversion">å‡å€¼å›å½’ç­–ç•?/option>
                        <option value="momentum">åŠ¨é‡ç­–ç•¥</option>
                        <option value="breakout">çªç ´ç­–ç•¥</option>
                        <option value="niu_huicai" selected>ç‰›å›æµ‹ç­–ç•?/option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é»˜è®¤åˆå§‹èµ„é‡‘</label>
                    <input type="number" class="form-control" id="defaultInitialCash" value="1000000" min="10000" step="10000">
                </div>
                
                <div class="form-group">
                    <label class="form-label">é»˜è®¤äº¤æ˜“æˆæœ¬ (â€?</label>
                    <input type="number" class="form-control" id="defaultTransactionCost" value="0.3" min="0" max="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">é»˜è®¤å›æµ‹å‘¨æœŸ</label>
                    <select class="form-control" id="defaultBacktestPeriod">
                        <option value="1y">1å¹?/option>
                        <option value="2y">2å¹?/option>
                        <option value="3y">3å¹?/option>
                        <option value="5y">5å¹?/option>
                    </select>
                </div>
                
                <hr>
                
                <h3>ç­–ç•¥å‚æ•°</h3>
                
                <div class="form-group">
                    <label class="form-label">PEé˜ˆå€?/label>
                    <input type="number" class="form-control" id="peThreshold" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ROEé˜ˆå€?/label>
                    <input type="number" class="form-control" id="roeThreshold" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">çŸ­æœŸå‡çº¿</label>
                    <input type="number" class="form-control" id="smaShort" min="1" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">é•¿æœŸå‡çº¿</label>
                    <input type="number" class="form-control" id="smaLong" min="1" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ä»“ä½æ¯”ä¾‹ (%)</label>
                    <input type="number" class="form-control" id="position_pct" min="0" max="100" step="1">
                </div>
            </div>
            
            <!-- è‚¡ç¥¨æ± ç®¡ç?-->
            <div class="tab-content" id="stock_pool">
                <div class="stock-pool">
                    <div class="stock-pool-header">
                        <div class="stock-pool-title">é»˜è®¤è‚¡ç¥¨æ±?/div>
                        <div class="stock-pool-actions">
                            <button class="btn btn-primary" onclick="importStockPool()">å¯¼å…¥</button>
                            <button class="btn btn-secondary" onclick="exportStockPool()">å¯¼å‡º</button>
                            <button class="btn btn-secondary" onclick="addStock()">æ·»åŠ </button>
                            <button class="btn btn-info" onclick="updateStockNames()">æ˜ å°„è¡?/button>
                            <button class="btn btn-danger" onclick="clearStockPool()">æ¸…ç©º</button>
                        </div>
                    </div>
                    
                    <div class="stock-list">
                        <div class="stock-item">
                            <div class="stock-info">
                                <span class="stock-symbol">000001</span>
                                <span class="stock-name">å¹³å®‰é“¶è¡Œ</span>
                            </div>
                            <button class="btn btn-secondary" onclick="removeStock('000001')">åˆ é™¤</button>
                        </div>
                        <div class="stock-item">
                            <div class="stock-info">
                                <span class="stock-symbol">600519</span>
                                <span class="stock-name">è´µå·èŒ…å°</span>
                            </div>
                            <button class="btn btn-secondary" onclick="removeStock('600519')">åˆ é™¤</button>
                        </div>
                        <div class="stock-item">
                            <div class="stock-info">
                                <span class="stock-symbol">000858</span>
                                <span class="stock-name">äº”ç²®æ¶?/span>
                            </div>
                            <button class="btn btn-secondary" onclick="removeStock('000858')">åˆ é™¤</button>
                        </div>
                        <div class="stock-item">
                            <div class="stock-info">
                                <span class="stock-symbol">601318</span>
                                <span class="stock-name">ä¸­å›½å¹³å®‰</span>
                            </div>
                            <button class="btn btn-secondary" onclick="removeStock('601318')">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æŒä»“ç®¡ç† -->
            <div class="tab-content" id="position">
                <div class="stock-pool">
                    <div class="stock-pool-header">
                        <div class="stock-pool-title">æŒä»“ç®¡ç†</div>
                        <div class="stock-pool-actions">
                            <button class="btn btn-primary" onclick="initPositionTable()">åˆå§‹åŒ–æŒä»“è¡¨</button>
                            <button class="btn btn-secondary" onclick="addPosition()">æ·»åŠ æŒä»“</button>
                            <button class="btn btn-info" onclick="loadPositions()">åˆ·æ–°</button>
                        </div>
                    </div>
                    
                    <!-- èµ„äº§æ¦‚è§ˆ -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">åŸå§‹èµ„é‡‘</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;" id="originalCash">--</div>
                            <div style="margin-top: 10px;">
                                <input type="number" id="customOriginalCash" placeholder="è‡ªå®šä¹‰åŸå§‹èµ„é‡? style="width: 80%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" step="0.01" min="0">
                                <button class="btn btn-secondary" onclick="updateOriginalCash()" style="margin-top: 5px; font-size: 12px; padding: 3px 8px;">æ›´æ–°</button>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">æ€»èµ„äº?/div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;" id="totalAssets">--</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">æŒä»“å¸‚å€?/div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;" id="positionValue">--</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">å¯ç”¨ç°é‡‘</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;" id="availableCash">--</div>
                            <div style="margin-top: 10px;">
                                <input type="number" id="customAvailableCash" placeholder="è‡ªå®šä¹‰ç°é‡? style="width: 80%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" step="0.01" min="0">
                                <button class="btn btn-secondary" onclick="updateAvailableCash()" style="margin-top: 5px; font-size: 12px; padding: 3px 8px;">æ›´æ–°</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stock-list" id="position-list">
                        <!-- æŒä»“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½?-->
                        <div style="text-align: center; color: #666; padding: 20px;">è¯·ç‚¹å‡?åˆ·æ–°"æŒ‰é’®åŠ è½½æŒä»“æ•°æ®</div>
                    </div>
                </div>
            </div>
            
            <!-- å®šæ—¶ä»»åŠ¡ -->
            <div class="tab-content" id="scheduler">
                <div style="display: flex; gap: 20px; align-items: flex-start;">
                    <!-- å·¦ä¾§ï¼šPDFè‡ªåŠ¨å¯¼å‡ºå®šæ—¶ä»»åŠ¡ -->
                    <div style="flex: 1;">
                        <div class="section-title">PDFè‡ªåŠ¨å¯¼å‡ºå®šæ—¶ä»»åŠ¡</div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">ä»»åŠ¡çŠ¶æ€?/div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 16px; font-weight: bold; color: #333;" id="schedulerStatus">åŠ è½½ä¸?..</div>
                                <button class="btn btn-primary" onclick="startScheduler()">å¯åŠ¨</button>
                                <button class="btn btn-secondary" onclick="stopScheduler()">åœæ­¢</button>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">æ‰§è¡Œæ—¶é—´è®¾ç½®</div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 15px;">å®šæ—¶ä»»åŠ¡ä»…åœ¨å·¥ä½œæ—¥ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰æ‰§è¡Œ</div>
                            
                            <div id="scheduledTimesList" style="margin-bottom: 15px;">
                                <!-- å®šæ—¶æ—¶é—´åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½?-->
                            </div>
                            
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                                <select class="form-control" id="newHour" style="width: 100px;">
                                    <option value="0">00</option>
                                    <option value="1">01</option>
                                    <option value="2">02</option>
                                    <option value="3">03</option>
                                    <option value="4">04</option>
                                    <option value="5">05</option>
                                    <option value="6">06</option>
                                    <option value="7">07</option>
                                    <option value="8">08</option>
                                    <option value="9">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12" selected>12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                    <option value="21">21</option>
                                    <option value="22">22</option>
                                    <option value="23">23</option>
                                </select>
                                <span style="font-size: 16px; color: #666;">:</span>
                                <select class="form-control" id="newMinute" style="width: 100px;">
                                    <option value="0" selected>00</option>
                                    <option value="5">05</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                    <option value="35">35</option>
                                    <option value="40">40</option>
                                    <option value="45">45</option>
                                    <option value="50">50</option>
                                    <option value="55">55</option>
                                </select>
                                <button class="btn btn-primary" onclick="addScheduledTime()">æ·»åŠ æ—¶é—´</button>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">æœ€è¿‘æ‰§è¡Œè®°å½?/div>
                            <div id="schedulerLogs" style="font-size: 12px; color: #999;">
                                æš‚æ— æ‰§è¡Œè®°å½•
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">é‚®ä»¶å‘é€é…ç½?/div>
                            
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <label style="font-size: 12px; color: #666;">é‚®ä»¶å‘é€åŠŸèƒ?</label>
                                <select class="form-control" id="emailEnabled" style="width: 100px;" onchange="toggleEmailConfig()">
                                    <option value="false">ç¦ç”¨</option>
                                    <option value="true">å¯ç”¨</option>
                                </select>
                            </div>
                            
                            <div id="emailConfigArea" style="display: none;">
                                <div style="margin-bottom: 15px;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">å‘é€é‚®ç®±åœ°å€:</label>
                                    <div style="display: flex; gap: 5px;">
                                        <input type="text" class="form-control" id="senderEmail" placeholder="è¯·è¾“å…¥QQé‚®ç®±åœ°å€" style="flex: 1;">
                                        <span style="font-size: 14px; color: #666; align-self: center;">@qq.com</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">é‚®ç®±æˆæƒç ?</label>
                                    <div style="display: flex; gap: 5px;">
                                        <input type="password" class="form-control" id="senderAuthCode" placeholder="è¯·è¾“å…¥é‚®ç®±æˆæƒç " style="flex: 1;">
                                        <button class="btn btn-secondary" onclick="toggleAuthCodeVisibility()" style="padding: 5px 10px;">æ˜¾ç¤º</button>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">æ¥æ”¶é‚®ç®±åˆ—è¡¨:</label>
                                    <div id="recipientsList" style="margin-bottom: 10px; max-height: 200px; overflow-y: auto;">
                                        <!-- æ¥æ”¶äººåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½?-->
                                    </div>
                                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                        <input type="email" class="form-control" id="newRecipient" placeholder="è¯·è¾“å…¥æ¥æ”¶é‚®ç®±åœ°å€" style="flex: 1;">
                                        <input type="text" class="form-control" id="newRecipientName" placeholder="å§“åï¼ˆå¯é€‰ï¼‰" style="flex: 1;">
                                        <button class="btn btn-primary" onclick="addRecipient()">æ·»åŠ </button>
                                    </div>
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        <button class="btn btn-secondary" onclick="showImportModal()" style="padding: 5px 10px; font-size: 12px;">å¯¼å…¥</button>
                                        <button class="btn btn-secondary" onclick="exportRecipients()" style="padding: 5px 10px; font-size: 12px;">å¯¼å‡º</button>
                                        <button class="btn btn-danger" onclick="showClearRecipientsModal()" style="padding: 5px 10px; font-size: 12px;">æ¸…ç©º</button>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">é‚®ä»¶æ¨¡æ¿:</label>
                                    <select class="form-control" id="emailTemplate">
                                        <option value="simple">ç®€æ´ç‰ˆ</option>
                                        <option value="detailed">è¯¦ç»†ç‰?/option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <button class="btn btn-primary" onclick="saveEmailConfig()">ä¿å­˜é‚®ä»¶é…ç½®</button>
                                    <button class="btn btn-secondary" onclick="sendTestEmail()">å‘é€æµ‹è¯•é‚®ä»?/button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šæ•°æ®è‡ªåŠ¨æ›´æ–°é…ç½?-->
                    <div style="flex: 1;">
                        <div class="section-title">æ•°æ®è‡ªåŠ¨æ›´æ–°é…ç½®</div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">æ•°æ®è‡ªåŠ¨æ›´æ–°é…ç½®</div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 15px;">è‡ªåŠ¨æ›´æ–°è®¡åˆ’é¡µé¢ä¸­çš„å¸‚åœºçŠ¶æ€åˆ¤æ–­ã€æŒä»“åˆ†æã€è°ƒä»“ç­–ç•¥ã€ä¹°å…¥ç­–ç•¥æ•°æ?/div>
                            
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; color: #666;">æ›´æ–°é—´éš”ï¼ˆåˆ†é’Ÿï¼‰:</label>
                                    <select class="form-control" id="dataUpdateInterval" style="width: 150px;">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="15">15</option>
                                        <option value="20">20</option>
                                        <option value="30">30</option>
                                        <option value="60">60</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="saveDataUpdateConfig()">ä¿å­˜æ•°æ®æ›´æ–°é…ç½®</button>
                            </div>
                            
                            <div style="font-size: 12px; color: #999; margin-bottom: 10px;">ä¸Šæ¬¡æ›´æ–°æ—¶é—´: <span id="lastDataUpdateTime" style="color: #27ae60; font-weight: 500;">--</span></div>
                            
                            <div id="dataUpdateLogs" style="max-height: 200px; overflow-y: auto; font-size: 11px; color: #999;">
                                <!-- æ•°æ®æ›´æ–°æ—¥å¿—å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½?-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æŒ‰é’®ç»?-->
            <div class="button-group">
                <button class="btn btn-primary btn-large" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                <button class="btn btn-secondary btn-large" onclick="resetSettings()">æ¢å¤é»˜è®¤</button>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€è‚¡ç¥¨åç§°æ˜ å°„è¡¨ï¼ˆä¼˜å…ˆä»localStorageåŠ è½½ï¼?        let globalStockNames = (function() {
            try {
                const stored = localStorage.getItem('stockNames');
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (error) {
                console.error('è§£ælocalStorageä¸­çš„è‚¡ç¥¨åç§°æ˜ å°„è¡¨å¤±è´?', error);
            }
            // é»˜è®¤è‚¡ç¥¨åç§°æ˜ å°„ï¼ˆå½“localStorageä¸­æ²¡æœ‰æ•°æ®æ—¶ä½¿ç”¨ï¼?            return {
                '300308': 'ä¸­é™…æ—­åˆ›',
                '603000': 'äººæ°‘ç½?,
                '300502': 'æ–°æ˜“ç›?,
                '300274': 'é˜³å…‰ç”µæº',
                '002371': 'åŒ—æ–¹ååˆ›',
                '300750': 'å®å¾·æ—¶ä»£',
                '601899': 'ç´«é‡‘çŸ¿ä¸š',
                '600519': 'è´µå·èŒ…å°',
                '000858': 'äº”ç²®æ¶?,
                '000333': 'ç¾çš„é›†å›¢',
                '000651': 'æ ¼åŠ›ç”µå™¨',
                '600031': 'ä¸‰ä¸€é‡å·¥',
                '000002': 'ä¸‡ç§‘A',
                '601988': 'ä¸­å›½é“¶è¡Œ',
                '601288': 'å†œä¸šé“¶è¡Œ',
                '601398': 'å·¥å•†é“¶è¡Œ',
                '600000': 'æµ¦å‘é“¶è¡Œ',
                '601166': 'å…´ä¸šé“¶è¡Œ',
                '600016': 'æ°‘ç”Ÿé“¶è¡Œ',
                '601818': 'å…‰å¤§é“¶è¡Œ',
                '601628': 'ä¸­å›½äººå¯¿',
                '601336': 'æ–°åä¿é™©',
                '601601': 'ä¸­å›½å¤ªä¿',
                '600030': 'ä¸­ä¿¡è¯åˆ¸',
                '601688': 'åæ³°è¯åˆ¸',
                '601211': 'å›½æ³°å›å®‰',
                '600837': 'æµ·é€šè¯åˆ?,
                '601901': 'æ–¹æ­£è¯åˆ¸',
                '000568': 'æ³¸å·è€çª–',
                '600809': 'å±±è¥¿æ±¾é…’',
                '000799': 'é…’é¬¼é…?,
                '000001': 'å¹³å®‰é“¶è¡Œ',
                '600036': 'æ‹›å•†é“¶è¡Œ',
                '600276': 'æ’ç‘åŒ»è¯',
                '601888': 'ä¸­å›½ä¸­å…',
                '600887': 'ä¼Šåˆ©è‚¡ä»½',
                '601318': 'ä¸­å›½å¹³å®‰',
                '301269': 'åå¤§ä¹å¤©',
                '688981': 'ä¸­èŠ¯å›½é™…',
                '688599': 'å¤©åˆå…‰èƒ½',
                '688396': 'åæ¶¦å¾?,
                '601766': 'ä¸­å›½ä¸­è½¦',
                '600157': 'æ°¸æ³°èƒ½æº',
                '688256': 'å¯’æ­¦çº?,
                '300563': 'ç¥å®‡è‚¡ä»½',
                '002079': 'è‹å·å›ºé”'
            };
        })();
        
        function checkLogin() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            // é€‰é¡¹å¡åˆ‡æ?            document.querySelectorAll('.tab-item').forEach(item => {
                item.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€?                    document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€?                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // å¦‚æœåˆ‡æ¢åˆ°è‚¡ç¥¨æ± ç®¡ç†é€‰é¡¹å¡ï¼ŒåŠ è½½è‚¡ç¥¨æ± æ•°æ?                    if (tabId === 'stock_pool') {
                        loadStockPool();
                    }
                });
            });
            
            // åŠ è½½è®¾ç½®
            loadSettings();
        });
        
        // åŠ è½½è®¾ç½®
        function loadSettings() {
            console.log('åŠ è½½è®¾ç½®');
            
            // ä»åç«¯åŠ è½½é€šç”¨è®¾ç½®
            fetch('/api/general/settings')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('é€šç”¨è®¾ç½®:', data);
                    
                    // å°†é€šç”¨è®¾ç½®åº”ç”¨åˆ°è¡¨å?                    if (data.systemLanguage) {
                        document.getElementById('systemLanguage').value = data.systemLanguage;
                    }
                    if (data.timezone) {
                        document.getElementById('timezone').value = data.timezone;
                    }
                    if (data.theme) {
                        document.getElementById('theme').value = data.theme;
                    }
                    if (data.autoUpdate !== undefined) {
                        document.getElementById('autoUpdate').checked = data.autoUpdate;
                    }
                    if (data.enableNotification !== undefined) {
                        document.getElementById('enableNotification').checked = data.enableNotification;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½é€šç”¨è®¾ç½®å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                });
            
            // ä»åç«¯åŠ è½½ç­–ç•¥å‚æ•?            fetch('/api/strategy/params')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ç­–ç•¥å‚æ•°:', data);
                    
                    // å°†ç­–ç•¥å‚æ•°åº”ç”¨åˆ°è¡¨å•
                    if (data.peThreshold) {
                        document.getElementById('peThreshold').value = data.peThreshold;
                    }
                    if (data.roeThreshold) {
                        document.getElementById('roeThreshold').value = data.roeThreshold;
                    }
                    if (data.smaShort) {
                        document.getElementById('smaShort').value = data.smaShort;
                    }
                    if (data.smaLong) {
                        document.getElementById('smaLong').value = data.smaLong;
                    }
                    if (data.position_pct) {
                        document.getElementById('position_pct').value = data.position_pct;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ç­–ç•¥å‚æ•°å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                });
            
            // ä»åç«¯åŠ è½½æ•°æ®è®¾ç½?            fetch('/api/data/settings')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('æ•°æ®è®¾ç½®:', data);
                    
                    // å°†æ•°æ®è®¾ç½®åº”ç”¨åˆ°è¡¨å•
                    if (data.dataSource) {
                        document.getElementById('dataSource').value = data.dataSource;
                    }
                    if (data.cacheExpiry) {
                        document.getElementById('cacheExpiry').value = data.cacheExpiry;
                    }
                    if (data.enableCache !== undefined) {
                        document.getElementById('enableCache').checked = data.enableCache;
                    }
                    if (data.updateFrequency) {
                        document.getElementById('updateFrequency').value = data.updateFrequency;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ•°æ®è®¾ç½®å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                });
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            console.log('ä¿å­˜è®¾ç½®');
            
            // ä»è¡¨å•è·å–é€šç”¨è®¾ç½®
            const generalSettings = {
                systemLanguage: document.getElementById('systemLanguage').value,
                timezone: document.getElementById('timezone').value,
                theme: document.getElementById('theme').value,
                autoUpdate: document.getElementById('autoUpdate').checked,
                enableNotification: document.getElementById('enableNotification').checked
            };
            
            // ä»è¡¨å•è·å–æ•°æ®è®¾ç½?            const dataSettings = {
                dataSource: document.getElementById('dataSource').value,
                cacheExpiry: parseInt(document.getElementById('cacheExpiry').value),
                enableCache: document.getElementById('enableCache').checked,
                updateFrequency: parseInt(document.getElementById('updateFrequency').value)
            };
            
            console.log('é€šç”¨è®¾ç½®:', generalSettings);
            console.log('æ•°æ®è®¾ç½®:', dataSettings);
            
            // ä¿å­˜é€šç”¨è®¾ç½®åˆ°åç«?            fetch('/api/general/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(generalSettings)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error, status = ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('ä¿å­˜é€šç”¨è®¾ç½®ç»“æœ:', data);
                
                // ä¿å­˜æ•°æ®è®¾ç½®åˆ°åç«?                return fetch('/api/data/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataSettings)
                });
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error, status = ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('ä¿å­˜æ•°æ®è®¾ç½®ç»“æœ:', data);
                alert('è®¾ç½®ä¿å­˜æˆåŠŸ');
            })
            .catch(error => {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                alert('è®¾ç½®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ? ' + error.message);
            });
        }
        
        // æ¢å¤é»˜è®¤è®¾ç½®
        function resetSettings() {
            if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤è®¾ç½®å—ï¼?)) {
                console.log('æ¢å¤é»˜è®¤è®¾ç½®');
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ¢å¤é»˜è®¤è®¾ç½®çš„é€»è¾‘
                alert('é»˜è®¤è®¾ç½®å·²æ¢å¤?);
            }
        }
        
        // åŠ è½½è‚¡ç¥¨æ±?        function loadStockPool() {
            console.log('åŠ è½½è‚¡ç¥¨æ±?);
            fetch('/api/stockpool/info')
                .then(response => response.json())
                .then(data => {
                    console.log('è‚¡ç¥¨æ± æ•°æ?', data);
                    
                    // æ³¨æ„ï¼šæ˜ å°„è¡¨å†…å®¹åªèƒ½åœ¨ç³»ç»Ÿè®¾ç½®çš„è‚¡ç¥¨æ± ç®¡ç†é‡Œçš„æ˜ å°„è¡¨åŠŸèƒ½ä¿®æ”¹
                    // æ­¤å¤„ä¸å†ä»åç«¯æ›´æ–°æ˜ å°„è¡¨ï¼Œç¡®ä¿ç”¨æˆ·ä¿®æ”¹çš„æ˜ å°„è¡¨ä¸ä¼šè¢«è¦†ç›–
                    
                    updateStockList(data.current_pool);
                })
                .catch(error => {
                    console.error('åŠ è½½è‚¡ç¥¨æ± å¤±è´?', error);
                    alert('åŠ è½½è‚¡ç¥¨æ± å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                });
        }
        
        // æ›´æ–°è‚¡ç¥¨åˆ—è¡¨
        function updateStockList(stocks) {
            const stockList = document.querySelector('.stock-list');
            stockList.innerHTML = '';
            
            if (stocks.length === 0) {
                stockList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">è‚¡ç¥¨æ± ä¸ºç©?/div>';
                return;
            }
            
            stocks.forEach(symbol => {
                const stockItem = document.createElement('div');
                stockItem.className = 'stock-item';
                
                // è·å–è‚¡ç¥¨åç§°
                let stockName = 'æœªçŸ¥è‚¡ç¥¨';
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å…¨å±€è‚¡ç¥¨åç§°æ˜ å°„è¡¨ä¸­
                if (globalStockNames[symbol]) {
                    stockName = globalStockNames[symbol];
                } else {
                    // å°è¯•é€šè¿‡è‚¡ç¥¨ä»£ç çš„å‰å‡ ä½åˆ¤æ–­ç±»å‹
                    const prefix = symbol.substring(0, 1);
                    const prefix3 = symbol.substring(0, 3);
                    
                    if (prefix3 === '688') {
                        stockName = `ç§‘åˆ›æ¿è‚¡ç¥?(${symbol})`;
                    } else if (prefix === '6') {
                        stockName = `æ²ªå¸‚è‚¡ç¥¨ (${symbol})`;
                    } else if (prefix === '0') {
                        stockName = `æ·±å¸‚è‚¡ç¥¨ (${symbol})`;
                    } else if (prefix === '3') {
                        stockName = `åˆ›ä¸šæ¿è‚¡ç¥?(${symbol})`;
                    } else if (prefix === '8') {
                        stockName = `åŒ—äº¤æ‰€è‚¡ç¥¨ (${symbol})`;
                    } else {
                        stockName = `æœªçŸ¥è‚¡ç¥¨ (${symbol})`;
                    }
                }
                
                stockItem.innerHTML = `
                    <div class="stock-info">
                        <span class="stock-symbol">${symbol}</span>
                        <span class="stock-name">${stockName}</span>
                    </div>
                    <button class="btn btn-secondary" onclick="removeStock('${symbol}')">åˆ é™¤</button>
                `;
                
                stockList.appendChild(stockItem);
            });
        }
        
        // å¯¼å…¥è‚¡ç¥¨æ±?        function importStockPool() {
            console.log('å¯¼å…¥è‚¡ç¥¨æ±?);
            
            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.txt';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const content = event.target.result;
                        let stocks;
                        
                        // å°è¯•è§£æJSON
                        try {
                            const data = JSON.parse(content);
                            stocks = Array.isArray(data) ? data : data.stocks || [];
                        } catch (jsonError) {
                            // å°è¯•è§£ææ–‡æœ¬æ–‡ä»¶ï¼ˆæ¯è¡Œä¸€ä¸ªè‚¡ç¥¨ä»£ç ï¼‰
                            stocks = content.split('\n')
                                .map(line => line.trim())
                                .filter(line => line && /^\d{6}$/.test(line));
                        }
                        
                        if (!stocks || stocks.length === 0) {
                            alert('æ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç ');
                            return;
                        }
                        
                        // è°ƒç”¨åç«¯APIæ›´æ–°è‚¡ç¥¨æ± ï¼Œè®¾ç½®adjust: falseä»¥ä¿ç•™æ‰€æœ‰å¯¼å…¥çš„è‚¡ç¥¨
                        fetch('/api/stockpool/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ stocks: stocks, adjust: false })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('å¯¼å…¥è‚¡ç¥¨æ± ç»“æ?', data);
                            if (data.error) {
                                alert(`å¯¼å…¥å¤±è´¥: ${data.error}`);
                            } else {
                                alert(`å¯¼å…¥æˆåŠŸ: å…±å¯¼å…?${stocks.length} åªè‚¡ç¥¨`);
                                loadStockPool(); // é‡æ–°åŠ è½½è‚¡ç¥¨æ±?                            }
                        })
                        .catch(error => {
                            console.error('å¯¼å…¥è‚¡ç¥¨æ± å¤±è´?', error);
                            alert('å¯¼å…¥è‚¡ç¥¨æ± å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                        });
                    } catch (error) {
                        console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
                        alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // å¯¼å‡ºè‚¡ç¥¨æ±?        function exportStockPool() {
            console.log('å¯¼å‡ºè‚¡ç¥¨æ±?);
            
            // è·å–è‚¡ç¥¨æ± æ•°æ?            fetch('/api/stockpool/info')
                .then(response => response.json())
                .then(data => {
                    const stocks = data.current_pool || [];
                    
                    if (!stocks || stocks.length === 0) {
                        alert('è‚¡ç¥¨æ± ä¸ºç©ºï¼Œæ— éœ€å¯¼å‡º');
                        return;
                    }
                    
                    // å‡†å¤‡å¯¼å‡ºæ•°æ®
                    const exportData = {
                        stocks: stocks,
                        last_updated: new Date().toISOString(),
                        pool_size: stocks.length
                    };
                    
                    // åˆ›å»ºJSONå­—ç¬¦ä¸?                    const jsonString = JSON.stringify(exportData, null, 2);
                    
                    // åˆ›å»ºBlobå¯¹è±¡
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `stock_pool_${new Date().toISOString().split('T')[0]}.json`;
                    
                    // è§¦å‘ä¸‹è½½
                    document.body.appendChild(a);
                    a.click();
                    
                    // æ¸…ç†
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    console.log('è‚¡ç¥¨æ± å¯¼å‡ºæˆåŠ?', stocks.length, 'åªè‚¡ç¥?);
                })
                .catch(error => {
                    console.error('å¯¼å‡ºè‚¡ç¥¨æ± å¤±è´?', error);
                    alert('å¯¼å‡ºè‚¡ç¥¨æ± å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                });
        }
        
        // æ¸…ç©ºè‚¡ç¥¨æ±?        function clearStockPool() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè‚¡ç¥¨æ± å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€?)) {
                console.log('æ¸…ç©ºè‚¡ç¥¨æ±?);
                
                // è°ƒç”¨åç«¯APIæ¸…ç©ºè‚¡ç¥¨æ±?                fetch('/api/stockpool/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('æ¸…ç©ºè‚¡ç¥¨æ± ç»“æ?', data);
                    if (data.error) {
                        alert(`æ¸…ç©ºå¤±è´¥: ${data.error}`);
                    } else {
                        alert(`æ¸…ç©ºæˆåŠŸ: ${data.message}`);
                        loadStockPool(); // é‡æ–°åŠ è½½è‚¡ç¥¨æ±?                    }
                })
                .catch(error => {
                    console.error('æ¸…ç©ºè‚¡ç¥¨æ± å¤±è´?', error);
                    alert('æ¸…ç©ºè‚¡ç¥¨æ± å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                });
            }
        }
        
        // æ‰“å¼€è‚¡ç¥¨åç§°æ˜ å°„è¡¨ç¼–è¾‘æ¨¡æ€æ¡†
        function updateStockNames() {
            console.log('æ‰“å¼€è‚¡ç¥¨åç§°æ˜ å°„è¡¨ç¼–è¾?);
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                width: 80%;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            `;
            
            // æ¨¡æ€æ¡†æ ‡é¢˜
            const modalTitle = document.createElement('h2');
            modalTitle.textContent = 'ç¼–è¾‘è‚¡ç¥¨åç§°æ˜ å°„è¡?;
            modalTitle.style.marginBottom = '20px';
            modalContent.appendChild(modalTitle);
            
            // æœç´¢å’Œæ·»åŠ åŒºåŸ?            const searchAddArea = document.createElement('div');
            searchAddArea.style.cssText = `
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                padding: 15px;
                background: #f5f5f5;
                border-radius: 8px;
                flex-wrap: wrap;
            `;
            
            // æœç´¢è¾“å…¥
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'æœç´¢è‚¡ç¥¨ä»£ç æˆ–åç§?;
            searchInput.style.flex = '1';
            searchInput.style.minWidth = '200px';
            searchInput.style.padding = '10px';
            searchInput.style.border = '1px solid #ddd';
            searchInput.style.borderRadius = '4px';
            searchAddArea.appendChild(searchInput);
            
            // å¯¼å…¥æŒ‰é’®
            const importButton = document.createElement('button');
            importButton.textContent = 'å¯¼å…¥';
            importButton.style.cssText = `
                padding: 10px 20px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            importButton.onclick = function() {
                importMappings();
            };
            searchAddArea.appendChild(importButton);
            
            // å¯¼å‡ºæŒ‰é’®
            const exportButton = document.createElement('button');
            exportButton.textContent = 'å¯¼å‡º';
            exportButton.style.cssText = `
                padding: 10px 20px;
                background: #17a2b8;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            exportButton.onclick = function() {
                exportMappings();
            };
            searchAddArea.appendChild(exportButton);
            
            // æ‰¹é‡åˆ é™¤æŒ‰é’®
            const batchDeleteButton = document.createElement('button');
            batchDeleteButton.textContent = 'æ‰¹é‡åˆ é™¤';
            batchDeleteButton.style.cssText = `
                padding: 10px 20px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            batchDeleteButton.onclick = function() {
                batchDeleteMappings();
            };
            searchAddArea.appendChild(batchDeleteButton);
            
            // æ·»åŠ æŒ‰é’®
            const addButton = document.createElement('button');
            addButton.textContent = 'æ·»åŠ æ˜ å°„';
            addButton.style.cssText = `
                padding: 10px 20px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            addButton.onclick = function() {
                addNewMapping();
            };
            searchAddArea.appendChild(addButton);
            modalContent.appendChild(searchAddArea);
            
            // æ˜ å°„è¡¨å®¹å™?            const mappingContainer = document.createElement('div');
            mappingContainer.id = 'mappingContainer';
            mappingContainer.style.cssText = `
                display: grid;
                grid-template-columns: 150px 1fr 100px;
                gap: 10px;
                margin-bottom: 20px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 8px;
            `;
            
            // è¡¨å¤´
            const headerCode = document.createElement('div');
            headerCode.textContent = 'è‚¡ç¥¨ä»£ç ';
            headerCode.style.fontWeight = 'bold';
            headerCode.style.padding = '10px';
            headerCode.style.background = '#f0f0f0';
            mappingContainer.appendChild(headerCode);
            
            const headerName = document.createElement('div');
            headerName.textContent = 'è‚¡ç¥¨åç§°';
            headerName.style.fontWeight = 'bold';
            headerName.style.padding = '10px';
            headerName.style.background = '#f0f0f0';
            mappingContainer.appendChild(headerName);
            
            const headerAction = document.createElement('div');
            headerAction.textContent = 'æ“ä½œ';
            headerAction.style.fontWeight = 'bold';
            headerAction.style.padding = '10px';
            headerAction.style.background = '#f0f0f0';
            mappingContainer.appendChild(headerAction);
            
            // å¡«å……å½“å‰æ˜ å°„è¡?            Object.entries(globalStockNames).forEach(([code, name]) => {
                addMappingRow(mappingContainer, code, name);
            });
            
            modalContent.appendChild(mappingContainer);
            
            // æŒ‰é’®åŒºåŸŸ
            const buttonArea = document.createElement('div');
            buttonArea.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: flex-end;
                margin-top: 20px;
            `;
            
            // ä¿å­˜æŒ‰é’®
            const saveButton = document.createElement('button');
            saveButton.textContent = 'ä¿å­˜æ›´æ”¹';
            saveButton.style.cssText = `
                padding: 12px 30px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
                font-size: 14px;
            `;
            saveButton.onclick = function() {
                saveMappingChanges();
                document.body.removeChild(modal);
            };
            buttonArea.appendChild(saveButton);
            
            // å–æ¶ˆæŒ‰é’®
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'å–æ¶ˆ';
            cancelButton.style.cssText = `
                padding: 12px 30px;
                background: #f0f0f0;
                color: #333;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
                font-size: 14px;
            `;
            cancelButton.onclick = function() {
                document.body.removeChild(modal);
            };
            buttonArea.appendChild(cancelButton);
            modalContent.appendChild(buttonArea);
            
            // å…³é—­æ¨¡æ€æ¡†
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // æ·»åŠ æ–°æ˜ å°?            function addNewMapping() {
                const newCode = prompt('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ?');
                if (newCode && /^\d{6}$/.test(newCode)) {
                    if (!globalStockNames[newCode]) {
                        const newName = prompt('è¯·è¾“å…¥è‚¡ç¥¨åç§?');
                        if (newName) {
                            globalStockNames[newCode] = newName;
                            addMappingRow(mappingContainer, newCode, newName);
                        }
                    } else {
                        alert('è¯¥è‚¡ç¥¨ä»£ç å·²å­˜åœ¨æ˜ å°„');
                    }
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½è‚¡ç¥¨ä»£ç ?);
                }
            }
            
            // æ·»åŠ æ˜ å°„è¡?            function addMappingRow(container, code, name) {
                // ä»£ç è¾“å…¥
                const codeInput = document.createElement('input');
                codeInput.type = 'text';
                codeInput.value = code;
                codeInput.style.padding = '8px';
                codeInput.style.border = '1px solid #ddd';
                codeInput.style.borderRadius = '4px';
                codeInput.style.fontSize = '14px';
                container.appendChild(codeInput);
                
                // åç§°è¾“å…¥
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = name;
                nameInput.style.padding = '8px';
                nameInput.style.border = '1px solid #ddd';
                nameInput.style.borderRadius = '4px';
                nameInput.style.fontSize = '14px';
                container.appendChild(nameInput);
                
                // åˆ é™¤æŒ‰é’®
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'åˆ é™¤';
                deleteButton.style.cssText = `
                    padding: 8px 12px;
                    background: #ff4757;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                `;
                deleteButton.onclick = function() {
                    delete globalStockNames[code];
                    container.removeChild(codeInput);
                    container.removeChild(nameInput);
                    container.removeChild(deleteButton);
                };
                container.appendChild(deleteButton);
            }
            
            // ä¿å­˜æ˜ å°„æ›´æ”¹
            function saveMappingChanges() {
                const inputs = mappingContainer.querySelectorAll('input');
                const newMappings = {};
                
                for (let i = 0; i < inputs.length; i += 2) {
                    const code = inputs[i].value.trim();
                    const name = inputs[i + 1].value.trim();
                    if (code && name && /^\d{6}$/.test(code)) {
                        newMappings[code] = name;
                    }
                }
                
                // æ¸…ç©ºæ—§æ˜ å°„è¡¨å¹¶æ›´æ–?                Object.keys(globalStockNames).forEach(key => {
                    delete globalStockNames[key];
                });
                Object.assign(globalStockNames, newMappings);
                console.log('è‚¡ç¥¨åç§°æ˜ å°„è¡¨å·²æ›´æ–°:', globalStockNames);
                
                // ä¿å­˜åˆ°localStorageï¼Œä»¥ä¾¿å…¶ä»–é¡µé¢ï¼ˆå¦‚å›æµ‹é¡µé¢ï¼‰å¯ä»¥ä½¿ç”¨
                try {
                    localStorage.setItem('stockNames', JSON.stringify(globalStockNames));
                    console.log('è‚¡ç¥¨åç§°æ˜ å°„è¡¨å·²ä¿å­˜åˆ°localStorage');
                } catch (error) {
                    console.error('ä¿å­˜åˆ°localStorageå¤±è´¥:', error);
                }
                
                // æ›´æ–°è‚¡ç¥¨åˆ—è¡¨æ˜¾ç¤º
                loadStockPool();
                
                alert('è‚¡ç¥¨åç§°æ˜ å°„è¡¨æ›´æ–°æˆåŠ?);
            }
            
            // å¯¼å…¥æ˜ å°„è¡?            function importMappings() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.txt';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        let importCount = 0;
                        
                        lines.forEach(line => {
                            line = line.trim();
                            if (!line) return;
                            
                            const parts = line.split(/[,\tï¼Œ]+/);
                            if (parts.length >= 2) {
                                const code = parts[0].trim();
                                const name = parts[1].trim();
                                
                                if (/^\d{6}$/.test(code) && name) {
                                    globalStockNames[code] = name;
                                    importCount++;
                                }
                            }
                        });
                        
                        // æ¸…ç©ºå¹¶é‡æ–°å¡«å……æ˜ å°„è¡¨
                        while (mappingContainer.children.length > 3) {
                            mappingContainer.removeChild(mappingContainer.lastChild);
                            mappingContainer.removeChild(mappingContainer.lastChild);
                            mappingContainer.removeChild(mappingContainer.lastChild);
                        }
                        
                        Object.entries(globalStockNames).forEach(([code, name]) => {
                            addMappingRow(mappingContainer, code, name);
                        });
                        
                        alert(`æˆåŠŸå¯¼å…¥ ${importCount} æ¡æ˜ å°„æ•°æ®`);
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
            
            // å¯¼å‡ºæ˜ å°„è¡?            function exportMappings() {
                const mappings = Object.entries(globalStockNames);
                if (mappings.length === 0) {
                    alert('æ˜ å°„è¡¨ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');
                    return;
                }
                
                let csvContent = 'è‚¡ç¥¨ä»£ç ,è‚¡ç¥¨åç§°\n';
                mappings.forEach(([code, name]) => {
                    csvContent += `${code},${name}\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'è‚¡ç¥¨åç§°æ˜ å°„è¡?csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // æ‰¹é‡åˆ é™¤æ˜ å°„
            function batchDeleteMappings() {
                const codesToDelete = prompt('è¯·è¾“å…¥è¦åˆ é™¤çš„è‚¡ç¥¨ä»£ç ï¼Œå¤šä¸ªä»£ç ç”¨é€—å·åˆ†éš”ï¼?);
                if (!codesToDelete) return;
                
                const codes = codesToDelete.split(/[,ï¼Œ\s]+/).filter(code => /^\d{6}$/.test(code));
                
                if (codes.length === 0) {
                    alert('æœªè¾“å…¥æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç ');
                    return;
                }
                
                let deletedCount = 0;
                codes.forEach(code => {
                    if (globalStockNames[code]) {
                        delete globalStockNames[code];
                        deletedCount++;
                    }
                });
                
                // æ¸…ç©ºå¹¶é‡æ–°å¡«å……æ˜ å°„è¡¨
                while (mappingContainer.children.length > 3) {
                    mappingContainer.removeChild(mappingContainer.lastChild);
                    mappingContainer.removeChild(mappingContainer.lastChild);
                    mappingContainer.removeChild(mappingContainer.lastChild);
                }
                
                Object.entries(globalStockNames).forEach(([code, name]) => {
                    addMappingRow(mappingContainer, code, name);
                });
                
                alert(`æˆåŠŸåˆ é™¤ ${deletedCount} æ¡æ˜ å°„æ•°æ®`);
            }
        }
        
        // æ·»åŠ è‚¡ç¥¨
        function addStock() {
            const symbol = prompt('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ?);
            if (symbol) {
                console.log('æ·»åŠ è‚¡ç¥¨:', symbol);
                
                // éªŒè¯è‚¡ç¥¨ä»£ç æ ¼å¼
                if (!/^\d{6}$/.test(symbol)) {
                    alert('è‚¡ç¥¨ä»£ç æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥6ä½æ•°å­?);
                    return;
                }
                
                // è°ƒç”¨åç«¯APIæ·»åŠ è‚¡ç¥¨
                fetch('/api/stockpool/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stock_code: symbol })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('æ·»åŠ è‚¡ç¥¨ç»“æœ:', data);
                    if (data.error) {
                        alert(`æ·»åŠ å¤±è´¥: ${data.error}`);
                    } else {
                        alert(`æ·»åŠ æˆåŠŸ: ${data.message}`);
                        loadStockPool(); // é‡æ–°åŠ è½½è‚¡ç¥¨æ±?                    }
                })
                .catch(error => {
                    console.error('æ·»åŠ è‚¡ç¥¨å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                    alert('æ·»åŠ è‚¡ç¥¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ? ' + error.message);
                });
            }
        }
        
        // ç§»é™¤è‚¡ç¥¨
        function removeStock(symbol) {
            if (confirm(`ç¡®å®šè¦ä»è‚¡ç¥¨æ± ä¸­ç§»é™¤ ${symbol} å—ï¼Ÿ`)) {
                console.log('ç§»é™¤è‚¡ç¥¨:', symbol);
                
                // è°ƒç”¨åç«¯APIç§»é™¤è‚¡ç¥¨
                fetch('/api/stockpool/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stock_code: symbol })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ç§»é™¤è‚¡ç¥¨ç»“æœ:', data);
                    if (data.error) {
                        alert(`ç§»é™¤å¤±è´¥: ${data.error}`);
                    } else {
                        alert(`ç§»é™¤æˆåŠŸ: ${data.message}`);
                        loadStockPool(); // é‡æ–°åŠ è½½è‚¡ç¥¨æ±?                    }
                })
                .catch(error => {
                    console.error('ç§»é™¤è‚¡ç¥¨å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                    alert('ç§»é™¤è‚¡ç¥¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ? ' + error.message);
                });
            }
        }
        
        // åˆå§‹åŒ–æŒä»“è¡¨
        function initPositionTable() {
            const warningMessage = 'âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºç°æœ‰æŒä»“æ•°æ®å¹¶åˆ›å»ºé»˜è®¤æŒä»“ï¼\n\n' +
                                  'é»˜è®¤æŒä»“åŒ…å«ä»¥ä¸‹è‚¡ç¥¨ï¼š\n' +
                                  'â€?600519 è´µå·èŒ…å°\n' +
                                  'â€?000858 äº”ç²®æ¶²\n' +
                                  'â€?002371 åŒ—æ–¹ååˆ›\n\n' +
                                  'æ³¨æ„ï¼šè¿™äº›é»˜è®¤è‚¡ç¥¨å¯èƒ½ä¸åœ¨æ‚¨çš„è‚¡ç¥¨æ± ä¸­ï¼\n\n' +
                                  'ç¡®å®šè¦ç»§ç»­å—ï¼?;
            
            if (confirm(warningMessage)) {
                const secondConfirm = 'å†æ¬¡ç¡®è®¤ï¼šæ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŒä»“å¹¶åˆ›å»ºé»˜è®¤æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼?;
                if (confirm(secondConfirm)) {
                    console.log('åˆå§‹åŒ–æŒä»“è¡¨');
                    
                    // è°ƒç”¨åç«¯APIåˆå§‹åŒ–æŒä»“è¡¨
                    fetch('/api/plan/position/init', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('HTTP error, status = ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('åˆå§‹åŒ–æŒä»“è¡¨ç»“æœ:', data);
                        if (data.error) {
                            alert(`åˆå§‹åŒ–å¤±è´? ${data.error}`);
                        } else {
                            alert(`åˆå§‹åŒ–æˆåŠ? ${data.message}`);
                            loadPositions(); // é‡æ–°åŠ è½½æŒä»“æ•°æ®
                        }
                    })
                    .catch(error => {
                        console.error('åˆå§‹åŒ–æŒä»“è¡¨å¤±è´¥:', error);
                        console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                        alert('åˆå§‹åŒ–æŒä»“è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ? ' + error.message);
                    });
                }
            }
        }
        
        // åŠ è½½æŒä»“æ•°æ®
        function loadPositions() {
            console.log('åŠ è½½æŒä»“æ•°æ®');
            
            // ä»åç«¯è·å–ç°é‡‘é…ç½?            fetch('/api/config/available_cash')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(config => {
                    console.log('ä»åç«¯è¯»å–çš„ç°é‡‘é…ç½®:', config);
                    
                    // æ›´æ–°localStorage
                    localStorage.setItem('availableCash', config.available_cash.toString());
                    localStorage.setItem('originalCash', config.original_cash.toString());
                    
                    // æ›´æ–°è¾“å…¥æ¡†çš„å€?                    document.getElementById('customAvailableCash').value = config.available_cash;
                    
                    // æ„å»ºè¯·æ±‚å‚æ•°
                    const availableCashParam = `?available_cash=${config.available_cash}`;
                    const originalCashParam = `&original_cash=${config.original_cash}`;
                    
                    console.log('å¯ç”¨ç°é‡‘å‚æ•°:', availableCashParam);
                    console.log('åŸå§‹èµ„é‡‘å‚æ•°:', originalCashParam);
                    
                    // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­?                    const timestamp = new Date().getTime();
                    
                    // è°ƒç”¨åç«¯APIè·å–æŒä»“æ•°æ®
                    const url = `/api/plan/position${availableCashParam}${originalCashParam}&_t=${timestamp}`;
                    console.log('å®Œæ•´URL:', url);
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('HTTP error, status = ' + response.status);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('æŒä»“æ•°æ®:', data);
                            
                            // æ›´æ–°èµ„äº§æ¦‚è§ˆ
                            document.getElementById('originalCash').textContent = formatCurrency(data.original_cash || 200000.00);
                            document.getElementById('totalAssets').textContent = formatCurrency(data.total_assets);
                            document.getElementById('positionValue').textContent = formatCurrency(data.position_value);
                            document.getElementById('availableCash').textContent = formatCurrency(data.available_cash);
                            
                            updatePositionList(data.positions);
                        })
                        .catch(error => {
                            console.error('åŠ è½½æŒä»“æ•°æ®å¤±è´¥:', error);
                            console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                            alert('åŠ è½½æŒä»“æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ? ' + error.message);
                        });
                })
                .catch(error => {
                    console.error('åŠ è½½ç°é‡‘é…ç½®å¤±è´¥:', error);
                    // å‡ºé”™æ—¶ä½¿ç”¨localStorageçš„å€?                    loadPositionsWithLocalStorage();
                });
        }
        
        // æ ¼å¼åŒ–è´§å¸?        function formatCurrency(value) {
            return 'Â¥' + value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // ä½¿ç”¨localStorageåŠ è½½æŒä»“æ•°æ®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function loadPositionsWithLocalStorage() {
            console.log('ä½¿ç”¨localStorageåŠ è½½æŒä»“æ•°æ®');
            
            // ä¼˜å…ˆä»localStorageè·å–å¯ç”¨ç°é‡‘å€?            let availableCashParam = '';
            try {
                const storedCash = localStorage.getItem('availableCash');
                console.log('ä»localStorageè¯»å–çš„å¯ç”¨ç°é‡?', storedCash);
                if (storedCash) {
                    availableCashParam = `?available_cash=${storedCash}`;
                    // æ›´æ–°è¾“å…¥æ¡†çš„å€?                    document.getElementById('customAvailableCash').value = storedCash;
                } else {
                    // è·å–è‡ªå®šä¹‰å¯ç”¨ç°é‡‘å€?                    const customCash = document.getElementById('customAvailableCash').value;
                    console.log('ä»è¾“å…¥æ¡†è·å–çš„å¯ç”¨ç°é‡?', customCash);
                    availableCashParam = customCash ? `?available_cash=${customCash}` : '';
                }
            } catch (error) {
                console.error('è¯»å–localStorageä¸­çš„å¯ç”¨ç°é‡‘å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä½¿ç”¨è¾“å…¥æ¡†çš„å€?                const customCash = document.getElementById('customAvailableCash').value;
                availableCashParam = customCash ? `?available_cash=${customCash}` : '';
            }
            
            console.log('å¯ç”¨ç°é‡‘å‚æ•°:', availableCashParam);
            
            // ä¼˜å…ˆä»localStorageè·å–åŸå§‹èµ„é‡‘å€?            let originalCashParam = '';
            try {
                const storedCash = localStorage.getItem('originalCash');
                console.log('ä»localStorageè¯»å–çš„åŸå§‹èµ„é‡?', storedCash);
                if (storedCash) {
                    if (availableCashParam) {
                        originalCashParam = `&original_cash=${storedCash}`;
                    } else {
                        originalCashParam = `?original_cash=${storedCash}`;
                    }
                    // æ›´æ–°è¾“å…¥æ¡†çš„å€?                    document.getElementById('customOriginalCash').value = storedCash;
                } else {
                    // è·å–è‡ªå®šä¹‰åŸå§‹èµ„é‡‘å€?                    const customCash = document.getElementById('customOriginalCash').value;
                    console.log('ä»è¾“å…¥æ¡†è·å–çš„åŸå§‹èµ„é‡?', customCash);
                    if (customCash) {
                        if (availableCashParam) {
                            originalCashParam = `&original_cash=${customCash}`;
                        } else {
                            originalCashParam = `?original_cash=${customCash}`;
                        }
                    }
                }
            } catch (error) {
                console.error('è¯»å–localStorageä¸­çš„åŸå§‹èµ„é‡‘å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä½¿ç”¨è¾“å…¥æ¡†çš„å€?                const customCash = document.getElementById('customOriginalCash').value;
                if (customCash) {
                    if (availableCashParam) {
                        originalCashParam = `&original_cash=${customCash}`;
                    } else {
                        originalCashParam = `?original_cash=${customCash}`;
                    }
                }
            }
            
            console.log('åŸå§‹èµ„é‡‘å‚æ•°:', originalCashParam);
            
            // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­?            const timestamp = new Date().getTime();
            
            // è°ƒç”¨åç«¯APIè·å–æŒä»“æ•°æ®
            const url = `/api/plan/position${availableCashParam}${originalCashParam}&_t=${timestamp}`;
            console.log('å®Œæ•´URL:', url);
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('æŒä»“æ•°æ®:', data);
                    
                    // æ›´æ–°èµ„äº§æ¦‚è§ˆ
                    document.getElementById('totalAssets').textContent = data.total_assets ? data.total_assets.toFixed(2) : '--';
                    document.getElementById('positionValue').textContent = data.position_value ? data.position_value.toFixed(2) : '--';
                    document.getElementById('availableCash').textContent = data.available_cash ? data.available_cash.toFixed(2) : '--';
                    
                    // ç›´æ¥ä»localStorageè¯»å–å¹¶æ˜¾ç¤ºåŸå§‹èµ„é‡?                    const originalCash = localStorage.getItem('originalCash');
                    console.log('ä»localStorageè¯»å–çš„åŸå§‹èµ„é‡?', originalCash);
                    if (originalCash) {
                        document.getElementById('originalCash').textContent = parseFloat(originalCash).toFixed(2);
                        document.getElementById('customOriginalCash').value = originalCash;
                    } else {
                        document.getElementById('originalCash').textContent = '--';
                    }
                    
                    updatePositionList(data.positions);
                })
                .catch(error => {
                    console.error('åŠ è½½æŒä»“æ•°æ®å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                    alert('åŠ è½½æŒä»“æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ? ' + error.message);
                });
        }
        
        // æ›´æ–°å¯ç”¨ç°é‡‘
        function updateAvailableCash() {
            const customCash = document.getElementById('customAvailableCash').value;
            if (customCash) {
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('availableCash', customCash);
                
                // ä¿å­˜åˆ°åç«¯é…ç½®æ–‡ä»?                const originalCash = localStorage.getItem('originalCash') || 200000.00;
                fetch('/api/config/available_cash', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        available_cash: parseFloat(customCash),
                        original_cash: parseFloat(originalCash)
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ç°é‡‘é…ç½®å·²ä¿å­˜åˆ°åç«¯:', data);
                    alert('å¯ç”¨ç°é‡‘å·²æ›´æ–?);
                })
                .catch(error => {
                    console.error('ä¿å­˜ç°é‡‘é…ç½®å¤±è´¥:', error);
                    alert('ä¿å­˜ç°é‡‘é…ç½®å¤±è´¥ï¼Œä½†å·²æ›´æ–°æœ¬åœ°æ˜¾ç¤?);
                });
            }
            loadPositions();
        }
        
        // æ›´æ–°åŸå§‹èµ„é‡‘
        function updateOriginalCash() {
            const customCash = document.getElementById('customOriginalCash').value;
            // ä¿å­˜åˆ°localStorage
            if (customCash) {
                localStorage.setItem('originalCash', customCash);
            }
            loadPositions();
        }
        
        // æ›´æ–°æŒä»“åˆ—è¡¨
        function updatePositionList(positions) {
            const positionList = document.getElementById('position-list');
            positionList.innerHTML = '';
            
            if (!positions || positions.length === 0) {
                positionList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æŒä»“è¡¨ä¸ºç©?/div>';
                return;
            }
            
            positions.forEach(position => {
                const positionItem = document.createElement('div');
                positionItem.className = 'stock-item';
                
                const positionAmount = position.quantity * position.current_price;
                
                positionItem.innerHTML = `
                    <div class="stock-info">
                        <span class="stock-symbol">${position.symbol}</span>
                        <span class="stock-name">${position.name}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: #666;">æ•°é‡: ${position.quantity}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: #666;">æˆæœ¬: ${position.cost_price.toFixed(2)}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: #666;">ç°ä»·: ${position.current_price.toFixed(2)}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: #666; font-weight: bold;">æŒä»“é‡‘é¢: ${positionAmount.toFixed(2)}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: ${position.profit_loss >= 0 ? '#e74c3c' : '#27ae60'};">ç›ˆäº: ${position.profit_loss.toFixed(2)}</span>
                        <span style="margin-left: 15px; font-size: 12px; color: ${position.profit_loss_percent >= 0 ? '#e74c3c' : '#27ae60'};">${position.profit_loss_percent.toFixed(2)}%</span>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-primary" onclick="editPosition('${position.symbol}')">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deletePosition('${position.symbol}')">åˆ é™¤</button>
                    </div>
                `;
                
                positionList.appendChild(positionItem);
            });
        }
        
        // æ·»åŠ æŒä»“
        function addPosition() {
            console.log('æ·»åŠ æŒä»“');
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                width: 400px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            `;
            
            // æ¨¡æ€æ¡†æ ‡é¢˜
            const modalTitle = document.createElement('h2');
            modalTitle.textContent = 'æ·»åŠ æŒä»“';
            modalTitle.style.marginBottom = '20px';
            modalContent.appendChild(modalTitle);
            
            // è¡¨å•
            const form = document.createElement('div');
            form.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">è‚¡ç¥¨ä»£ç </label>
                    <input type="text" id="symbol" placeholder="è¯·è¾“å…?ä½è‚¡ç¥¨ä»£ç ? style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">è‚¡ç¥¨åç§°</label>
                    <input type="text" id="name" placeholder="è‡ªåŠ¨å¡«å……" disabled style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">æŒä»“æ•°é‡</label>
                    <input type="number" id="quantity" placeholder="è¯·è¾“å…¥æŒä»“æ•°é‡? style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">æˆæœ¬ä»?/label>
                    <input type="number" id="cost_price" step="0.01" placeholder="è¯·è¾“å…¥æˆæœ¬ä»·" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰ä»?/label>
                    <input type="number" id="current_price" step="0.01" placeholder="å®æ—¶è·å–" disabled style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                </div>
            `;
            modalContent.appendChild(form);
            
            // æ·»åŠ è‚¡ç¥¨ä»£ç è¾“å…¥äº‹ä»¶ï¼Œè‡ªåŠ¨å¡«å……è‚¡ç¥¨åç§?            const symbolInput = form.querySelector('#symbol');
            symbolInput.addEventListener('input', function() {
                const symbol = this.value.trim();
                const nameInput = form.querySelector('#name');
                
                if (symbol.length === 6 && /^\d{6}$/.test(symbol)) {
                    // ä»å…¨å±€è‚¡ç¥¨åç§°æ˜ å°„è¡¨ä¸­è·å–è‚¡ç¥¨åç§°
                    if (globalStockNames[symbol]) {
                        nameInput.value = globalStockNames[symbol];
                    } else {
                        nameInput.value = 'æœªçŸ¥è‚¡ç¥¨';
                    }
                } else {
                    nameInput.value = '';
                }
            });
            
            // æŒ‰é’®åŒºåŸŸ
            const buttonArea = document.createElement('div');
            buttonArea.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: flex-end;
                margin-top: 20px;
            `;
            
            // ä¿å­˜æŒ‰é’®
            const saveButton = document.createElement('button');
            saveButton.textContent = 'ä¿å­˜';
            saveButton.style.cssText = `
                padding: 10px 20px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            saveButton.onclick = function() {
                const symbol = document.getElementById('symbol').value;
                const quantity = document.getElementById('quantity').value;
                const cost_price = document.getElementById('cost_price').value;
                
                // éªŒè¯è¾“å…¥
                if (!symbol || !quantity || !cost_price) {
                    alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®?);
                    return;
                }
                
                if (!/^\d{6}$/.test(symbol)) {
                    alert('è‚¡ç¥¨ä»£ç æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥6ä½æ•°å­?);
                    return;
                }
                
                // æ„å»ºæŒä»“æ•°æ®ï¼ˆåªåŒ…å«å¿…å¡«å­—æ®µï¼Œè‚¡ç¥¨åç§°å’Œå½“å‰ä»·ç”±åç«¯å¤„ç†ï¼?                const positionData = {
                    symbol: symbol,
                    quantity: parseInt(quantity),
                    cost_price: parseFloat(cost_price)
                };
                
                // è°ƒç”¨åç«¯APIæ·»åŠ æŒä»“
                fetch('/api/plan/position', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(positionData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('æ·»åŠ æŒä»“ç»“æœ:', data);
                    if (data.error) {
                        alert(`æ·»åŠ å¤±è´¥: ${data.error}`);
                    } else {
                        alert(`æ·»åŠ æˆåŠŸ: ${data.message}`);
                        loadPositions(); // é‡æ–°åŠ è½½æŒä»“æ•°æ®
                        document.body.removeChild(modal);
                    }
                })
                .catch(error => {
                    console.error('æ·»åŠ æŒä»“å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                    alert('æ·»åŠ æŒä»“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ? ' + error.message);
                });
            };
            buttonArea.appendChild(saveButton);
            
            // å–æ¶ˆæŒ‰é’®
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'å–æ¶ˆ';
            cancelButton.style.cssText = `
                padding: 10px 20px;
                background: #f0f0f0;
                color: #333;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            `;
            cancelButton.onclick = function() {
                document.body.removeChild(modal);
            };
            buttonArea.appendChild(cancelButton);
            modalContent.appendChild(buttonArea);
            
            // å…³é—­æ¨¡æ€æ¡†
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }
        
        // ç¼–è¾‘æŒä»“
        function editPosition(symbol) {
            console.log('ç¼–è¾‘æŒä»“:', symbol);
            
            // è°ƒç”¨åç«¯APIè·å–æŒä»“æ•°æ®
            fetch('/api/plan/position')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    const position = data.positions.find(p => p.symbol === symbol);
                    if (!position) {
                        alert('æŒä»“æ•°æ®ä¸å­˜åœ?);
                        return;
                    }
                    
                    // åˆ›å»ºæ¨¡æ€æ¡†
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    `;
                    
                    // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        padding: 30px;
                        border-radius: 10px;
                        width: 400px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    `;
                    
                    // æ¨¡æ€æ¡†æ ‡é¢˜
                    const modalTitle = document.createElement('h2');
                    modalTitle.textContent = 'ç¼–è¾‘æŒä»“';
                    modalTitle.style.marginBottom = '20px';
                    modalContent.appendChild(modalTitle);
                    
                    // è¡¨å•
                    const form = document.createElement('div');
                    form.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">è‚¡ç¥¨ä»£ç </label>
                            <input type="text" id="symbol" value="${position.symbol}" disabled style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">è‚¡ç¥¨åç§°</label>
                            <input type="text" id="name" value="${position.name}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">æŒä»“æ•°é‡</label>
                            <input type="number" id="quantity" value="${position.quantity}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">æˆæœ¬ä»?/label>
                            <input type="number" id="cost_price" step="0.01" value="${position.cost_price}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰ä»?/label>
                            <input type="number" id="current_price" step="0.01" value="${position.current_price}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    `;
                    modalContent.appendChild(form);
                    
                    // æŒ‰é’®åŒºåŸŸ
                    const buttonArea = document.createElement('div');
                    buttonArea.style.cssText = `
                        display: flex;
                        gap: 15px;
                        justify-content: flex-end;
                        margin-top: 20px;
                    `;
                    
                    // ä¿å­˜æŒ‰é’®
                    const saveButton = document.createElement('button');
                    saveButton.textContent = 'ä¿å­˜';
                    saveButton.style.cssText = `
                        padding: 10px 20px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: 500;
                    `;
                    saveButton.onclick = function() {
                        const name = document.getElementById('name').value;
                        const quantity = document.getElementById('quantity').value;
                        const cost_price = document.getElementById('cost_price').value;
                        const current_price = document.getElementById('current_price').value;
                        
                        // éªŒè¯è¾“å…¥
                        if (!name || !quantity || !cost_price || !current_price) {
                            alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®?);
                            return;
                        }
                        
                        // æ„å»ºæŒä»“æ•°æ®
                        const positionData = {
                            name: name,
                            quantity: parseInt(quantity),
                            cost_price: parseFloat(cost_price),
                            current_price: parseFloat(current_price)
                        };
                        
                        // è°ƒç”¨åç«¯APIæ›´æ–°æŒä»“
                        fetch(`/api/plan/position/${symbol}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(positionData)
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('HTTP error, status = ' + response.status);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('æ›´æ–°æŒä»“ç»“æœ:', data);
                            if (data.error) {
                                alert(`æ›´æ–°å¤±è´¥: ${data.error}`);
                            } else {
                                alert(`æ›´æ–°æˆåŠŸ: ${data.message}`);
                                loadPositions(); // é‡æ–°åŠ è½½æŒä»“æ•°æ®
                                document.body.removeChild(modal);
                            }
                        })
                        .catch(error => {
                            console.error('æ›´æ–°æŒä»“å¤±è´¥:', error);
                            console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                            alert('æ›´æ–°æŒä»“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ? ' + error.message);
                        });
                    };
                    buttonArea.appendChild(saveButton);
                    
                    // å–æ¶ˆæŒ‰é’®
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'å–æ¶ˆ';
                    cancelButton.style.cssText = `
                        padding: 10px 20px;
                        background: #f0f0f0;
                        color: #333;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: 500;
                    `;
                    cancelButton.onclick = function() {
                        document.body.removeChild(modal);
                    };
                    buttonArea.appendChild(cancelButton);
                    modalContent.appendChild(buttonArea);
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    modal.onclick = function(e) {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    };
                    
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                })
                .catch(error => {
                    console.error('è·å–æŒä»“æ•°æ®å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                    alert('è·å–æŒä»“æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ? ' + error.message);
                });
        }
        
        // åˆ é™¤æŒä»“
        function deletePosition(symbol) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æŒä»?${symbol} å—ï¼Ÿ`)) {
                console.log('åˆ é™¤æŒä»“:', symbol);
                
                // è°ƒç”¨åç«¯APIåˆ é™¤æŒä»“
                fetch(`/api/plan/position/${symbol}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('åˆ é™¤æŒä»“ç»“æœ:', data);
                    if (data.error) {
                        alert(`åˆ é™¤å¤±è´¥: ${data.error}`);
                    } else {
                        alert(`åˆ é™¤æˆåŠŸ: ${data.message}`);
                        loadPositions(); // é‡æ–°åŠ è½½æŒä»“æ•°æ®
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤æŒä»“å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                    alert('åˆ é™¤æŒä»“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ? ' + error.message);
                });
            }
        }
        
        // å®šæ—¶ä»»åŠ¡ç›¸å…³å‡½æ•°
        let scheduledTimes = [];
        
        // åŠ è½½å®šæ—¶ä»»åŠ¡é…ç½®
        function loadSchedulerConfig() {
            fetch('/api/scheduler/config')
                .then(response => response.json())
                .then(data => {
                    scheduledTimes = data.scheduled_times || [];
                    updateSchedulerStatus(data.is_running);
                    renderScheduledTimes();
                })
                .catch(error => {
                    console.error('åŠ è½½å®šæ—¶ä»»åŠ¡é…ç½®å¤±è´¥:', error);
                    document.getElementById('schedulerStatus').textContent = 'åŠ è½½å¤±è´¥';
                });
        }
        
        // æ›´æ–°è°ƒåº¦å™¨çŠ¶æ€æ˜¾ç¤?        function updateSchedulerStatus(isRunning) {
            const statusElement = document.getElementById('schedulerStatus');
            if (isRunning) {
                statusElement.textContent = 'è¿è¡Œä¸?;
                statusElement.style.color = '#27ae60';
            } else {
                statusElement.textContent = 'å·²åœæ­?;
                statusElement.style.color = '#e74c3c';
            }
        }
        
        // æ¸²æŸ“å®šæ—¶æ—¶é—´åˆ—è¡¨
        function renderScheduledTimes() {
            const container = document.getElementById('scheduledTimesList');
            if (scheduledTimes.length === 0) {
                container.innerHTML = '<div style="color: #999; text-align: center; padding: 10px;">æš‚æ— å®šæ—¶æ—¶é—´</div>';
                return;
            }
            
            container.innerHTML = scheduledTimes.map((time, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px;">
                    <div style="font-size: 16px; font-weight: 500; color: #333;">
                        ${String(time.hour).padStart(2, '0')}:${String(time.minute).padStart(2, '0')}
                    </div>
                    <button class="btn btn-secondary" onclick="removeScheduledTime(${index})" style="padding: 5px 10px; font-size: 12px;">åˆ é™¤</button>
                </div>
            `).join('');
        }
        
        // æ·»åŠ å®šæ—¶æ—¶é—´
        function addScheduledTime() {
            const hour = parseInt(document.getElementById('newHour').value);
            const minute = parseInt(document.getElementById('newMinute').value);
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ—¶é—´
            const exists = scheduledTimes.some(t => t.hour === hour && t.minute === minute);
            if (exists) {
                alert('è¯¥æ—¶é—´å·²å­˜åœ¨');
                return;
            }
            
            scheduledTimes.push({ hour, minute });
            scheduledTimes.sort((a, b) => a.hour * 60 + a.minute - (b.hour * 60 + b.minute));
            
            saveSchedulerConfig();
            renderScheduledTimes();
        }
        
        // åˆ é™¤å®šæ—¶æ—¶é—´
        function removeScheduledTime(index) {
            scheduledTimes.splice(index, 1);
            saveSchedulerConfig();
            renderScheduledTimes();
        }
        
        // ä¿å­˜å®šæ—¶ä»»åŠ¡é…ç½®
        function saveSchedulerConfig() {
            fetch('/api/scheduler/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    scheduled_times: scheduledTimes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`ä¿å­˜å¤±è´¥: ${data.error}`);
                } else {
                    console.log('å®šæ—¶ä»»åŠ¡é…ç½®å·²ä¿å­?);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜å®šæ—¶ä»»åŠ¡é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
            });
        }
        
        // å¯åŠ¨è°ƒåº¦å™?        function startScheduler() {
            fetch('/api/scheduler/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`å¯åŠ¨å¤±è´¥: ${data.error}`);
                } else {
                    updateSchedulerStatus(true);
                    alert('å®šæ—¶ä»»åŠ¡å·²å¯åŠ?);
                }
            })
            .catch(error => {
                console.error('å¯åŠ¨å®šæ—¶ä»»åŠ¡å¤±è´¥:', error);
                alert('å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
            });
        }
        
        // åœæ­¢è°ƒåº¦å™?        function stopScheduler() {
            fetch('/api/scheduler/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`åœæ­¢å¤±è´¥: ${data.error}`);
                } else {
                    updateSchedulerStatus(false);
                    alert('å®šæ—¶ä»»åŠ¡å·²åœæ­?);
                }
            })
            .catch(error => {
                console.error('åœæ­¢å®šæ—¶ä»»åŠ¡å¤±è´¥:', error);
                alert('åœæ­¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
            });
        }
        
        // åŠ è½½æ‰§è¡Œè®°å½•
        function loadSchedulerExecutionLog() {
            fetch('/api/scheduler/execution-log')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('åŠ è½½æ‰§è¡Œè®°å½•å¤±è´¥:', data.error);
                        document.getElementById('schedulerLogs').textContent = 'åŠ è½½å¤±è´¥';
                    } else {
                        renderSchedulerExecutionLog(data.executions || []);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ‰§è¡Œè®°å½•å¤±è´¥:', error);
                    document.getElementById('schedulerLogs').textContent = 'åŠ è½½å¤±è´¥';
                });
        }
        
        // æ¸²æŸ“æ‰§è¡Œè®°å½•
        function renderSchedulerExecutionLog(executions) {
            const container = document.getElementById('schedulerLogs');
            if (executions.length === 0) {
                container.innerHTML = 'æš‚æ— æ‰§è¡Œè®°å½•';
                return;
            }
            
            // å»é‡ï¼šåªä¿ç•™æ¯ä¸ªæ—¶é—´ç‚¹çš„ç¬¬ä¸€æ¡è®°å½?            const uniqueExecutions = [];
            const seenTimes = new Set();
            
            for (const exec of executions) {
                const key = `${exec.date}_${exec.time}`;
                if (!seenTimes.has(key)) {
                    seenTimes.add(key);
                    uniqueExecutions.push(exec);
                }
            }
            
            container.innerHTML = uniqueExecutions.map(exec => `
                <div style="padding: 8px 0; border-bottom: 1px solid #eee; font-size: 12px;">
                    <div style="color: #666; margin-bottom: 4px;">
                        <span style="color: #27ae60; font-weight: 500;">${exec.date}</span>
                        <span style="color: #999; margin: 0 8px;">${exec.time}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // åŠ è½½æ•°æ®æ›´æ–°é…ç½®
        function loadDataUpdateConfig() {
            fetch('/api/data/settings')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('åŠ è½½æ•°æ®æ›´æ–°é…ç½®å¤±è´¥:', data.error);
                    } else {
                        document.getElementById('dataUpdateInterval').value = data.update_interval || 10;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ•°æ®æ›´æ–°é…ç½®å¤±è´¥:', error);
                });
        }
        
        // ä¿å­˜æ•°æ®æ›´æ–°é…ç½®
        function saveDataUpdateConfig() {
            const interval = parseInt(document.getElementById('dataUpdateInterval').value);
            
            console.log('ä¿å­˜æ•°æ®æ›´æ–°é…ç½®ï¼Œé—´éš?', interval, 'åˆ†é’Ÿ');
            
            fetch('/api/data/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    update_interval: interval
                })
            })
            .then(response => {
                console.log('å“åº”çŠ¶æ€?', response.status);
                if (!response.ok) {
                    throw new Error('HTTP error, status = ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('å“åº”æ•°æ®:', data);
                if (data.error) {
                    alert('ä¿å­˜å¤±è´¥: ' + data.error);
                } else {
                    alert('æ•°æ®æ›´æ–°é…ç½®å·²ä¿å­?);
                    loadDataUpdateLogs();
                }
            })
            .catch(error => {
                console.error('ä¿å­˜æ•°æ®æ›´æ–°é…ç½®å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            });
        }
        
        // åŠ è½½æ•°æ®æ›´æ–°æ—¥å¿—
        function loadDataUpdateLogs() {
            fetch('/api/dataupdatelog')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('åŠ è½½æ•°æ®æ›´æ–°æ—¥å¿—å¤±è´¥:', data.error);
                    } else {
                        renderDataUpdateLogs(data.logs || []);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ•°æ®æ›´æ–°æ—¥å¿—å¤±è´¥:', error);
                });
        }
        
        // æ¸²æŸ“æ•°æ®æ›´æ–°æ—¥å¿—
        function renderDataUpdateLogs(logs) {
            const container = document.getElementById('dataUpdateLogs');
            if (logs.length === 0) {
                container.innerHTML = 'æš‚æ— æ›´æ–°è®°å½•';
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            const sortedLogs = [...logs].reverse();
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—?            if (sortedLogs.length > 0) {
                const lastLog = sortedLogs[0];
                document.getElementById('lastDataUpdateTime').textContent = lastLog.timestamp;
            }
            
            container.innerHTML = sortedLogs.map(log => `
                <div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                    <div style="color: ${log.success ? '#27ae60' : '#e74c3c'}; font-weight: 500;">
                        ${log.timestamp} - ${log.module}
                    </div>
                    ${log.error ? `<div style="color: #e74c3c; font-size: 10px;">é”™è¯¯: ${log.error}</div>` : ''}
                </div>
            `).join('');
        }
        
        // é‚®ä»¶é…ç½®ç›¸å…³å‡½æ•°
        function toggleEmailConfig() {
            const enabled = document.getElementById('emailEnabled').value === 'true';
            const configArea = document.getElementById('emailConfigArea');
            configArea.style.display = enabled ? 'block' : 'none';
        }
        
        function toggleAuthCodeVisibility() {
            const authCodeInput = document.getElementById('senderAuthCode');
            const button = event.target;
            if (authCodeInput.type === 'password') {
                authCodeInput.type = 'text';
                button.textContent = 'éšè—';
            } else {
                authCodeInput.type = 'password';
                button.textContent = 'æ˜¾ç¤º';
            }
        }
        
        function loadEmailConfig() {
            fetch('/api/email/config')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('åŠ è½½é‚®ä»¶é…ç½®å¤±è´¥:', data.error);
                    } else {
                        const config = data;
                        document.getElementById('emailEnabled').value = config.enabled ? 'true' : 'false';
                        document.getElementById('senderEmail').value = config.sender_email || '';
                        document.getElementById('senderAuthCode').value = config.sender_auth_code || '';
                        document.getElementById('emailTemplate').value = config.email_body_template || 'simple';
                        toggleEmailConfig();
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½é‚®ä»¶é…ç½®å¤±è´¥:', error);
                });
        }
        
        function saveEmailConfig() {
            const config = {
                enabled: document.getElementById('emailEnabled').value === 'true',
                sender_email: document.getElementById('senderEmail').value,
                sender_auth_code: document.getElementById('senderAuthCode').value,
                email_body_template: document.getElementById('emailTemplate').value
            };
            
            fetch('/api/email/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`ä¿å­˜å¤±è´¥: ${data.error}`);
                } else {
                    alert('é‚®ä»¶é…ç½®å·²ä¿å­?);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜é‚®ä»¶é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
            });
        }
        
        function renderRecipients(recipients) {
            const container = document.getElementById('recipientsList');
            if (recipients.length === 0) {
                container.innerHTML = '<div style="font-size: 12px; color: #999;">æš‚æ— æ¥æ”¶äº?/div>';
                return;
            }
            
            container.innerHTML = recipients.map(recipient => `
                <div style="display: flex; gap: 5px; margin-bottom: 5px; align-items: center;">
                    <input type="checkbox" id="recipient_active_${recipient.id}" ${recipient.is_active ? 'checked' : ''} 
                           onchange="toggleRecipientActive(${recipient.id})" style="margin: 0;">
                    <input type="email" class="form-control" value="${recipient.email_address}" readonly 
                           style="flex: 2; background: ${recipient.is_active ? '#fff' : '#e9ecef'}; 
                                  ${!recipient.is_active ? 'color: #999;' : ''}">
                    <input type="text" class="form-control" value="${recipient.name || ''}" placeholder="å§“å" 
                           style="flex: 1; background: ${recipient.is_active ? '#fff' : '#e9ecef'};
                                  ${!recipient.is_active ? 'color: #999;' : ''}"
                           onchange="updateRecipientName(${recipient.id}, this.value)">
                    <button class="btn btn-secondary" onclick="editRecipient(${recipient.id})" 
                            style="padding: 5px 10px; font-size: 11px;">ç¼–è¾‘</button>
                    <button class="btn btn-danger" onclick="deleteRecipient(${recipient.id})" 
                            style="padding: 5px 10px; font-size: 11px;">åˆ é™¤</button>
                </div>
            `).join('');
        }
        
        function loadRecipients() {
            fetch('/api/email/recipients')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderRecipients(data.data);
                    } else {
                        console.error('åŠ è½½æ¥æ”¶é‚®ç®±å¤±è´¥:', data.error);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ¥æ”¶é‚®ç®±å¤±è´¥:', error);
                });
        }

        function getRecipients() {
            const recipientElements = document.querySelectorAll('#recipientsList input[type="email"]');
            const recipients = [];
            recipientElements.forEach(element => {
                const checkbox = element.parentElement.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    recipients.push(element.value);
                }
            });
            return recipients;
        }

        function addRecipient() {
            const emailInput = document.getElementById('newRecipient');
            const nameInput = document.getElementById('newRecipientName');
            const email = emailInput.value.trim();
            const name = nameInput.value.trim();
            
            if (!email) {
                alert('è¯·è¾“å…¥é‚®ç®±åœ°å€');
                return;
            }
            
            if (!validateEmail(email)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }
            
            fetch('/api/email/recipients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email_address: email,
                    name: name || null,
                    description: null,
                    is_active: true
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        emailInput.value = '';
                        nameInput.value = '';
                        loadRecipients();
                    } else {
                        alert(`æ·»åŠ å¤±è´¥: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('æ·»åŠ æ¥æ”¶é‚®ç®±å¤±è´¥:', error);
                    alert('æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                });
        }
        
        function deleteRecipient(recipientId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¥æ”¶é‚®ç®±å—ï¼Ÿ')) {
                return;
            }
            
            fetch(`/api/email/recipients/${recipientId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadRecipients();
                    } else {
                        alert(`åˆ é™¤å¤±è´¥: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤æ¥æ”¶é‚®ç®±å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                });
        }
        
        function toggleRecipientActive(recipientId) {
            const checkbox = document.getElementById(`recipient_active_${recipientId}`);
            const isActive = checkbox.checked;
            
            fetch(`/api/email/recipients/${recipientId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    is_active: isActive
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadRecipients();
                    } else {
                        alert(`æ›´æ–°å¤±è´¥: ${data.error}`);
                        checkbox.checked = !isActive;
                    }
                })
                .catch(error => {
                    console.error('æ›´æ–°æ¥æ”¶é‚®ç®±å¤±è´¥:', error);
                    alert('æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                    checkbox.checked = !isActive;
                });
        }
        
        function updateRecipientName(recipientId, name) {
            fetch(`/api/email/recipients/${recipientId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name || null
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert(`æ›´æ–°å¤±è´¥: ${data.error}`);
                        loadRecipients();
                    }
                })
                .catch(error => {
                    console.error('æ›´æ–°æ¥æ”¶é‚®ç®±å¤±è´¥:', error);
                    alert('æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                    loadRecipients();
                });
        }
        
        function editRecipient(recipientId) {
            const email = prompt('è¯·è¾“å…¥æ–°çš„é‚®ç®±åœ°å€:');
            if (!email) {
                return;
            }
            
            if (!validateEmail(email)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }
            
            fetch(`/api/email/recipients/${recipientId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email_address: email
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadRecipients();
                    } else {
                        alert(`æ›´æ–°å¤±è´¥: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('æ›´æ–°æ¥æ”¶é‚®ç®±å¤±è´¥:', error);
                    alert('æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                });
        }
        
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }
        
        function hideImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importFile').value = '';
        }
        
        function importRecipients() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/email/recipients/import', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        hideImportModal();
                        loadRecipients();
                    } else {
                        alert(`å¯¼å…¥å¤±è´¥: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('å¯¼å…¥æ¥æ”¶é‚®ç®±å¤±è´¥:', error);
                    alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                });
        }
        
        function exportRecipients() {
            window.location.href = '/api/email/recipients/export';
        }
        
        function showClearRecipientsModal() {
            document.getElementById('clearRecipientsModal').style.display = 'block';
        }
        
        function hideClearRecipientsModal() {
            document.getElementById('clearRecipientsModal').style.display = 'none';
        }
        
        function clearRecipients() {
            fetch('/api/email/recipients', {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æ¸…ç©ºæˆåŠŸ');
                        hideClearRecipientsModal();
                        loadRecipients();
                    } else {
                        alert(`æ¸…ç©ºå¤±è´¥: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('æ¸…ç©ºæ¥æ”¶é‚®ç®±å¤±è´¥:', error);
                    alert('æ¸…ç©ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
                });
        }
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function sendTestEmail() {
            const config = {
                enabled: document.getElementById('emailEnabled').value === 'true',
                sender_email: document.getElementById('senderEmail').value,
                sender_auth_code: document.getElementById('senderAuthCode').value,
                recipients: getRecipients(),
                email_body_template: document.getElementById('emailTemplate').value
            };
            
            if (!config.sender_email) {
                alert('è¯·è¾“å…¥å‘é€é‚®ç®±åœ°å€');
                return;
            }
            
            if (!config.sender_auth_code) {
                alert('è¯·è¾“å…¥é‚®ç®±æˆæƒç ');
                return;
            }
            
            if (config.recipients.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ¥æ”¶é‚®ç®±åœ°å€');
                return;
            }
            
            fetch('/api/email/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`å‘é€æµ‹è¯•é‚®ä»¶å¤±è´? ${data.error}`);
                } else {
                    alert('æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸï¼Œè¯·æ£€æŸ¥é‚®ç®?);
                }
            })
            .catch(error => {
                console.error('å‘é€æµ‹è¯•é‚®ä»¶å¤±è´?', error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡é…ç½®
        document.addEventListener('DOMContentLoaded', function() {
            loadSchedulerConfig();
            loadSchedulerExecutionLog();
            loadDataUpdateConfig();
            loadDataUpdateLogs();
            loadEmailConfig();
            loadRecipients();
        });
    </script>
    
    <!-- å¯¼å…¥æ¥æ”¶é‚®ç®±æ¨¡æ€æ¡† -->
    <div id="importModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 400px; max-width: 90%;">
            <h3 style="margin-bottom: 15px;">å¯¼å…¥æ¥æ”¶é‚®ç®±</h3>
            <p style="margin-bottom: 15px; font-size: 12px; color: #666;">æ”¯æŒCSVå’ŒExcelæ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­éœ€åŒ…å«email_addressåˆ—ï¼ˆå¿…å¡«ï¼‰ï¼Œå¯é€‰åŒ…å«nameå’Œdescriptionåˆ—ã€?/p>
            <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="width: 100%; margin-bottom: 15px;">
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideImportModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="importRecipients()">å¯¼å…¥</button>
            </div>
        </div>
    </div>
    
    <!-- æ¸…ç©ºæ¥æ”¶é‚®ç®±ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="clearRecipientsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 400px; max-width: 90%;">
            <h3 style="margin-bottom: 15px;">ç¡®è®¤æ¸…ç©º</h3>
            <p style="margin-bottom: 15px; color: #e74c3c;">ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¥æ”¶é‚®ç®±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼?/p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideClearRecipientsModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="clearRecipients()">ç¡®è®¤æ¸…ç©º</button>
            </div>
        </div>
    </div>
</body>
</html>
